<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Connexion RIDLY / RSL</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#22c55e;
      --green-dark:#16a34a;
      --border:rgba(255,255,255,.15);
      --dim:#9aa5b1;
      --bg:#020617;
    }
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }
    html,body{height:100%}
    body{
      background:#000;
      color:#fff;
      font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex;
      flex-direction:column;
    }

    /* BG */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#064e3b 0,#020617 40%,#000 100%);
      opacity:.9;
      z-index:-1;
    }

    /* HEADER */
    header{
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding:12px 18px;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:#fff;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:12px;
      background:#000;
      padding:3px;
      box-shadow:0 0 12px rgba(34,197,94,.7);
    }
    .brand span{
      font-weight:800;
      font-size:17px;
      letter-spacing:.08em;
    }

    /* MAIN */
    main{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:30px 16px 70px;
    }
    .shell{
      width:100%;
      max-width:460px;
    }
    .title{
      font-size:24px;
      font-weight:800;
      margin-bottom:4px;
    }
    .subtitle{
      font-size:13px;
      color:var(--dim);
      margin-bottom:14px;
    }

    .card{
      background:rgba(0,0,0,.8);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 30px 70px rgba(0,0,0,.85);
      padding:16px 16px 18px;
    }

    /* TABS */
    .tabs{
      display:inline-flex;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:#020617;
      padding:2px;
      margin-bottom:14px;
    }
    .tab-btn{
      border:0;
      background:transparent;
      color:#9ca3af;
      font-size:12px;
      font-weight:700;
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
    }
    .tab-btn.active{
      background:#020617;
      color:#fff;
      box-shadow:0 0 0 1px rgba(255,255,255,.12);
    }

    /* FORM */
    .field{margin-bottom:10px;}
    label{
      display:block;
      font-size:12px;
      font-weight:700;
      color:#e5e7eb;
      margin-bottom:4px;
    }
    .input{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:#020617;
      color:#fff;
      padding:9px 12px;
      font-size:14px;
      font-family:inherit;
    }
    .input:focus{
      outline:none;
      border-color:var(--green);
    }
    .hint{
      font-size:11px;
      color:var(--dim);
      margin-top:2px;
    }

    .btn-primary{
      width:100%;
      border-radius:10px;
      border:0;
      background:linear-gradient(135deg,var(--green),var(--green-dark));
      color:#062312;
      font-size:14px;
      font-weight:800;
      padding:10px 14px;
      margin-top:8px;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(0,0,0,.75);
    }
    .btn-primary:disabled{
      opacity:.6;
      cursor:default;
    }

    .divider{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin:10px 0;
      font-size:11px;
      color:var(--dim);
    }
    .divider::before,
    .divider::after{
      content:"";
      flex:1;
      height:1px;
      background:rgba(148,163,184,.4);
    }

    .btn-google{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.6);
      background:#020617;
      color:#e5e7eb;
      font-size:14px;
      font-weight:600;
      padding:9px 14px;
      margin-top:2px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-google:disabled{
      opacity:.6;
      cursor:default;
    }

    .msg{
      font-size:12px;
      margin-top:8px;
      min-height:16px;
    }

    /* PSEUDO STEP */
    #stepPseudo{display:none;}
    .pseudo-title{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .pseudo-text{
      font-size:13px;
      color:var(--dim);
      margin-bottom:12px;
    }
    .pseudo-preview{
      font-size:13px;
      color:#bbf7d0;
      margin-top:4px;
    }

    footer{
      text-align:center;
      font-size:11px;
      color:var(--dim);
      padding:0 10px 10px;
    }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="brand">
    <img src="image/1logo_ridly.png" alt="RIDLY"/>
    <span>RIDLY</span>
  </a>
</header>

<main>
  <div class="shell">
    <div class="title">Connexion RIDLY</div>
    <div class="subtitle">
      Je suis d√©j√† membre <b>RIDLY</b> ou <b>RSL</b><br/>
      ‚Äî utilise ton email habituel, ou connecte-toi avec Google.
    </div>

    <!-- √âtape 1 : auth -->
    <section id="stepAuth" class="card">
      <div class="tabs">
        <button id="tabMember" class="tab-btn active" type="button">Je suis membre</button>
        <button id="tabNew" class="tab-btn" type="button">Cr√©er un compte</button>
      </div>

      <form id="authForm">
        <div id="fieldFullname" class="field" style="display:none">
          <label for="fullName">Nom et pr√©nom</label>
          <input id="fullName" class="input" type="text" placeholder="Pr√©nom Nom">
        </div>

        <div class="field">
          <label for="email">Email</label>
          <input id="email" class="input" type="email" placeholder="ton.email@exemple.ch" required>
        </div>

        <div class="field">
          <label for="password">Mot de passe</label>
          <input id="password" class="input" type="password" placeholder="Mot de passe" required>
          <div class="hint">
            M√™me mot de passe que sur la zone membre RSL (ou cr√©e-en un nouveau).
          </div>
        </div>

        <button type="submit" class="btn-primary" id="btnSubmitAuth">
          Continuer
        </button>

        <div class="divider"><span>ou</span></div>

        <button type="button" class="btn-google" id="btnGoogle">
          <span>üîê</span> Continuer avec Google
        </button>

        <div class="msg" id="authMsg"></div>
      </form>
    </section>

    <!-- √âtape 2 : pseudo -->
    <section id="stepPseudo" class="card">
      <div class="pseudo-title">Choisis ton pseudo RIDLY</div>
      <p class="pseudo-text">
        C‚Äôest ce nom qui appara√Ætra dans le feed, les commentaires, le Game of Scoot, etc.
      </p>

      <div class="field">
        <label for="pseudo">Pseudo (3‚Äì20 caract√®res)</label>
        <input id="pseudo" class="input" type="text" placeholder="@monpseudo">
        <div class="hint">
          Lettres, chiffres, _ et . autoris√©s. Un pseudo = unique.
        </div>
        <div class="pseudo-preview" id="pseudoPreview"></div>
      </div>

      <button type="button" class="btn-primary" id="btnSavePseudo">
        Valider mon pseudo
      </button>
      <div class="msg" id="pseudoMsg"></div>
    </section>
  </div>
</main>

<footer>
  RIDLY utilise ton compte Supabase (email/mot de passe ou Google).  
  Un seul compte te donne acc√®s √† toute l‚Äôapp.
</footer>

<script>
  /* ===== Supabase init ===== */
  const supa = supabase.createClient(
    window.env?.SUPABASE_URL  || "https://jynxifufaauoxwzjapzq.supabase.co",
    window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4"
  );

  /* ===== DOM refs ===== */
  const tabMember      = document.getElementById('tabMember');
  const tabNew         = document.getElementById('tabNew');
  const fieldFullname  = document.getElementById('fieldFullname');
  const authForm       = document.getElementById('authForm');
  const authMsg        = document.getElementById('authMsg');
  const btnSubmitAuth  = document.getElementById('btnSubmitAuth');
  const btnGoogle      = document.getElementById('btnGoogle');

  const stepAuth       = document.getElementById('stepAuth');
  const stepPseudo     = document.getElementById('stepPseudo');

  const inputFull      = document.getElementById('fullName');
  const inputEmail     = document.getElementById('email');
  const inputPass      = document.getElementById('password');

  const pseudoInput    = document.getElementById('pseudo');
  const pseudoMsg      = document.getElementById('pseudoMsg');
  const pseudoPrev     = document.getElementById('pseudoPreview');
  const btnSavePseudo  = document.getElementById('btnSavePseudo');

  let mode = "member"; // "member" ou "new"

  function setMode(newMode){
    mode = newMode;
    tabMember.classList.toggle('active', mode === "member");
    tabNew.classList.toggle('active', mode === "new");
    fieldFullname.style.display = (mode === "new") ? "block" : "none";
  }

  tabMember.addEventListener('click', ()=>setMode("member"));
  tabNew.addEventListener('click', ()=>setMode("new"));

  /* ===== Au chargement : d√©j√† connect√© ? ===== */
  (async()=>{
    try{
      const { data:{ user } } = await supa.auth.getUser();
      if(user){
        await checkProfileAndRedirect(user);
      }
    }catch(e){
      console.warn('bootstrap auth error', e);
    }
  })();

  /* ===== Helpers profil ===== */
  async function ensureProfileRow(user, fullNameHint){
    try{
      const { data: prof } = await supa
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .maybeSingle();

      if(!prof){
        await supa.from('profiles').insert([{
          id: user.id,
          full_name: fullNameHint || user.user_metadata?.full_name || user.user_metadata?.name || null,
          email: user.email || null
        }]);
      }
    }catch(e){
      console.warn('ensureProfileRow error', e);
    }
  }

  async function checkProfileAndRedirect(user){
    await ensureProfileRow(user, user.user_metadata?.full_name || user.user_metadata?.name || null);

    const { data: prof } = await supa
      .from('profiles')
      .select('username')
      .eq('id', user.id)
      .maybeSingle();

    if(prof && prof.username){
      // pseudo d√©j√† d√©fini -> on rentre dans l‚Äôapp
      window.location.href = "ou_rider.html";
      return;
    }

    // pas encore de pseudo -> √©tape 2
    stepAuth.style.display  = "none";
    stepPseudo.style.display = "block";
  }

  /* ===== Auth email / mot de passe ===== */
  authForm.addEventListener('submit', async (e)=>{
    e.preventDefault();

    authMsg.style.color = "#9aa5b1";
    authMsg.textContent = "Connexion en cours...";
    btnSubmitAuth.disabled = true;
    btnGoogle.disabled = true;

    const email    = (inputEmail.value || "").trim();
    const password = inputPass.value;
    const fullName = (inputFull.value || "").trim() || null;

    try{
      let user = null;

      if(mode === "member"){
        const { data, error } = await supa.auth.signInWithPassword({ email, password });
        if(error) throw error;
        user = data.user;
      }else{
        const { data, error } = await supa.auth.signUp({
          email,
          password,
          options:{ data:{ full_name: fullName } }
        });
        if(error) throw error;
        user = data.user;
      }

      if(!user) throw new Error("Connexion impossible.");

      authMsg.style.color = "#22c55e";
      authMsg.textContent = "Connexion OK, pr√©paration de ton profil...";
      await checkProfileAndRedirect(user);
    }catch(err){
      console.error(err);
      authMsg.style.color = "#f97373";
      authMsg.textContent = "Erreur : " + (err.message || "connexion impossible");
    }finally{
      btnSubmitAuth.disabled = false;
      btnGoogle.disabled = false;
    }
  });

  /* ===== Auth Google ===== */
  btnGoogle.addEventListener('click', async ()=>{
    authMsg.style.color = "#9aa5b1";
    authMsg.textContent = "Redirection vers Google...";
    btnGoogle.disabled = true;
    btnSubmitAuth.disabled = true;

    try{
      const { error } = await supa.auth.signInWithOAuth({
        provider: 'google',
        options:{
          // apr√®s le flow Google+Supabase, on revient sur la page de login RIDLY
          redirectTo: window.location.origin + '/index.html'
        }
      });
      if(error) throw error;
      // ensuite, au retour, bootstrap() + checkProfileAndRedirect() feront le reste
    }catch(err){
      console.error(err);
      authMsg.style.color = "#f97373";
      authMsg.textContent = "Erreur Google : " + (err.message || "connexion impossible");
      btnGoogle.disabled = false;
      btnSubmitAuth.disabled = false;
    }
  });

  /* ===== √âtape pseudo ===== */
  function normalizePseudo(str){
    return (str || "")
      .replace(/^@+/,"")
      .replace(/[^a-zA-Z0-9_.]/g,"")
      .toLowerCase();
  }

  pseudoInput.addEventListener('input', ()=>{
    const raw   = pseudoInput.value.trim();
    const clean = normalizePseudo(raw);
    if(raw !== clean) pseudoInput.value = clean;
    pseudoPrev.textContent = clean
      ? "Ton pseudo appara√Ætra comme : @" + clean
      : "";
  });

  btnSavePseudo.addEventListener('click', async ()=>{
    const val = normalizePseudo(pseudoInput.value.trim());

    if(!val || val.length < 3){
      pseudoMsg.style.color = "#f97373";
      pseudoMsg.textContent = "Le pseudo doit faire au moins 3 caract√®res.";
      return;
    }
    if(val.length > 20){
      pseudoMsg.style.color = "#f97373";
      pseudoMsg.textContent = "Le pseudo doit faire au maximum 20 caract√®res.";
      return;
    }

    pseudoMsg.style.color = "#9aa5b1";
    pseudoMsg.textContent = "V√©rification du pseudo...";
    btnSavePseudo.disabled = true;

    try{
      const { data:{ user } } = await supa.auth.getUser();
      if(!user) throw new Error("Tu n'es plus connect√©.");

      await ensureProfileRow(user);

      const { data: exists } = await supa
        .from('profiles')
        .select('id')
        .eq('username', val)
        .maybeSingle();

      if(exists && exists.id !== user.id){
        pseudoMsg.style.color = "#f97373";
        pseudoMsg.textContent = "Ce pseudo est d√©j√† pris. Essaie-en un autre.";
        btnSavePseudo.disabled = false;
        return;
      }

      const { error } = await supa
        .from('profiles')
        .update({ username: val })
        .eq('id', user.id);

      if(error) throw error;

      pseudoMsg.style.color = "#22c55e";
      pseudoMsg.textContent = "Bienvenue sur RIDLY !";
      setTimeout(()=>{ window.location.href = "ou_rider.html"; }, 700);
    }catch(err){
      console.error(err);
      pseudoMsg.style.color = "#f97373";
      pseudoMsg.textContent = "Erreur : " + (err.message || "impossible d'enregistrer le pseudo");
      btnSavePseudo.disabled = false;
    }
  });
</script>

</body>
</html>
