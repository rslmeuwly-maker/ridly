<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nouveau mot de passe ‚Äî RIDLY</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --green:#22c55e;
      --green-dark:#16a34a;
      --bg:#000;
      --text:#f9fafb;
      --dim:#9aa5b1;
      --accent:#38bdf8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      background:radial-gradient(circle at top left,#022c22 0,#020617 40%,#000 100%);
      color:var(--text);
      font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      background:rgba(0,0,0,.7);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff;}
    .brand img{width:40px;height:40px;border-radius:12px;box-shadow:0 0 14px rgba(34,197,94,.5);}
    .back-link{font-size:12px;color:var(--dim);text-decoration:none;}
    .back-link:hover{color:#fff;}

    main{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;}

    .card{
      width:100%;max-width:420px;padding:20px;
      background:radial-gradient(circle at top,#020617,#020617 55%,#000);
      border-radius:22px;border:1px solid rgba(148,163,184,.4);
      box-shadow:0 0 45px rgba(15,23,42,.9),0 0 60px rgba(34,197,94,.25);
      position:relative;overflow:hidden;
    }

    label{display:block;font-size:.8rem;margin-top:8px;color:var(--dim);}
    input{
      width:100%;margin-top:4px;padding:9px 11px;border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:#020617;color:var(--text);outline:none;font-size:.9rem;
    }
    input:focus{
      border-color:var(--green);
      box-shadow:0 0 0 1px rgba(34,197,94,.4);
    }

    button{
      width:100%;margin-top:14px;padding:10px;border-radius:999px;
      border:none;cursor:pointer;font-size:.78rem;font-weight:800;
      letter-spacing:.08em;text-transform:uppercase;
      background:linear-gradient(135deg,var(--green),var(--green-dark));
      color:#01210f;
    }
    button:disabled{opacity:.5;cursor:default;}

    .status{margin-top:8px;min-height:18px;font-size:.78rem;color:var(--dim);}
    .status.ok{color:#4ade80;}
    .status.err{color:#f97373;}
  </style>
</head>

<body>

<header>
  <a href="index.html" class="brand">
    <img src="image/1logo_ridly.png" alt="RIDLY"><span>RIDLY</span>
  </a>
  <a href="connexion.html" class="back-link">‚Üê Retour connexion</a>
</header>

<main>
  <div class="card">
    <h2 style="font-size:1.2rem;font-weight:800;margin-bottom:6px;">Choisis un nouveau mot de passe</h2>
    <p style="font-size:.8rem;color:#9aa5b1;margin-bottom:12px;">
      Cette page doit √™tre ouverte depuis le lien re√ßu par e-mail.
    </p>

    <label for="password-new">Nouveau mot de passe</label>
    <input id="password-new" type="password" placeholder="Min. 6 caract√®res" autocomplete="new-password"/>

    <label for="password-confirm">Confirmer le mot de passe</label>
    <input id="password-confirm" type="password" placeholder="R√©p√®te le mot de passe" autocomplete="new-password"/>

    <button id="btn-reset" type="button">Mettre √† jour le mot de passe</button>

    <div id="status-reset" class="status"></div>
  </div>
</main>

<footer style="text-align:center;color:#9aa5b1;font-size:12px;padding:12px;">
  ¬© RIDLY
</footer>

<script>
  const supabaseUrl = "https://jynxifufaauoxwzjapzq.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";

  const sb = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

  const passwordNew = document.getElementById("password-new");
  const passwordConfirm = document.getElementById("password-confirm");
  const btnReset = document.getElementById("btn-reset");
  const statusReset = document.getElementById("status-reset");

  function resetStatus(){
    statusReset.className = "status";
  }

  // üîç On v√©rifie que le lien contient bien le type=recovery
  function getAuthTypeFromUrl(){
    // Supabase met les infos dans le hash (#...) en g√©n√©ral
    const hash = window.location.hash.startsWith("#")
      ? window.location.hash.substring(1)
      : window.location.hash;
    const paramsHash = new URLSearchParams(hash);
    const typeHash = paramsHash.get("type");

    // Au cas o√π ce serait dans l'URL classique ?type=recovery&...
    const paramsSearch = new URLSearchParams(window.location.search);
    const typeSearch = paramsSearch.get("type");

    return typeHash || typeSearch;
  }

  const authType = getAuthTypeFromUrl();

  if (authType !== "recovery") {
    // Pas ouvert depuis le bon lien ‚Üí on bloque
    resetStatus();
    statusReset.textContent = "Lien invalide ou expir√©. Ouvre cette page depuis l‚Äôe-mail ¬´ r√©initialiser le mot de passe ¬ª.";
    statusReset.classList.add("err");
    btnReset.disabled = true;
  } else {
    resetStatus();
    statusReset.textContent = "OK, choisis ton nouveau mot de passe.";
  }

  btnReset.addEventListener("click", async () => {
    resetStatus();

    if (btnReset.disabled) return;

    const pass = passwordNew.value;
    const confirm = passwordConfirm.value;

    if (!pass || !confirm) {
      statusReset.textContent = "Remplis les deux champs.";
      statusReset.classList.add("err");
      return;
    }
    if (pass.length < 6){
      statusReset.textContent = "Le mot de passe doit faire au moins 6 caract√®res.";
      statusReset.classList.add("err");
      return;
    }
    if (pass !== confirm){
      statusReset.textContent = "Les mots de passe ne correspondent pas.";
      statusReset.classList.add("err");
      return;
    }

    btnReset.disabled = true;
    statusReset.textContent = "Mise √† jour en cours‚Ä¶";

    try{
      const { data, error } = await sb.auth.updateUser({ password: pass });

      if (error){
        console.error("updateUser error:", error);
        statusReset.textContent = "Erreur : " + (error.message || "Impossible de mettre √† jour le mot de passe.");
        statusReset.classList.add("err");
        btnReset.disabled = false;
      } else {
        statusReset.textContent = "Mot de passe mis √† jour ! Tu peux maintenant te reconnecter.";
        statusReset.classList.add("ok");
        setTimeout(() => {
          window.location.href = "connexion.html";
        }, 1500);
      }
    } catch(err){
      console.error("updateUser exception:", err);
      statusReset.textContent = "Erreur inattendue (voir console).";
      statusReset.classList.add("err");
      btnReset.disabled = false;
    }
  });
</script>

</body>
</html>
