<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <title>Chat Riders ‚Äî RIDLY</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#030712;
      --card:#020617;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.08);
      --accent-strong:rgba(34,197,94,.25);
      --text:#f9fafb;
      --text-dim:#9ca3af;
      --border:rgba(148,163,184,.35);
      --radius-xl:18px;
    }

    body.theme-dark{
      --bg:#020617;
      --bg-soft:#030712;
      --card:#020617;
      --text:#f9fafb;
      --text-dim:#9ca3af;
      --border:rgba(148,163,184,.35);
    }
    body.theme-light{
      --bg:#f4f4f5;
      --bg-soft:#e5e7eb;
      --card:#ffffff;
      --text:#020617;
      --text-dim:#6b7280;
      --border:rgba(148,163,184,.25);
    }

    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
    }
    body{
      font-family:"Outfit",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#000;
      color:var(--text);
      display:flex;
      flex-direction:column;
    }

    /* ===== BG VID√âO ===== */
    .rsl-bg-wrap{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
    }
    .rsl-bg-video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
      filter:brightness(.48) saturate(1.05);
    }
    .rsl-bg-dim{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.7));
    }
    body.theme-light .rsl-bg-dim{
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
    }

    .page-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:640px;
      margin:0 auto;
      width:100%;
      position:relative;
      z-index:1;
    }

    /* ===== TOP NAV ===== */
    nav.nav{
      position:sticky;
      top:0;
      z-index:20;
      background:rgba(2,6,23,.9);
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
    }
    body.theme-light nav.nav{
      background:rgba(244,244,245,.95);
    }
    nav.nav .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 14px;
    }

    .nav-left{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      color:var(--text);
    }
    .brand img{
      width:32px;
      height:32px;
      border-radius:12px;
      background:#000;
      padding:3px;
      box-shadow:0 0 12px rgba(34,197,94,.7);
    }
    .brand span{
      font-weight:700;
      letter-spacing:-0.03em;
      font-size:20px;
    }

    .add-btn{
      border:none;
      outline:none;
      width:30px;
      height:30px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
      background:radial-gradient(circle at 30% 20%,#4ade80 0,#22c55e 35%,#16a34a 100%);
      color:#022c16;
      box-shadow:0 10px 22px rgba(34,197,94,.7);
    }
    .add-btn span{
      transform:translateY(-1px);
    }

    .nav-tools{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }
    .icon-btn{
      border:1px solid rgba(15,23,42,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      text-decoration:none;
      position:relative;
      cursor:pointer;
    }
    body.theme-light .icon-btn{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.6);
    }
    .icon-btn:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    .nav-msg-ic{
      width:18px;
      height:18px;
      display:block;
      filter:drop-shadow(0 0 4px rgba(0,0,0,.6));
    }

    .nav-badge{
      position:absolute;
      top:2px;
      right:2px;
      min-width:14px;
      height:14px;
      padding:0 3px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-size:9px;
      display:none;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(15,23,42,.9);
    }
    .nav-badge.show{
      display:flex;
    }

    /* ===== MAIN ===== */
    .main{
      flex:1;
      padding:4px 10px 80px;
    }

    .mini-title{
      padding:8px 4px 4px;
      font-size:13px;
      font-weight:600;
      color:var(--text-dim);
    }

    /* ===== CARD / CHAT ===== */
    .card{
      background:var(--card);
      border-radius:var(--radius-xl);
      border:1px solid rgba(15,23,42,.9);
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      padding:12px 12px 14px;
      margin-top:4px;
    }
    body.theme-light .card{
      border-color:rgba(209,213,219,.9);
      box-shadow:0 14px 30px rgba(15,23,42,.15);
    }

    h1.main-title{
      margin:0 0 4px;
      font-size:18px;
      font-weight:800;
    }
    .muted{
      font-size:13px;
      color:var(--text-dim);
      margin:0 0 8px;
    }

    .chat-box{
      display:flex;
      flex-direction:column;
      gap:8px;
      height:60vh;
      max-height:520px;
    }

    .chat-messages{
      flex:1;
      min-height:200px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      padding:8px;
      overflow-y:auto;
      font-size:13px;
      display:flex;
      flex-direction:column;
    }
    body.theme-light .chat-messages{
      background:#f9fafb;
    }

    /* ===== LIGNE MESSAGE ===== */
    .msg-row{
      display:flex;
      gap:8px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .msg-row.me{
      flex-direction:row-reverse;
    }

    .msg-avatar{
      width:32px;
      height:32px;
      border-radius:999px;
      overflow:hidden;
      background:#0f172a;
      flex-shrink:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:700;
      color:#e5e7eb;
    }
    .msg-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    body.theme-light .msg-avatar{
      background:#e5e7eb;
      color:#111827;
    }

    .msg{
      padding:6px 8px;
      border-radius:10px;
      margin-bottom:0;
      flex:1;
      background:rgba(15,23,42,1);
      color:var(--text);
    }
    body.theme-light .msg{
      background:#e5e7eb;
      color:#111827;
    }

    /* moi = vert d√©grad√© style WhatsApp */
    .msg-row.me .msg{
      background:linear-gradient(135deg,#34d399,#67e8f9);
      color:#022c16;
    }
    body.theme-light .msg-row.me .msg{
      background:linear-gradient(135deg,#6ee7b7,#a5f3fc);
      color:#022c16;
    }

    /* message qui mentionne mon pseudo => bleu chez moi */
    .msg-row.mention-me:not(.me) .msg{
      border:1px solid #3b82f6;
      box-shadow:0 0 0 1px rgba(59,130,246,.5);
      background:rgba(59,130,246,.20);
      color:#e5f0ff;
    }
    body.theme-light .msg-row.mention-me:not(.me) .msg{
      background:rgba(59,130,246,.18);
      color:#1e3a8a;
    }

    .msg-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:2px;
    }
    .msg-user{
      font-weight:700;
      font-size:13px;
    }
    .msg-user a{
      color:inherit;
      text-decoration:none;
    }
    .msg-user a:hover{
      text-decoration:underline;
    }
    .msg-time{
      font-size:11px;
      color:var(--text-dim);
      white-space:nowrap;
    }
    .msg-body{
      font-size:13px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    /* ===== ROUE J'AIME ===== */
    .msg-footer{
      display:flex;
      justify-content:flex-end;
      margin-top:4px;
    }
    .like-wheel{
      border:none;
      background:transparent;
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      color:var(--text-dim);
      cursor:pointer;
      padding:2px 6px;
      border-radius:999px;
    }
    .like-wheel.hidden{
      display:none;
    }
    .like-wheel .wheel-icon{
      font-size:14px;
    }
    .like-wheel.liked{
      color:#eab308;
      background:rgba(234,179,8,.1);
    }
    .like-wheel.liked .wheel-icon{
      text-shadow:0 0 6px rgba(250,204,21,.85);
    }

    /* ===== INPUT / BOUTONS ===== */
    .chat-input-row{
      display:flex;
      gap:8px;
      align-items:flex-end;
      position:relative; /* pour la liste @mention */
    }
    .chat-input{
      flex:1;
      min-height:46px;
      max-height:110px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--bg-soft);
      color:var(--text);
      font-size:14px;
      resize:vertical;
    }
    body.theme-light .chat-input{
      background:#f3f4f6;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,var(--accent),#16a34a);
      color:#022c16;
      border:0;
      border-radius:10px;
      font-weight:800;
      font-size:14px;
      padding:10px 14px;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.5);
      white-space:nowrap;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    .btn-media{
      width:40px;
      height:40px;
      border-radius:10px;
      border:0;
      background:#0f172a;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      box-shadow:0 4px 10px rgba(0,0,0,.45);
      cursor:pointer;
      flex-shrink:0;
    }
    body.theme-light .btn-media{
      background:#e5e7eb;
      color:#111827;
    }

    .chat-info{
      font-size:11px;
      color:var(--text-dim);
      margin-top:2px;
    }
    #chatError{
      font-size:12px;
      margin-top:4px;
      font-weight:700;
      color:#fda4af;
    }

    /* ===== IMAGE MINI + MODALE ===== */
    .media-thumb{
      width:120px;
      height:120px;
      border-radius:14px;
      overflow:hidden;
      position:relative;
      background:#020617;
      cursor:pointer;
      margin-top:4px;
    }
    .media-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .img-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .img-modal-inner{
      max-width:92%;
      max-height:92%;
      border-radius:18px;
      box-shadow:0 18px 45px rgba(0,0,0,.8);
    }

    /* ===== LISTE @MENTION ===== */
    .mention-list{
      position:absolute;
      left:0;
      right:80px;
      bottom:48px;
      background:var(--bg-soft);
      border:1px solid var(--border);
      border-radius:10px;
      padding:4px;
      font-size:13px;
      max-height:160px;
      overflow-y:auto;
      display:none;
      z-index:5;
    }
    .mention-item{
      padding:4px 8px;
      border-radius:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .mention-item span{
      font-weight:600;
    }
    .mention-item:hover,
    .mention-item.active{
      background:var(--accent-soft);
      color:var(--accent);
    }

    /* ===== TOAST (1v1) ===== */
    .toast{
      position:fixed;
      top:16px;
      left:50%;
      transform:translate(-50%,-10px);
      background:rgba(15,23,42,.95);
      color:#f9fafb;
      padding:7px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 10px 25px rgba(0,0,0,.45);
      z-index:50;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
    }
    .toast.show{
      opacity:1;
      transform:translate(-50%,0);
      pointer-events:auto;
    }
    .toast:hover{
      cursor:pointer;
    }

    /* ===== TABBAR ===== */
    .tabbar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      z-index:30;
      border-top:1px solid var(--border);
      background:rgba(2,6,23,.97);
      backdrop-filter:blur(18px);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:6px 8px 10px;
    }
    body.theme-light .tabbar{
      background:rgba(244,244,245,.97);
    }

    .tab{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      text-decoration:none;
      color:var(--text-dim);
      font-size:9px;
      letter-spacing:.04em;
      text-transform:uppercase;
      padding:4px 0;
    }
    .tab .ic{
      font-size:20px;
      line-height:1;
    }
    .tab.active{
      color:var(--accent);
    }

    @media(min-width:700px){
      nav.nav .row{
        padding-inline:20px;
      }
      .main{
        padding-inline:14px;
      }
      .tabbar{
        border-radius:22px 22px 0 0;
      }
    }
  </style>
</head>
<body class="theme-dark">

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<div class="page-wrap">

  <!-- NAV TOP -->
  <nav class="nav">
    <div class="row">
      <div class="nav-left">
        <a class="brand" href="ou_rider.html">
          <img src="image/1logo_ridly.png" alt="RIDLY"/>
          <span>RIDLY</span>
        </a>
        <button type="button" class="add-btn" onclick="window.location.href='ajouter.html'" title="Nouveau post">
          <span>+</span>
        </button>
      </div>
      <div class="nav-tools">
        <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">üåô</button>
        <!-- Bouton 1v1 avec logo + badge -->
        <a href="chat1v1.html" class="icon-btn" id="btn1v1" title="Messages priv√©s">
          <img src="image/1logo_ridly.png" alt="Messages" class="nav-msg-ic"/>
          <span class="nav-badge" id="badge1v1"></span>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENU PRINCIPAL -->
  <main class="main">
    <div class="mini-title">Chat Riders</div>

    <section class="card">
      <h1 class="main-title">Chat global RIDLY</h1>
      <p class="muted">
        Discute avec tous les riders connect√©s. Reste respectueux, pas d‚Äôinsultes ni de contenu sensible.
      </p>

      <div id="chatLocked" class="muted" style="margin-bottom:6px;display:none">
        Tu dois √™tre connect√© pour utiliser le chat.
        <a href="compte.html" style="color:#22c55e;font-weight:700">Se connecter</a>
      </div>

      <div class="chat-box" id="chatBox" style="display:none">
        <div class="chat-messages" id="chatMessages">
          <div class="muted">Chargement des messages‚Ä¶</div>
        </div>

        <div class="chat-input-row">
          <textarea
            id="chatInput"
            class="chat-input"
            maxlength="400"
            placeholder="√âcris ton message‚Ä¶ (max 400 caract√®res)"></textarea>
          <button id="mediaBtn" type="button" class="btn-media" title="Photo">üì∑</button>
          <button id="chatSend" class="btn" type="button">Envoyer</button>

          <!-- suggestions @pseudo -->
          <div id="mentionList" class="mention-list"></div>
        </div>
        <div class="chat-info">
          Messages r√©cents uniquement. Certains mots sont bloqu√©s automatiquement.
        </div>
        <div id="chatError"></div>

        <input id="mediaInput" type="file" accept="image/*" style="display:none"/>
      </div>
    </section>
  </main>
</div>

<!-- MODALE IMAGE FULL -->
<div id="imgModal" class="img-modal">
  <img id="imgModalInner" class="img-modal-inner" src="" alt="Image">
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- TABBAR -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab" href="ou_rider.html" title="Spots">
    <div class="ic">üìç</div><span>Spots</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Search</span>
  </a>
  <a class="tab" href="games.html" title="Games">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Rank</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<script>
/* ===== Th√®me ===== */
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => {
    const isLight = document.body.classList.contains('theme-light');
    btnTheme.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  };
  updateIcon();

  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<script>
/* ===== Supabase init + BG vid√©o ===== */
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

(function(){
  const v = document.getElementById('rslBg');
  if(!v) return;
  const s = document.createElement('source');
  s.src = SUPABASE_URL + "/storage/v1/object/public/ridly/ridly.mp4";
  s.type = "video/mp4";
  v.appendChild(s);
  const play = () => {
    try{
      v.playbackRate = 0.6;
      const p = v.play();
      if(p && p.catch) p.catch(()=>{});
    }catch(e){}
  };
  play();
  document.addEventListener('visibilitychange',()=>{
    document.hidden ? v.pause() : play();
  });
})();
</script>

<script>
/* ===== Chat global + photos + roues + mentions + alert 1v1 + badge nav ===== */

const chatBox      = document.getElementById('chatBox');
const chatLocked   = document.getElementById('chatLocked');
const chatMessages = document.getElementById('chatMessages');
const chatInput    = document.getElementById('chatInput');
const chatSend     = document.getElementById('chatSend');
const chatError    = document.getElementById('chatError');

const mediaBtn     = document.getElementById('mediaBtn');
const mediaInput   = document.getElementById('mediaInput');

const imgModal     = document.getElementById('imgModal');
const imgModalInner= document.getElementById('imgModalInner');

const toastDiv     = document.getElementById('toast');
const mentionList  = document.getElementById('mentionList');

const badge1v1     = document.getElementById('badge1v1');

let me       = null;
let profile  = null;
const seenMessageIds = new Set();
let unreadToastShown = false;

const notifAudio   = new Audio('https://ridly.ch/sons/sonsnotif.mp3');
const mentionAudio = new Audio('https://ridly.ch/sons/alglobal.mp3');   // son pour @mention

const BANNED_WORDS = ["con","connard","fdp","merde"];

/* participants pour @autocomplete */
const participants = new Map();
let mentionState = null;

/* helpers */
function escapeHTML(s){
  return (s||"").replace(/[&<>"']/g,m=>({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[m] || m));
}
function formatTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  return d.toLocaleTimeString("fr-CH",{hour:"2-digit",minute:"2-digit"});
}
function containsBannedWords(text){
  const clean = (text||"").toLowerCase();
  for(const w of BANNED_WORDS){
    if(!w) continue;
    if(clean.includes(w)) return true;
  }
  return false;
}
function playNotifSound(){
  try{
    notifAudio.currentTime = 0;
    notifAudio.play().catch(()=>{});
  }catch(e){}
}
function playMentionSound(){
  try{
    mentionAudio.currentTime = 0;
    mentionAudio.play().catch(()=>{});
  }catch(e){}
}
function showToast(msg){
  if(!toastDiv) return;
  toastDiv.textContent = msg;
  toastDiv.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastDiv.classList.remove('show'),4000);
}

/* badge 1v1 */
function updateBadge1v1(total){
  if(!badge1v1) return;
  if(total > 0){
    badge1v1.textContent = total > 9 ? '9+' : String(total);
    badge1v1.classList.add('show');
  }else{
    badge1v1.textContent = '';
    badge1v1.classList.remove('show');
  }
}

/* participants */
function registerParticipant(userId, prof){
  if(!userId || !prof) return;
  const pseudo = prof.pseudo || prof.full_name;
  if(!pseudo) return;
  const key = pseudo.toLowerCase();
  if(!participants.has(key)){
    participants.set(key,{
      id:userId,
      pseudo,
      display:pseudo
    });
  }
}

/* unread 1v1 */
async function checkPrivateUnread(){
  if(!me) return;
  try{
    const { data, error } = await supa
      .from('ridly_private_unread_counts')
      .select('unread_count')
      .eq('user_id', me.id);

    if(error){
      console.error('unread error', error);
      updateBadge1v1(0);
      return;
    }
    const total = (data||[]).reduce((sum,r)=>sum + (r.unread_count||0),0);
    updateBadge1v1(total);

    if(total>0 && !unreadToastShown){
      unreadToastShown = true;
      const s = total>1 ? 's' : '';
      showToast(`Tu as ${total} message${s} priv√©${s} non lu${s}.`);
      playNotifSound();
    }
  }catch(e){
    console.error(e);
    updateBadge1v1(0);
  }
}

/* alerts 1v1 temps r√©el */
function subscribePrivateAlerts(){
  if(!me) return;
  supa.channel('ridly_private_alert_'+me.id)
    .on('postgres_changes',{
      event:'INSERT',
      schema:'public',
      table:'ridly_private_messages'
    }, async payload => {
      const m = payload.new;
      if(m.to_id !== me.id) return;

      let senderName = 'Rider';
      try{
        const { data:p } = await supa
          .from('profiles')
          .select('pseudo,full_name')
          .eq('id', m.from_id)
          .maybeSingle();
        if(p) senderName = p.pseudo || p.full_name || 'Rider';
      }catch(e){}

      playNotifSound();
      showToast('Nouveau message priv√© de ' + senderName);

      // recharge le compteur pour le badge
      checkPrivateUnread();
    })
    .subscribe();
}

/* upload image */
async function uploadImage(file){
  const safeName = (file.name || 'photo').replace(/[^\w.\-]+/g,'_');
  const path = `global_media/${me.id}/${Date.now()}_${safeName}`;
  let { error } = await supa.storage.from('voice').upload(path,file,{
    upsert:false,
    contentType:file.type || 'image/jpeg'
  });
  if(error){
    const res2 = await supa.storage.from('voice').upload(path,file,{
      upsert:true,
      contentType:file.type || 'image/jpeg'
    });
    if(res2.error) throw res2.error;
  }
  const { data:pub } = supa.storage.from('voice').getPublicUrl(path);
  const url = pub?.publicUrl;
  if(!url) throw new Error("URL de fichier indisponible");
  return url;
}

/* like wheel */
async function toggleLike(msgId, btn){
  if(!me) return;
  const countSpan = btn.querySelector('.like-count');
  let count = parseInt(countSpan.textContent || "0",10) || 0;
  const isLiked = btn.classList.contains('liked');

  try{
    if(isLiked){
      await supa
        .from('ridly_chat_likes')
        .delete()
        .eq('msg_id', msgId)
        .eq('user_id', me.id);
      btn.classList.remove('liked');
      count = Math.max(0,count-1);
    }else{
      await supa
        .from('ridly_chat_likes')
        .upsert({ msg_id: msgId, user_id: me.id, liked:true });
      btn.classList.add('liked');
      count = count+1;
    }
    countSpan.textContent = String(count);
    btn.classList.remove('hidden');
  }catch(e){
    console.error('like error', e);
  }
}

/* appendMessage (ajout param isNew) */
function appendMessage(m, scroll=true, isNew=false){
  if(!m || !m.id) return;
  if(seenMessageIds.has(m.id)) return;
  seenMessageIds.add(m.id);

  const pseudo    = m.profiles?.pseudo || m.profiles?.full_name || "Rider";
  const avatarUrl = m.profiles?.avatar_url || null;
  const safeName  = escapeHTML(pseudo);
  const timeTxt   = formatTime(m.created_at);
  const content   = m.content || "";
  const isMine    = me && m.user_id === me.id;

  const row = document.createElement('div');
  row.className = 'msg-row';
  if(isMine) row.classList.add('me');

  /* mention pour moi */
  let isMentionForMe = false;
  if(!isMine && profile && profile.pseudo){
    const myPseudoLower = profile.pseudo.toLowerCase();
    const cLower = content.toLowerCase();
    if(
      cLower === '@'+myPseudoLower ||
      cLower.startsWith('@'+myPseudoLower+' ') ||
      cLower.startsWith('@'+myPseudoLower+',')
    ){
      isMentionForMe = true;
      row.classList.add('mention-me');
      if(isNew){
        playMentionSound();
      }
    }
  }

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  if(avatarUrl){
    avatar.innerHTML = `<img src="${escapeHTML(avatarUrl)}" alt="${safeName}">`;
  }else{
    avatar.textContent = safeName.charAt(0).toUpperCase();
  }

  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg';

  const headerHtml = `
    <div class="msg-header">
      <span class="msg-user">
        <a href="profil_ou_rider.html?id=${encodeURIComponent(m.user_id || '')}">
          ${safeName}
        </a>
      </span>
      <span class="msg-time">${timeTxt}</span>
    </div>
  `;

  let bodyHtml = "";
  if(content.startsWith('IMG:')){
    const url = content.slice(4);
    bodyHtml = `
      <div class="msg-body">
        <div class="media-thumb">
          <img src="${escapeHTML(url)}" class="chat-img" alt="photo">
        </div>
      </div>
    `;
  }else{
    bodyHtml = `<div class="msg-body">${escapeHTML(content)}</div>`;
  }

  const likeCount = m.like_count || 0;
  const likedByMe = !!m.liked_by_me;
  const hiddenCls = (likeCount===0 && !likedByMe) ? 'hidden' : '';

  const footerHtml = `
    <div class="msg-footer">
      <button class="like-wheel ${hiddenCls} ${likedByMe?'liked':''}" data-id="${m.id}">
        <span class="wheel-icon">üõû</span>
        <span class="like-count">${likeCount}</span>
      </button>
    </div>
  `;

  msgDiv.innerHTML = headerHtml + bodyHtml + footerHtml;

  row.appendChild(avatar);
  row.appendChild(msgDiv);
  chatMessages.appendChild(row);

  /* image full-screen */
  const img = row.querySelector('.chat-img');
  if(img){
    img.addEventListener('click', ()=>{
      imgModalInner.src = img.src;
      imgModal.style.display = 'flex';
    });
  }

  /* like */
  const likeBtn = msgDiv.querySelector('.like-wheel');
  if(likeBtn){
    msgDiv.addEventListener('dblclick', ()=>{
      toggleLike(m.id, likeBtn);
    });
    likeBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      toggleLike(m.id, likeBtn);
    });
  }

  if(scroll){
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
}

/* loadMessages */
async function loadMessages(){
  try{
    const { data, error } = await supa
      .from('ridly_chat_messages')
      .select('id,user_id,content,created_at,profiles(pseudo,full_name,avatar_url)')
      .order('created_at',{ascending:false})
      .limit(80);

    if(error){
      console.error(error);
      chatMessages.innerHTML = '<div class="muted">Erreur de chargement du chat.</div>';
      return;
    }

    const list = (data||[]).slice().reverse();
    chatMessages.innerHTML = "";
    seenMessageIds.clear();

    if(!list.length){
      chatMessages.innerHTML = '<div class="muted">Pas encore de messages. Lance la discussion üëá</div>';
      return;
    }

    const ids = list.map(m=>m.id);

    participants.clear();
    list.forEach(m=>{
      if(m.profiles){
        registerParticipant(m.user_id, m.profiles);
      }
    });
    if(profile && me){
      registerParticipant(me.id, profile);
    }

    const likeMap = new Map();
    if(ids.length){
      try{
        const { data:likesData } = await supa
          .from('ridly_chat_likes')
          .select('msg_id,user_id,liked')
          .in('msg_id', ids)
          .eq('liked',true);

        (likesData||[]).forEach(l=>{
          const cur = likeMap.get(l.msg_id) || {count:0,mine:false};
          cur.count++;
          if(me && l.user_id === me.id) cur.mine = true;
          likeMap.set(l.msg_id, cur);
        });
      }catch(e){
        console.error('likes load error', e);
      }
    }

    list.forEach(m=>{
      const info = likeMap.get(m.id) || {count:0,mine:false};
      appendMessage({
        ...m,
        like_count: info.count,
        liked_by_me: info.mine
      }, false, false);   // historique => pas de son
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;
  }catch(e){
    console.error(e);
    chatMessages.innerHTML = '<div class="muted">Erreur de chargement du chat.</div>';
  }
}

/* realtime messages */
function subscribeNewMessages(){
  supa.channel('ridly_chat')
    .on('postgres_changes',{
      event:'INSERT',
      schema:'public',
      table:'ridly_chat_messages'
    }, payload => {
      const m = payload.new;
      const msg = {
        ...m,
        profiles: (me && m.user_id === me.id && profile)
          ? { pseudo:profile.pseudo, full_name:profile.full_name, avatar_url:profile.avatar_url }
          : null,
        like_count:0,
        liked_by_me:false
      };

      if(msg.profiles){
        registerParticipant(msg.user_id, msg.profiles);
      }

      appendMessage(msg,true,true);   // nouveau message => si @moi => son
    })
    .subscribe();
}

/* envoyer texte */
async function sendMessage(){
  chatError.textContent = "";
  hideMentionList();
  const txt = (chatInput.value || "").trim();
  if(!txt) return;
  if(txt.length > 400){
    chatError.textContent = "Message trop long (max 400 caract√®res).";
    return;
  }
  if(containsBannedWords(txt)){
    chatError.textContent = "Message bloqu√© (mot interdit).";
    return;
  }
  if(!me){
    chatError.textContent = "Tu dois √™tre connect√© pour envoyer un message.";
    return;
  }

  chatSend.disabled = true;
  try{
    const { data, error } = await supa
      .from('ridly_chat_messages')
      .insert([{ user_id: me.id, content: txt }])
      .select('id,user_id,content,created_at')
      .single();

    if(error){
      console.error(error);
      chatError.textContent = "Erreur lors de l‚Äôenvoi du message.";
    }else if(data){
      const msg = {
        ...data,
        profiles: profile ? { pseudo:profile.pseudo, full_name:profile.full_name, avatar_url:profile.avatar_url } : null,
        like_count:0,
        liked_by_me:false
      };
      if(msg.profiles){
        registerParticipant(msg.user_id, msg.profiles);
      }
      appendMessage(msg,true,false);   // mon message => pas de son mention
      chatInput.value = "";
    }
  }catch(e){
    console.error(e);
    chatError.textContent = "Erreur r√©seau.";
  }finally{
    chatSend.disabled = false;
  }
}

/* photo */
mediaBtn.addEventListener('click', ()=>{
  chatError.textContent = "";
  if(!me){
    chatError.textContent = "Tu dois √™tre connect√© pour envoyer une photo.";
    return;
  }
  mediaInput.value = "";
  mediaInput.click();
});

mediaInput.addEventListener('change', async ()=>{
  const file = mediaInput.files && mediaInput.files[0];
  if(!file) return;
  if(!me){
    chatError.textContent = "Tu dois √™tre connect√© pour envoyer une photo.";
    return;
  }
  try{
    const url = await uploadImage(file);
    const content = 'IMG:'+url;
    const { data, error } = await supa
      .from('ridly_chat_messages')
      .insert([{ user_id: me.id, content }])
      .select('id,user_id,content,created_at')
      .single();
    if(error){
      console.error(error);
      chatError.textContent = "Erreur lors de l‚Äôenvoi de la photo.";
    }else if(data){
      const msg = {
        ...data,
        profiles: profile ? { pseudo:profile.pseudo, full_name:profile.full_name, avatar_url:profile.avatar_url } : null,
        like_count:0,
        liked_by_me:false
      };
      if(msg.profiles){
        registerParticipant(msg.user_id, msg.profiles);
      }
      appendMessage(msg,true,false);  // mon image => pas de son mention
    }
  }catch(e){
    console.error(e);
    chatError.textContent = "Erreur lors de l‚Äôenvoi de la photo.";
  }
});

/* modale image */
imgModal.addEventListener('click', ()=>{
  imgModal.style.display = 'none';
  imgModalInner.src = '';
});

/* ===== AUTOCOMPLETE @PSEUDO ===== */
function hideMentionList(){
  mentionList.style.display = 'none';
  mentionList.innerHTML = '';
  mentionState = null;
}

function showMentionSuggestions(query){
  const q = (query||'').toLowerCase();
  const items = [];
  participants.forEach(p=>{
    if(!q || p.pseudo.toLowerCase().startsWith(q)){
      items.push(p);
    }
  });
  if(!items.length){
    hideMentionList();
    return;
  }
  mentionList.innerHTML = '';
  items.slice(0,10).forEach(p=>{
    const div = document.createElement('div');
    div.className = 'mention-item';
    div.dataset.pseudo = p.pseudo;
    div.innerHTML = `<span>@${escapeHTML(p.pseudo)}</span>`;
    div.addEventListener('click', ()=>{
      applyMention(p.pseudo);
    });
    mentionList.appendChild(div);
  });
  mentionList.style.display = 'block';
}

function applyMention(pseudo){
  if(!mentionState) return;
  const value = chatInput.value;
  const start = mentionState.start;
  const end   = mentionState.end;
  const before = value.slice(0,start);
  const after  = value.slice(end);
  const insert = '@' + pseudo + ' ';
  chatInput.value = before + insert + after;
  const pos = before.length + insert.length;
  chatInput.focus();
  chatInput.setSelectionRange(pos,pos);
  hideMentionList();
}

chatInput.addEventListener('input', ()=>{
  const value = chatInput.value;
  const pos = chatInput.selectionStart || value.length;
  const sub = value.slice(0,pos);
  const match = sub.match(/@([^\s@]{0,20})$/);
  if(!match){
    hideMentionList();
    return;
  }
  const start = sub.lastIndexOf('@');
  mentionState = { start, end: pos };
  const query = match[1] || '';
  showMentionSuggestions(query);
});

chatInput.addEventListener('blur', ()=>{
  setTimeout(hideMentionList,150);
});

/* ===== init session ===== */
(async function init(){
  try{
    const { data:{ user } } = await supa.auth.getUser();
    if(!user){
      chatLocked.style.display = "block";
      chatBox.style.display    = "none";
      updateBadge1v1(0);
      return;
    }
    me = user;

    chatLocked.style.display = "none";
    chatBox.style.display    = "flex";

    const { data: prof } = await supa
      .from('profiles')
      .select('pseudo,full_name,avatar_url')
      .eq('id', me.id)
      .maybeSingle();
    profile = prof || null;
    if(profile){
      registerParticipant(me.id, profile);
    }

    await loadMessages();
    subscribeNewMessages();
    await checkPrivateUnread();
    subscribePrivateAlerts();
  }catch(e){
    console.error(e);
    chatLocked.style.display = "block";
    chatBox.style.display    = "none";
    updateBadge1v1(0);
  }
})();

/* events g√©n√©raux */
chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});
</script>

<script>
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }
</script>

</body>
</html>
