<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <title>Classement Game of Scoot ‚Äî RIDLY</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#22c55e;
      --green-dark:#16a34a;

      /* valeurs par d√©faut, √©cras√©es par theme-dark / theme-light */
      --bg:#000000;
      --panel:#0b1220;
      --panel-soft:#020617;
      --text:#ffffff;
      --dim:#9aa5b1;
      --border:rgba(255,255,255,.15);
    }

    /* ===== THEMES ===== */
    body.theme-dark{
      --bg:#000000;
      --panel:#0b1220;
      --panel-soft:#020617;
      --text:#ffffff;
      --dim:#9aa5b1;
      --border:rgba(255,255,255,.15);
    }
    body.theme-light{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#e5e7eb;
      --text:#020617;
      --dim:#4b5563;
      --border:rgba(15,23,42,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex;
      flex-direction:column;
    }
    main{flex:1}

    /* ===== BG vid√©o ===== */
    .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
    .rsl-bg-video{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;
      filter:brightness(.48) saturate(1.05);
    }
    .rsl-bg-dim{
      position:absolute;inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.6));
    }
    body.theme-light .rsl-bg-dim{
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
    }

    /* ===== NAV top (comme recherche / feed) ===== */
    nav.nav{
      position:sticky;top:0;z-index:1000;
      background:rgba(0,0,0,.65);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    body.theme-light nav.nav{
      background:rgba(243,244,246,.9);
      border-bottom:1px solid rgba(15,23,42,.1);
    }
    nav .row{
      max-width:1200px;margin:0 auto;
      padding:12px 20px;
      display:flex;justify-content:space-between;align-items:center;
    }
    nav .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      color:var(--text);
      text-decoration:none;
    }
    nav .brand img{
      height:52px;
      width:52px;
      border-radius:12px;
      background:#000;
      padding:6px;
      box-shadow:0 0 14px rgba(34,197,94,.6);
    }
    nav .brand span{font-size:18px}
    nav a{color:var(--text);text-decoration:none;font-weight:700}
    nav a:hover{color:var(--green)}

    .nav-tools{
      display:flex;
      gap:8px;
      align-items:center;
      margin-left:auto;
    }
    .icon-btn{
      border:1px solid var(--border);
      background:rgba(0,0,0,.8);
      color:var(--text);
      border-radius:999px;
      width:34px;height:34px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      font-size:16px;
      text-decoration:none;
      position:relative;
    }
    body.theme-light .icon-btn{
      background:#e5e7eb;
    }
    .icon-btn:hover{
      border-color:var(--green);
      color:var(--green);
    }
    .chat-dot{
      position:absolute;
      top:5px;
      right:6px;
      width:8px;
      height:8px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.9);
      opacity:0;
    }

    /* ===== Mini hero ===== */
    .page-mini-hero{position:relative;z-index:10;padding:16px 0 6px}
    .page-mini-hero .container{max-width:1200px;margin:0 auto;padding:0 20px}
    .page-mini-hero h1{margin:0 0 6px;font-size:clamp(26px,4vw,38px);font-weight:800}
    .page-mini-hero p{margin:0;color:var(--dim);font-size:14px;max-width:720px}

    /* ===== Contenu classement ===== */
    main .container{
      max-width:800px;
      margin:0 auto 110px;
      padding:0 20px 40px;
      position:relative;
      z-index:10;
    }

    h2.page-title{
      font-size:22px;
      margin:8px 0 12px;
      text-align:center;
    }

    .leaderboard{
      background:rgba(0,0,0,.7);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      box-shadow:0 30px 60px rgba(0,0,0,.85);
    }
    body.theme-light .leaderboard{
      background:var(--panel);
      box-shadow:0 18px 45px rgba(15,23,42,.15);
    }

    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 8px;text-align:left;}
    th{
      color:var(--dim);
      font-size:13px;
      text-transform:uppercase;
      border-bottom:1px solid var(--border);
    }
    td{
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:14px;
      color:var(--text);
    }
    tr:hover{background:rgba(34,197,94,.05);}
    .rank{font-weight:700;width:40px;text-align:center;}
    .name{font-weight:600;}
    .wins{color:var(--green);}
    .losses{color:#f87171;}
    .ratio{color:var(--text);}
    .reload{
      display:inline-block;
      margin:10px auto 20px;
      background:var(--green);
      color:#000;
      font-weight:700;
      padding:8px 16px;
      border-radius:999px;
      text-decoration:none;
      text-align:center;
    }
    .reload-wrap{text-align:center;}
    .loading{text-align:center;color:var(--dim);margin-top:20px;}

    /* ===== Tabbar ===== */
    .tabbar{
      position:fixed;
      left:0;right:0;bottom:0;
      z-index:2000;
      display:flex;
      align-items:center;
      justify-content:space-around;
      padding:14px 18px;
      border-top:1px solid var(--border);
      background:rgba(0,0,0,.78);
      backdrop-filter:blur(10px);
    }
    body.theme-light .tabbar{
      background:rgba(243,244,246,.96);
    }
    .tab{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      text-decoration:none;
    }
    .tab .ic{font-size:24px}
    .tab span{font-size:13px;color:#e5e7eb;font-weight:700}
    body.theme-light .tab span{color:#111827}
    .tab.active span{color:#22c55e}
    @media(min-width:900px){ .tab span{font-size:12px} }
  </style>
</head>
<body>

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<!-- Nav top -->
<nav class="nav">
  <div class="row">
    <a class="brand" href="ou_rider.html">
      <img src="image/1logo_ridly.png" alt="RIDLY"/>
      <span>RIDLY</span>
    </a>
    <div class="nav-tools">
      <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">üåô</button>
      <a href="chat.html" class="icon-btn" id="btnChat" title="Chat riders">
        <span class="chat-dot" id="chatDot"></span>
        üí¨
      </a>
    </div>
  </div>
</nav>

<!-- Hero -->
<section class="page-mini-hero">
  <div class="container">
    <h1>Classement Game of Scoot</h1>
    <p>
      Top riders sur les parties Game of Scoot jou√©es sur RIDLY. Victoires, d√©faites
      et ratio de wins.
    </p>
  </div>
</section>

<main>
  <div class="container">
    <h2 class="page-title">üèÜ Leaderboard</h2>

    <div class="reload-wrap">
      <a href="#" id="btnReload" class="reload">üîÑ Actualiser</a>
    </div>

    <div id="leaderboard" class="leaderboard">
      <div class="loading">Chargement du classement...</div>
    </div>
  </div>
</main>

<!-- Tabbar -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab" href="ou_rider.html" title="Carte / Spots">
    <div class="ic">üè†</div><span>Spots</span>
  </a>
  <a class="tab" href="ajouter.html" title="Ajouter">
    <div class="ic">‚ûï</div><span>Ajouter</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Recherche</span>
  </a>
  <a class="tab" href="games.html" title="Games">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab active" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Classement</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<script>
/* ===== THEME (clair / sombre, partag√©) ===== */
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => {
    const isLight = document.body.classList.contains('theme-light');
    btnTheme.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  };
  updateIcon();

  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<script>
/* ===== Supabase init ===== */
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* BG vid√©o RIDLY */
(function(){
  const v = document.getElementById('rslBg');
  if(!v) return;
  const s = document.createElement('source');
  s.src = SUPABASE_URL + "/storage/v1/object/public/ridly/ridly.mp4";
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{ try{ v.playbackRate = 0.6; const p=v.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} };
  play();
  document.addEventListener('visibilitychange',()=>{ document.hidden ? v.pause() : play(); });
})();
</script>

<script>
/* ===== Classement Game of Scoot ===== */
const board    = document.getElementById('leaderboard');
const btnReload = document.getElementById('btnReload');
const chatDot   = document.getElementById('chatDot');

async function loadClassement(){
  board.innerHTML = '<div class="loading">Chargement du classement...</div>';
  try{
    const { data, error } = await supa
      .from('scoot_stats')
      .select('user_id, wins, losses')
      .order('wins', { ascending:false })
      .limit(50);
    if(error) throw error;
    if(!data || !data.length){
      board.innerHTML = '<div class="loading">Aucune donn√©e disponible.</div>';
      return;
    }

    const userIds = data.map(d => d.user_id);
    const { data: users } = await supa
      .from('profiles')
      .select('id, username, email')
      .in('id', userIds);

    const mapUsers = {};
    (users||[]).forEach(u => { mapUsers[u.id] = u.username || u.email || u.id; });

    let html = '<table><tr><th>#</th><th>Rider</th><th>Victoires</th><th>D√©faites</th><th>Ratio</th></tr>';
    data.forEach((d, i) => {
      const wins = d.wins || 0;
      const losses = d.losses || 0;
      const total = wins + losses;
      const ratio = total ? (wins / total * 100).toFixed(1) + '%' : '-';
      html += `
        <tr>
          <td class="rank">${i+1}</td>
          <td class="name">${mapUsers[d.user_id]||'Rider inconnu'}</td>
          <td class="wins">${wins}</td>
          <td class="losses">${losses}</td>
          <td class="ratio">${ratio}</td>
        </tr>`;
    });
    html += '</table>';
    board.innerHTML = html;
  }catch(e){
    console.error(e);
    board.innerHTML = '<div class="loading">Erreur de chargement du classement.</div>';
  }
}

btnReload.addEventListener('click', e => {
  e.preventDefault();
  loadClassement();
});

// petit point vert sur le bouton chat (comme recherche)
if(chatDot) chatDot.style.opacity = 1;

loadClassement();
</script>

</body>
</html>
