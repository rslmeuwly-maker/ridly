<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>O√π rider ? ‚Äî RIDLY</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/env.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --green:#22c55e;
    --green-dark:#16a34a;

    --bg:#000000;
    --panel:#0b1220;
    --panel-soft:#020617;
    --text:#ffffff;
    --dim:#9aa5b1;
    --border:rgba(255,255,255,.15);
  }

  /* ===== THEMES ===== */
  body.theme-dark{
    --bg:#000000;
    --panel:#0b1220;
    --panel-soft:#020617;
    --text:#ffffff;
    --dim:#9aa5b1;
    --border:rgba(255,255,255,.15);
  }
  body.theme-light{
    --bg:#f3f4f6;
    --panel:#ffffff;
    --panel-soft:#e5e7eb;
    --text:#020617;
    --dim:#4b5563;
    --border:rgba(15,23,42,.12);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:flex;
    flex-direction:column;
  }
  main{flex:1}

  /* ===== BG vid√©o ===== */
  .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
  .rsl-bg-video{
    position:absolute;inset:0;width:100%;height:100%;
    object-fit:cover;background:#000;
    filter:brightness(.55) saturate(1.05);
  }
  .rsl-bg-dim{
    position:absolute;inset:0;
    background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.55));
  }
  body.theme-light .rsl-bg-dim{
    background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
  }

  /* ===== NAV top ===== */
  nav.nav{
    position:sticky;
    top:0;
    z-index:1000;
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(8px);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  body.theme-light nav.nav{
    background:rgba(243,244,246,.9);
    border-bottom:1px solid rgba(15,23,42,.1);
  }
  nav .row{
    max-width:1200px;margin:0 auto;
    padding:10px 20px;
    display:flex;justify-content:space-between;align-items:center;
  }
  nav .brand{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:800;
    color:var(--text);
    text-decoration:none;
  }
  nav .brand img{
    height:40px !important;
    width:40px !important;
    border-radius:12px;
    background:#000;
    padding:4px;
    box-shadow:0 0 10px rgba(34,197,94,.6);
  }
  nav .brand span{
    font-size:18px !important;
  }
  nav a{color:var(--text);text-decoration:none;font-weight:700}
  nav a:hover{color:var(--green)}

  .nav-tools{
    display:flex;
    gap:8px;
    align-items:center;
    margin-left:auto;
  }
  .icon-btn{
    border:1px solid var(--border);
    background:rgba(0,0,0,.8);
    color:var(--text);
    border-radius:999px;
    min-width:34px;height:34px;
    padding:0 10px;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;
    font-size:15px;
    text-decoration:none;
    position:relative;
    gap:6px;
  }
  .icon-btn span.label{
    font-size:12px;
    font-weight:700;
  }
  @media(max-width:640px){
    .icon-btn span.label{display:none}
    .icon-btn{min-width:34px;padding:0}
  }
  body.theme-light .icon-btn{
    background:#e5e7eb;
  }
  .icon-btn:hover{
    border-color:var(--green);
    color:var(--green);
  }
  .chat-dot{
    position:absolute;
    top:5px;
    right:6px;
    width:8px;
    height:8px;
    border-radius:50%;
    background:#22c55e;
    box-shadow:0 0 8px rgba(34,197,94,.9);
    opacity:0;
  }

  /* ===== Titre ===== */
  .page-mini-hero{position:relative;z-index:10;padding:12px 0 6px}
  .page-mini-hero .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .page-mini-hero h1{margin:0 0 6px;font-size:clamp(24px,4vw,34px);font-weight:800}
  .page-mini-hero p{margin:0;color:var(--dim);font-size:14px}

  /* ===== Carte ===== */
  main .container{max-width:1200px;margin:0 auto;padding:0 20px 120px;position:relative;z-index:10}
  .map-wrap{position:relative}
  #map{
    height:73vh;
    min-height:480px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background:var(--panel);
  }
  body.theme-light #map{
    border-color:rgba(15,23,42,.12);
  }
  @media(max-width:900px){
    #map{height:calc(100vh - 38vh);min-height:58vh}
  }
  .leaflet-pane,.leaflet-top,.leaflet-bottom{z-index:2}

  /* ===== Bouton Filtres ===== */
  .filters-fab{
    position:absolute;
    right:12px;top:12px;
    z-index:3100;
    display:block;
  }
  .btn{
    appearance:none;
    border:1px solid var(--border);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:10px;
    padding:10px 16px;
    font:800 13px Outfit;
    cursor:pointer;
  }
  .btn.green{
    background:linear-gradient(180deg,var(--green),var(--green-dark));
    color:#062312;
    border:0;
  }

  .filters-fab .btn{
    background:rgba(0,0,0,0.85)!important;
    border:1px solid #22c55e!important;
    box-shadow:0 0 8px rgba(34,197,94,.4);
  }
  body.theme-light .filters-fab .btn{
    background:#ffffff !important;
    color:#111827;
    border-color:rgba(15,23,42,.2) !important;
    box-shadow:0 0 8px rgba(0,0,0,.08);
  }

  /* ===== Panneau Filtres ===== */
  .filters-wrap{
    position:absolute;
    top:12px;right:12px;
    z-index:3000;
    width:min(92vw,360px);
    display:none;
  }
  body.show-filters .filters-wrap{display:block}
  .filters-card{
    background:rgba(0,0,0,.82);
    border:1px solid rgba(255,255,255,.15);
    border-radius:14px;
    padding:12px;
    box-shadow:0 20px 60px rgba(0,0,0,.6);
    backdrop-filter:blur(6px) saturate(140%);
    max-height:70vh;
    overflow:auto;
    color:var(--text);
  }
  body.theme-light .filters-card{
    background:rgba(255,255,255,.96);
    border-color:rgba(15,23,42,.12);
    box-shadow:0 18px 45px rgba(15,23,42,.15);
  }
  .filters-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    margin-top:8px;
  }
  .chip{
    display:flex;align-items:center;gap:8px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;border-radius:10px;
    font:700 13px Outfit;
  }
  body.theme-light .chip{
    background:#f3f4f6;
    border-color:rgba(15,23,42,.12);
  }
  .chip input{width:18px;height:18px}
  .input,.select{
    width:100%;
    background:#0b1220;
    border:1px solid rgba(255,255,255,.18);
    border-radius:10px;
    color:#fff;
    padding:10px 12px;
    font:600 14px Outfit;
  }
  body.theme-light .input,
  body.theme-light .select{
    background:#f9fafb;
    color:#020617;
    border-color:rgba(15,23,42,.15);
  }
  .filters-foot{
    display:flex;flex-wrap:wrap;gap:8px;
    margin-top:10px;
  }

  /* ===== Popups ===== */
  .leaflet-popup-content-wrapper{
    background:rgba(0,0,0,.9);
    border:1px solid rgba(34,197,94,.5);
    border-radius:14px;
    box-shadow:0 30px 60px rgba(0,0,0,.8);
    color:#fff;
  }
  .leaflet-popup-tip{
    background:rgba(0,0,0,.9);
    border:1px solid rgba(34,197,94,.5);
  }
  .leaflet-popup-content{margin:10px;min-width:200px;max-width:240px}
  .rsl-pop-title{font:700 14px/1.25 Outfit}
  .rsl-pop-loc{color:#9aa5b1;font:600 12px/1.3 Outfit;margin:2px 0 6px}
  .rsl-pop-desc{color:#cdd6ff;font:500 12px/1.4 Outfit;margin-bottom:8px}
  .rsl-pop-btn{
    display:inline-block;
    font:800 12px/1.2 Outfit;
    padding:8px 10px;
    border-radius:8px;
    background:linear-gradient(180deg,#22c55e,#16a34a);
    color:#062312;
    text-decoration:none;
  }

  /* ===== Modales ===== */
  .modal{position:fixed;inset:0;z-index:4000;display:none}
  .modal.show{display:block}
  .modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
  .modal-card{
    position:relative;
    margin:6vh auto 0;
    max-width:min(92vw,720px);
    background:rgba(8,12,24,.96);
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px;
    padding:14px;
    color:#fff;
  }
  body.theme-light .modal-card{
    background:#ffffff;
    color:#020617;
    border-color:rgba(15,23,42,.12);
  }
  .modal-card h3{margin:2px 0 10px;font-size:18px;font-weight:800}
  .modal .row{display:flex;gap:10px;margin-bottom:8px}
  .modal .row .col{flex:1}
  .modal input,.modal select,.modal textarea{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    background:#07101f;
    border:1px solid rgba(255,255,255,.16);
    color:#fff;
    font:600 14px Outfit;
  }
  body.theme-light .modal input,
  body.theme-light .modal select,
  body.theme-light .modal textarea{
    background:#f9fafb;
    color:#020617;
    border-color:rgba(15,23,42,.15);
  }
  .modal textarea{min-height:82px;resize:vertical}
  .modal .actions{
    display:flex;gap:8px;justify-content:flex-end;
    margin-top:10px;
  }
  #asMsg{font:700 12px;color:#7cffb0}
  #asMsg.error{color:#ff9f9f}
  @media(max-width:520px){ .modal .row{flex-direction:column} }

  /* ===== Tabbar ===== */
  .tabbar{
    position:fixed;
    left:0;right:0;bottom:0;
    z-index:2000;
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:14px 18px;
    border-top:1px solid var(--border);
    background:rgba(0,0,0,.78);
    backdrop-filter:blur(10px);
  }
  body.theme-light .tabbar{
    background:rgba(243,244,246,.96);
  }
  .tab{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    text-decoration:none;
  }
  .tab .ic{font-size:24px}
  .tab span{font-size:13px;color:#e5e7eb;font-weight:700}
  body.theme-light .tab span{color:#111827}
  .tab.active span{color:#22c55e}
  @media(min-width:900px){ .tab span{font-size:12px} }
</style>
</head>
<body>

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<!-- NAV TOP -->
<nav class="nav">
  <div class="row">
    <a class="brand" href="ou_rider.html">
      <img src="image/1logo_ridly.png" alt="RIDLY" />
      <span>RIDLY</span>
    </a>
    <div class="nav-tools">
      <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">üåô</button>
      <button type="button" class="icon-btn" id="btnPwa" title="Installer l'app RIDLY">
        üì≤ <span class="label">App</span>
      </button>
      <a href="chat.html" class="icon-btn" id="btnChat" title="Chat riders">
        <span class="chat-dot" id="chatDot"></span>
        üí¨
      </a>
    </div>
  </div>
</nav>

<script>
/* === Gestion du th√®me clair/sombre === */
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => {
    const isLight = document.body.classList.contains('theme-light');
    btnTheme.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  };
  updateIcon();

  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<script>
/* === PWA : bouton dans la nav === */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredInstallPrompt = e;
});

const btnPwa = document.getElementById('btnPwa');
if(btnPwa){
  btnPwa.addEventListener('click', async ()=>{
    if(deferredInstallPrompt){
      deferredInstallPrompt.prompt();
      try{
        await deferredInstallPrompt.userChoice;
      }catch(e){}
      deferredInstallPrompt = null;
    }else{
      alert("Pour installer RIDLY, utilise \"Ajouter √† l'√©cran d'accueil\" dans ton navigateur.");
    }
  });
}
</script>

<!-- Titre -->
<section class="page-mini-hero">
  <div class="container">
    <h1>O√π rider ?</h1>
    <p>
      Carte des <b>skateparks</b>, <b>street spots</b>, <b>shops partenaires</b> et <b>lieux de cours RSL</b>.<br>
      Partage ta position, ou ajoute ton propre spot.
    </p>
  </div>
</section>

<!-- Carte + Filtres -->
<main>
  <div class="container">
    <div class="map-wrap">

      <!-- bouton filtres -->
      <div class="filters-fab">
        <button id="btnToggleFilters" class="btn">Filtres</button>
      </div>

      <!-- panneau filtres -->
      <div class="filters-wrap" id="filtersWrap">
        <div class="filters-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <b style="font:800 13px Outfit">Filtres</b>
            <button id="btnCloseFilters" class="btn" style="padding:4px 10px">‚úï</button>
          </div>

          <div class="filters-grid" style="margin-top:8px">
            <label class="chip"><input type="checkbox" id="f-park" checked/> Parks</label>
            <label class="chip"><input type="checkbox" id="f-street" checked/> Street</label>
            <label class="chip"><input type="checkbox" id="f-shop" checked/> Shops</label>
            <label class="chip"><input type="checkbox" id="f-cours" checked/> Cours</label>

            <select id="f-country" class="select">
              <option value="">Pays (tous)</option>
              <option value="CH">Suisse</option>
              <option value="FR">France</option>
              <option value="DE">Allemagne</option>
              <option value="EU">Autres Europe</option>
              <option value="WORLD">Monde</option>
            </select>

            <select id="f-canton" class="select"><option value="">Canton (CH)</option></select>

            <input id="f-type" class="input" placeholder="Type/texte (bowl, pumptrack, rail‚Ä¶)" />
          </div>

          <div class="filters-foot">
            <button id="btnReset" class="btn">R√©initialiser</button>
            <button id="btnLocate" class="btn green">üìç Ma position</button>
            <button id="btnShare" class="btn" title="Partage ta position avec les riders">Activer partage</button>
            <span id="shareState" style="font:600 12px Outfit;color:var(--dim);align-self:center"></span>
            <button id="btnAddSpot" class="btn green" style="margin-left:auto">‚ûï Ajouter un spot</button>
          </div>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </div>
</main>

<!-- Modale Ajouter un spot -->
<div class="modal" id="addSpotModal">
  <div class="modal-bg"></div>
  <div class="modal-card">
    <h3>Proposer un nouveau spot</h3>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Type</label>
        <select id="asType">
          <option value="park">Skatepark / Pumptrack</option>
          <option value="street">Street spot</option>
        </select>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Pays</label>
        <select id="asCountry">
          <option value="CH">Suisse</option>
          <option value="FR">France</option>
          <option value="DE">Allemagne</option>
          <option value="EU">Autres Europe</option>
          <option value="WORLD">Monde</option>
        </select>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Canton (CH)</label>
        <select id="asCanton">
          <option value="">‚Äî</option>
          <option>AG</option><option>AI</option><option>AR</option><option>BE</option><option>BL</option>
          <option>BS</option><option>FR</option><option>GE</option><option>GL</option><option>GR</option>
          <option>JU</option><option>LU</option><option>NE</option><option>NW</option><option>OW</option>
          <option>SG</option><option>SH</option><option>SO</option><option>SZ</option><option>TG</option>
          <option>TI</option><option>UR</option><option>VD</option><option>VS</option><option>ZG</option>
          <option>ZH</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Ville</label>
        <input id="asVille" placeholder="Ville"/>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Nom du spot</label>
        <input id="asNom" placeholder="Nom du spot"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Description</label>
        <textarea id="asDesc" placeholder="Courte description (type, modules, niveau...)"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Latitude</label>
        <input id="asLat" placeholder="Clique la carte ou le bouton"/>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Longitude</label>
        <input id="asLng" placeholder="Clique la carte ou le bouton"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <button type="button" class="btn" id="btnPickLatLng" style="width:100%">üìç Choisir sur une petite carte</button>
        <div style="font-size:12px;color:#22c55e;margin-top:4px">
          Tu peux aussi cliquer directement sur la grande carte pour remplir lat / lng.
        </div>
      </div>
    </div>

    <div class="actions">
      <span id="asMsg"></span>
      <button type="button" class="btn" id="asCancel">Annuler</button>
      <button type="button" class="btn green" id="asSave">Envoyer</button>
    </div>
  </div>
</div>

<!-- Modale petite carte pour choisir lat/lng -->
<div class="modal" id="pickMapModal">
  <div class="modal-bg"></div>
  <div class="modal-card" style="max-width:min(92vw,500px);">
    <h3>Choisir l‚Äôemplacement</h3>
    <p style="font-size:13px;margin-top:0;margin-bottom:8px">
      Clique sur la carte pour placer le spot. Les champs latitude / longitude se remplissent automatiquement.
    </p>

    <div class="row">
      <div class="col">
        <input id="pickSearch" placeholder="Recherche ville / spot (ex: Bulle)">
      </div>
      <button type="button" class="btn" id="pickSearchBtn" style="white-space:nowrap">Rechercher</button>
    </div>

    <div id="pickMap" style="height:320px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.18);"></div>
    <div class="actions" style="margin-top:10px">
      <button type="button" class="btn" id="pickMapCancel">Annuler</button>
      <button type="button" class="btn green" id="pickMapOk">OK</button>
    </div>
  </div>
</div>

<!-- Tabbar -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab active" href="ou_rider.html" title="Carte / Spots">
    <div class="ic">üè†</div><span>Spots</span>
  </a>
  <a class="tab" href="ajouter.html" title="Ajouter">
    <div class="ic">‚ûï</div><span>Ajouter</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Recherche</span>
  </a>
  <a class="tab" href="games.html" title="Games">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Classement</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<script>
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let currentUser = null;

/* Auth guard */
(async function(){
  try{
    const { data:{ user } } = await supa.auth.getUser();
    if(!user){
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;

    const dot = document.getElementById('chatDot');
    if(dot) dot.style.opacity = 1;
  }catch(e){
    console.error(e);
    window.location.href = 'index.html';
  }
})();

/* VID√âO DE FOND */
(function(){
  const v = document.getElementById('rslBg');
  if (!v) return;
  const s = document.createElement('source');
  s.src = SUPABASE_URL + "/storage/v1/object/public/ridly/ridly.mp4";
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{ 
    try{
      v.playbackRate = .6;
      const p = v.play();
      if(p && p.catch) p.catch(()=>{});
    }catch(e){}
  };
  play();
  document.addEventListener('visibilitychange',()=>{ document.hidden ? v.pause() : play(); });
})();
</script>

<script>
/* ===== Carte / filtres / donn√©es / partage riders / ajout spot ===== */

let map = L.map('map').setView([46.8, 8.2], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'¬© OpenStreetMap'
}).addTo(map);

const mk = (bg, emoji='üõπ') => L.divIcon({
  className:'rsl-marker',
  html:`<div style="width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${bg};border:2px solid #fff;color:#fff;font-size:18px">${emoji}</div>`,
  iconSize:[34,34], iconAnchor:[17,17]
});
const icons = {
  park:  mk('#7c3aed','üõπ'),
  street:mk('#f97316','üß±'),
  shop:  mk('#ef4444','üè™'),
  int:   mk('#16a34a','üè´'),
  ext:   mk('#0ea5e9','üõº'),
  rider: mk('#06b6d4','üë§')
};

const layers = {
  park:L.layerGroup().addTo(map),
  street:L.layerGroup().addTo(map),
  shop:L.layerGroup().addTo(map),
  int:L.layerGroup().addTo(map),
  ext:L.layerGroup().addTo(map),
  riders:L.layerGroup().addTo(map)
};

const ALL_MARKERS = []; // {marker, group, canton, country, text}

/* Filtres UI */
const bodyEl = document.body;
document.getElementById('btnToggleFilters').onclick = ()=> bodyEl.classList.toggle('show-filters');
document.getElementById('btnCloseFilters').onclick  = ()=> bodyEl.classList.remove('show-filters');
document.addEventListener('keydown',e=>{ if(e.key==='Escape') bodyEl.classList.remove('show-filters'); });

const F = {
  park:   document.getElementById('f-park'),
  street: document.getElementById('f-street'),
  shop:   document.getElementById('f-shop'),
  cours:  document.getElementById('f-cours'),
  country:document.getElementById('f-country'),
  canton: document.getElementById('f-canton'),
  type:   document.getElementById('f-type'),
  reset:  document.getElementById('btnReset'),
  locate: document.getElementById('btnLocate')
};

function applyFilters(){
  const show = {
    park:F.park.checked,
    street:F.street.checked,
    shop:F.shop.checked,
    int:F.cours.checked,
    ext:F.cours.checked
  };
  const cantonSel  = (F.canton.value||'').trim();
  const countrySel = (F.country.value||'').trim();
  const txt        = (F.type.value||'').trim().toLowerCase();

  ALL_MARKERS.forEach(o=>{
    let vis = !!show[o.group] || o.group==='riders';
    if(vis && countrySel && o.group!=='riders') vis = (o.country||'')===countrySel;
    if(vis && cantonSel && o.group!=='riders') vis = (o.canton||'')===cantonSel;
    if(vis && txt && o.group!=='riders') vis = (o.text||'').includes(txt);

    if(vis){
      if(!map.hasLayer(o.marker)) o.marker.addTo(layers[o.group]);
    }else{
      if(map.hasLayer(o.marker)) layers[o.group].removeLayer(o.marker);
    }
  });
}

['change','input'].forEach(ev=>{
  [F.park,F.street,F.shop,F.cours,F.country,F.canton,F.type].forEach(el=>{
    el.addEventListener(ev,applyFilters);
  });
});

F.reset.onclick = ()=>{
  F.park.checked = F.street.checked = F.shop.checked = F.cours.checked = true;
  F.country.value = '';
  F.canton.value  = '';
  F.type.value    = '';
  applyFilters();
};

F.locate.onclick = ()=>{
  if(!navigator.geolocation){ alert('G√©olocalisation indisponible.'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    L.circleMarker([latitude,longitude],{
      radius:6,color:'#38bdf8',fillColor:'#38bdf8',fillOpacity:.9,weight:2
    }).addTo(map);
    map.setView([latitude,longitude],14);
  },()=>alert("Impossible d'obtenir ta position."));
};

/* Donn√©es Supabase */
(async function loadData(){
  // shops
  let { data: shops } = await supa.from('shops').select('*');
  (shops||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Shop'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description||''}</div>
        ${s.site?`<a class="rsl-pop-btn" href="${s.site}" target="_blank" rel="noopener">Site du shop ‚Üí</a>`:''}
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.shop})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:'shop',
      canton:s.canton||'',
      country:s.country||'CH',
      text:`${s.nom||''} ${s.ville||''} ${s.description||''}`.toLowerCase()
    });
    m.addTo(layers.shop);
  });

  // parks
  let { data: parks } = await supa.from('spots').select('*');
  (parks||[]).forEach(p=>{
    if(!p.lat||!p.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${p.nom||'Spot'}</div>
        <div class="rsl-pop-loc">${p.ville||''} (${p.canton||''})</div>
        <div class="rsl-pop-desc">${p.description ? p.description : (p.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${p.id}" onclick="window.location.href='spot.html?id=${p.id}';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([p.lat,p.lng],{icon:icons.park})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${p.nom||''} ${p.ville||''} ${p.canton||''} ${p.type||''} ${p.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'park',
      canton:p.canton||'',
      country:p.country||'CH',
      text
    });
    m.addTo(layers.park);
  });

  // street
  let { data: streets } = await supa.from('bunny').select('*');
  (streets||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Street spot'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description ? s.description : (s.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${s.id}&street=1" onclick="window.location.href='spot.html?id=${s.id}&street=1';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.street})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${s.nom||''} ${s.ville||''} ${s.canton||''} ${s.type||''} ${s.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'street',
      canton:s.canton||'',
      country:s.country||'CH',
      text
    });
    m.addTo(layers.street);
  });

  // lieux de cours
  [
    {group:'int',  n:'Cours RSL ‚Äî Montreux (indoor)', lat:46.433, lng:6.910, desc:'Session encadr√©e en int√©rieur'},
    {group:'int',  n:'Cours RSL ‚Äî Lausanne (La Fi√®vre)', lat:46.536, lng:6.626, desc:'Cours en salle / rampes / park'},
    {group:'ext',  n:'Cours RSL ‚Äî Vidy', lat:46.523, lng:6.610, desc:'En ext√©rieur, bord du lac'},
  ].forEach(c=>{
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${c.n}</div>
        <div class="rsl-pop-desc">${c.desc||''}</div>
        <a class="rsl-pop-btn" href="cours.html">Infos cours ‚Üí</a>
      </div>`;
    const m = L.marker([c.lat,c.lng],{icon:icons[c.group]})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:c.group,
      canton:'',
      country:'CH',
      text:(c.n+' '+(c.desc||'')).toLowerCase()
    });
    m.addTo(layers[c.group]);
  });

  // cantons
  const cantons = new Set();
  ALL_MARKERS.forEach(o=>{ if(o.country==='CH' && o.canton) cantons.add(o.canton); });
  document.getElementById('f-canton').innerHTML =
    '<option value="">Canton (CH)</option>' +
    Array.from(cantons).sort().map(c=>`<option value="${c}">${c}</option>`).join('');

  applyFilters();
})();

/* Partage position riders */
let watchId = null;
const shareBtn   = document.getElementById('btnShare');
const shareState = document.getElementById('shareState');

function updateShareUi(active, hint){
  shareBtn.textContent = active ? "Couper partage" : "Activer partage";
  if(active){
    shareBtn.classList.remove('green');
  }else{
    shareBtn.classList.add('green');
  }
  if(hint!==undefined) shareState.textContent = hint || "";
}

async function upsertMyLocation(lat,lng){
  if(!currentUser) return;
  await supa.from('rider_locations').upsert({
    user_id: currentUser.id,
    lat, lng,
    updated_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 60*60*1000).toISOString()
  }, { onConflict:'user_id' });
}

async function removeMyLocation(){
  if(!currentUser) return;
  await supa.from('rider_locations').delete().eq('user_id', currentUser.id);
}

async function loadRiders(){
  const { data: rows } = await supa
    .from('rider_locations_view')
    .select('*')
    .gt('expires_at', new Date().toISOString());

  layers.riders.clearLayers();

  (rows||[]).forEach(r=>{
    if(currentUser && r.user_id===currentUser.id) return;
    if(!r.lat||!r.lng) return;
    const name = r.full_name || r.username || r.email || 'Rider';
    const popup = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${name}</div>
        <div class="rsl-pop-desc">Actif r√©cemment</div>
      </div>`;
    const m = L.marker([r.lat,r.lng],{icon:icons.rider})
      .bindPopup(popup,{closeButton:true});
    m.addTo(layers.riders);
  });
}

shareBtn.addEventListener('click', async ()=>{
  if(!currentUser){
    alert("Connecte-toi pour partager ta position.");
    return;
  }
  if(watchId!==null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    updateShareUi(false,"Partage coup√©");
    await removeMyLocation();
    return;
  }
  if(!navigator.geolocation){
    alert("G√©olocalisation indisponible.");
    return;
  }
  updateShareUi(true,"Partage actif‚Ä¶");
  watchId = navigator.geolocation.watchPosition(async pos=>{
    await upsertMyLocation(pos.coords.latitude, pos.coords.longitude);
  }, err=>{
    console.warn(err);
    updateShareUi(false,"Autorise la g√©oloc");
    watchId = null;
  }, { enableHighAccuracy:true, maximumAge:8000, timeout:15000 });
});

setInterval(loadRiders, 20000);
loadRiders();

window.addEventListener('beforeunload', async ()=>{
  if(watchId!==null){
    try{ navigator.geolocation.clearWatch(watchId); }catch(_){}
    await removeMyLocation();
  }
});

/* Modale Ajouter un spot */
const addModal  = document.getElementById('addSpotModal');
const asType    = document.getElementById('asType');
const asCountry = document.getElementById('asCountry');
const asCanton  = document.getElementById('asCanton');
const asVille   = document.getElementById('asVille');
const asNom     = document.getElementById('asNom');
const asDesc    = document.getElementById('asDesc');
const asLat     = document.getElementById('asLat');
const asLng     = document.getElementById('asLng');
const asMsg     = document.getElementById('asMsg');
const asSaveBtn = document.getElementById('asSave');

document.getElementById('btnAddSpot').onclick = ()=> openAddModal();

function openAddModal(){
  addModal.classList.add('show');
  asMsg.classList.remove('error');
  asMsg.textContent='üìç Utilise le bouton ¬´ Choisir sur une petite carte ¬ª ou clique la grande carte.';
  updateCantonVisibility();
  updateAsSaveState();
}

document.querySelector('#addSpotModal .modal-bg')
  .addEventListener('click',()=>addModal.classList.remove('show'));
document.getElementById('asCancel').onclick = ()=>addModal.classList.remove('show');

function updateCantonVisibility(){
  const isCH = (asCountry.value === 'CH');
  asCanton.parentElement.style.display = isCH ? '' : 'none';
  if(!isCH) asCanton.value = '';
}
asCountry.addEventListener('change', updateCantonVisibility);

function updateAsSaveState(){
  const ok = (asNom.value.trim().length>1 &&
              !!parseFloat(asLat.value) &&
              !!parseFloat(asLng.value));
  asSaveBtn.disabled = !ok;
  asSaveBtn.style.opacity = ok ? '1' : '.6';
}
['input','change'].forEach(ev=>{
  [asNom,asLat,asLng,asCountry,asCanton,asType,asVille,asDesc].forEach(el=>{
    el.addEventListener(ev,updateAsSaveState);
  });
});

/* Cliquer sur la GRANDE carte quand la modale est ouverte */
map.on('click',e=>{
  if(!addModal.classList.contains('show')) return;
  asLat.value = e.latlng.lat.toFixed(6);
  asLng.value = e.latlng.lng.toFixed(6);
  updateAsSaveState();
});

/* Petite carte pour choisir lat/lng + recherche */
const pickModal      = document.getElementById('pickMapModal');
const btnPickLatLng  = document.getElementById('btnPickLatLng');
let pickMap = null;
let pickMarker = null;
const pickSearch    = document.getElementById('pickSearch');
const pickSearchBtn = document.getElementById('pickSearchBtn');

btnPickLatLng.addEventListener('click', ()=>{
  pickModal.classList.add('show');
  setTimeout(()=>{
    if(!pickMap){
      pickMap = L.map('pickMap').setView(map.getCenter(), map.getZoom());
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,
        attribution:'¬© OpenStreetMap'
      }).addTo(pickMap);
      pickMap.on('click', e=>{
        const {lat,lng} = e.latlng;
        if(!pickMarker){
          pickMarker = L.marker([lat,lng],{icon:icons.park}).addTo(pickMap);
        }else{
          pickMarker.setLatLng(e.latlng);
        }
        asLat.value = lat.toFixed(6);
        asLng.value = lng.toFixed(6);
        updateAsSaveState();
      });
    }else{
      pickMap.invalidateSize();
      pickMap.setView(map.getCenter(), map.getZoom());
    }
  },50);
});

async function doPickSearch(){
  const q = (pickSearch.value||'').trim();
  if(!q) return;
  if(!pickMap){
    alert("La carte charge, r√©essaie dans une seconde.");
    return;
  }
  pickSearchBtn.disabled = true;
  const oldTxt = pickSearchBtn.textContent;
  pickSearchBtn.textContent = "‚Ä¶";
  try{
    const resp = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q));
    const data = await resp.json();
    if(!data || !data.length){
      alert("Lieu introuvable.");
      return;
    }
    const {lat, lon} = data[0];
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lon);
    pickMap.setView([latNum,lngNum], 15);
    if(!pickMarker){
      pickMarker = L.marker([latNum,lngNum],{icon:icons.park}).addTo(pickMap);
    }else{
      pickMarker.setLatLng([latNum,lngNum]);
    }
    asLat.value = latNum.toFixed(6);
    asLng.value = lngNum.toFixed(6);
    updateAsSaveState();
  }catch(e){
    console.error(e);
    alert("Recherche impossible pour l'instant.");
  }finally{
    pickSearchBtn.disabled = false;
    pickSearchBtn.textContent = oldTxt;
  }
}

pickSearchBtn.addEventListener('click', doPickSearch);
pickSearch.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    doPickSearch();
  }
});

document.getElementById('pickMapCancel').onclick = ()=> pickModal.classList.remove('show');
document.getElementById('pickMapOk').onclick     = ()=> pickModal.classList.remove('show');
document.querySelector('#pickMapModal .modal-bg')
  .addEventListener('click',()=> pickModal.classList.remove('show'));

/* Envoi du spot */
document.getElementById('asSave').onclick = async ()=>{
  asMsg.classList.remove('error');
  asMsg.textContent = "Envoi‚Ä¶";

  const row = {
    nom:(asNom.value||'').trim(),
    ville:(asVille.value||'').trim(),
    canton:(asCanton.value||'').trim(),
    country:(asCountry.value||'').trim() || (asCanton.value ? 'CH' : 'WORLD'),
    description:(asDesc.value||'').trim(),
    lat: parseFloat(asLat.value),
    lng: parseFloat(asLng.value)
  };

  if(!row.nom || !row.lat || !row.lng){
    asMsg.classList.add('error');
    asMsg.textContent = "Nom + position obligatoires.";
    return;
  }

  try{
    const target = (asType.value==='street') ? 'bunny' : 'spots';
    const { error } = await supa.from(target).insert([row]);
    if(error) throw error;

    const icon = (asType.value==='street') ? icons.street : icons.park;
    const text = `${row.nom} ${row.ville} ${row.canton} ${row.description}`.toLowerCase();
    const popup = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${row.nom}</div>
        <div class="rsl-pop-loc">${row.ville||''} (${row.canton||''})</div>
        <div class="rsl-pop-desc">${row.description||''}</div>
      </div>`;
    const m = L.marker([row.lat,row.lng],{icon})
      .bindPopup(popup,{closeButton:true});
    const g = (asType.value==='street') ? 'street' : 'park';

    ALL_MARKERS.push({
      marker:m,
      group:g,
      canton:row.canton||'',
      country:row.country||'WORLD',
      text
    });
    m.addTo(layers[g]);
    applyFilters();

    asMsg.textContent = "Spot propos√© ‚úÖ";
    setTimeout(()=>addModal.classList.remove('show'),600);
  }catch(ex){
    console.warn(ex);
    asMsg.classList.add('error');
    asMsg.textContent = "Erreur: "+(ex.message||'envoi impossible');
  }
};
</script>

<script>
  // Service worker (PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }
</script>

</body>
</html>