<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>O√π rider ? ‚Äî RIDLY</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#030712;
      --card:#020617;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.08);
      --accent-strong:rgba(34,197,94,.25);
      --text:#f9fafb;
      --text-dim:#9ca3af;
      --border:rgba(148,163,184,.35);
      --radius-xl:18px;
    }

    body.theme-dark{
      --bg:#020617;
      --bg-soft:#030712;
      --card:#020617;
      --text:#f9fafb;
      --text-dim:#9ca3af;
      --border:rgba(148,163,184,.35);
    }
    body.theme-light{
      --bg:#f4f4f5;
      --bg-soft:#e5e7eb;
      --card:#ffffff;
      --text:#020617;
      --text-dim:#6b7280;
      --border:rgba(148,163,184,.25);
    }

    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
    }
    body{
      font-family:"Outfit",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#000;
      color:var(--text);
      display:flex;
      flex-direction:column;
    }

    /* ===== BG VID√âO ===== */
    .rsl-bg-wrap{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
    }
    .rsl-bg-video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
      filter:brightness(.55) saturate(1.05);
    }
    .rsl-bg-dim{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.7));
    }
    body.theme-light .rsl-bg-dim{
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
    }

    .page-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:900px;
      margin:0 auto;
      width:100%;
      position:relative;
      z-index:1;
    }

    /* ===== TOP NAV (style feed + bouton PWA) ===== */
    nav.nav{
      position:sticky;
      top:0;
      z-index:20;
      background:rgba(2,6,23,.9);
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
    }
    body.theme-light nav.nav{
      background:rgba(244,244,245,.95);
    }
    nav.nav .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 14px;
    }

    .nav-left{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      color:var(--text);
    }
    .brand img{
      width:32px;
      height:32px;
      border-radius:12px;
      background:#000;
      padding:3px;
      box-shadow:0 0 12px rgba(34,197,94,.7);
    }
    .brand span{
      font-weight:700;
      letter-spacing:-0.03em;
      font-size:20px;
    }

    .add-btn{
      border:none;
      outline:none;
      width:30px;
      height:30px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
      background:radial-gradient(circle at 30% 20%,#4ade80 0,#22c55e 35%,#16a34a 100%);
      color:#022c16;
      box-shadow:0 10px 22px rgba(34,197,94,.7);
    }
    .add-btn span{
      transform:translateY(-1px);
    }

    .nav-tools{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }
    .icon-btn{
      border:1px solid rgba(15,23,42,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      height:32px;
      min-width:32px;
      padding:0 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
      text-decoration:none;
      position:relative;
      cursor:pointer;
      gap:6px;
    }
    .icon-btn .label{
      font-size:11px;
      font-weight:700;
    }
    @media(max-width:640px){
      .icon-btn .label{display:none}
      .icon-btn{padding:0;min-width:32px;}
    }
    body.theme-light .icon-btn{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.6);
    }
    .icon-btn:hover{
      border-color:var(--accent);
      color:var(--accent);
    }
    .chat-dot{
      position:absolute;
      top:5px;
      right:5px;
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.8);
      opacity:0;
    }

    /* ===== MAIN ===== */
    .main{
      flex:1;
      padding:4px 10px 80px;
    }

    .mini-title{
      padding:8px 4px 4px;
      font-size:13px;
      font-weight:600;
      color:var(--text-dim);
    }

    .hero{
      padding:4px 4px 8px;
      font-size:13px;
      color:var(--text-dim);
      line-height:1.4;
    }
    .hero b{color:var(--text);}

    /* ===== CARTE / CARD ===== */
    .map-card{
      background:var(--card);
      border-radius:var(--radius-xl);
      border:1px solid rgba(15,23,42,.9);
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      padding:10px 10px 12px;
      margin-top:4px;
    }
    body.theme-light .map-card{
      border-color:rgba(209,213,219,.9);
      box-shadow:0 14px 30px rgba(15,23,42,.15);
    }

    .map-wrap{
      position:relative;
    }
    #map{
      width:100%;
      height:70vh;
      min-height:420px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.9);
      background:var(--bg-soft);
      overflow:hidden;
    }
    body.theme-light #map{
      border-color:rgba(17,24,39,.12);
    }
    .leaflet-pane,.leaflet-top,.leaflet-bottom{z-index:2}

    /* ===== Bouton Filtres flottant ===== */
    .filters-fab{
      position:absolute;
      right:10px;
      top:10px;
      z-index:3100;
    }
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      padding:8px 14px;
      font:800 12px Outfit;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.green{
      background:linear-gradient(180deg,var(--accent),#16a34a);
      color:#022c16;
      border:0;
      box-shadow:0 10px 22px rgba(0,0,0,.6);
    }
    body.theme-light .btn{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.6);
      color:#111827;
    }

    .filters-fab .btn{
      background:rgba(0,0,0,0.9)!important;
      border:1px solid #22c55e!important;
      box-shadow:0 0 10px rgba(34,197,94,.5);
    }
    body.theme-light .filters-fab .btn{
      background:#ffffff!important;
      border-color:rgba(15,23,42,.18)!important;
      box-shadow:0 0 10px rgba(0,0,0,.08);
      color:#111827;
    }

    /* ===== Panneau Filtres ===== */
    .filters-wrap{
      position:absolute;
      top:10px;
      right:10px;
      z-index:3000;
      width:min(92%,360px);
      display:none;
    }
    body.show-filters .filters-wrap{display:block;}
    .filters-card{
      background:rgba(0,0,0,.85);
      border:1px solid rgba(148,163,184,.6);
      border-radius:16px;
      padding:10px;
      box-shadow:0 20px 60px rgba(0,0,0,.8);
      backdrop-filter:blur(8px);
      max-height:70vh;
      overflow:auto;
      color:#f9fafb;
    }
    body.theme-light .filters-card{
      background:rgba(255,255,255,.98);
      border-color:rgba(148,163,184,.6);
      box-shadow:0 16px 38px rgba(15,23,42,.18);
      color:#020617;
    }

    .filters-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      padding:8px 10px;
      border-radius:10px;
      font:700 12px Outfit;
    }
    body.theme-light .chip{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.9);
    }
    .chip input{width:16px;height:16px}

    .input,.select{
      width:100%;
      background:#020617;
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text);
      padding:8px 10px;
      font:600 13px Outfit;
    }
    body.theme-light .input,
    body.theme-light .select{
      background:#f3f4f6;
      color:#111827;
      border:1px solid rgba(148,163,184,.6);
    }

    .filters-foot{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    #shareState{
      font:600 11px Outfit;
      color:var(--text-dim);
    }

    /* ===== Popups Leaflet ===== */
    .leaflet-popup-content-wrapper{
      background:rgba(0,0,0,.9);
      border:1px solid rgba(34,197,94,.5);
      border-radius:14px;
      box-shadow:0 30px 60px rgba(0,0,0,.8);
      color:#fff;
    }
    .leaflet-popup-tip{
      background:rgba(0,0,0,.9);
      border:1px solid rgba(34,197,94,.5);
    }
    .leaflet-popup-content{margin:10px;min-width:200px;max-width:240px}
    .rsl-pop-title{font:700 14px/1.25 Outfit}
    .rsl-pop-loc{color:#9aa5b1;font:600 12px/1.3 Outfit;margin:2px 0 6px}
    .rsl-pop-desc{color:#cdd6ff;font:500 12px/1.4 Outfit;margin-bottom:8px}
    .rsl-pop-btn{
      display:inline-block;
      font:800 12px/1.2 Outfit;
      padding:7px 10px;
      border-radius:8px;
      background:linear-gradient(180deg,#22c55e,#16a34a);
      color:#062312;
      text-decoration:none;
    }

    /* ===== Modales ===== */
    .modal{position:fixed;inset:0;z-index:40;display:none}
    .modal.show{display:block}
    .modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
    .modal-card{
      position:relative;
      margin:6vh auto 0;
      max-width:min(92vw,720px);
      background:rgba(8,12,24,.96);
      border:1px solid rgba(148,163,184,.7);
      border-radius:16px;
      padding:14px;
      color:#fff;
    }
    body.theme-light .modal-card{
      background:#ffffff;
      color:#020617;
      border-color:rgba(148,163,184,.7);
    }
    .modal-card h3{margin:2px 0 10px;font-size:18px;font-weight:800}
    .modal .row{display:flex;gap:10px;margin-bottom:8px}
    .modal .row .col{flex:1}
    .modal input,.modal select,.modal textarea{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      background:#020617;
      border:1px solid var(--border);
      color:#fff;
      font:600 14px Outfit;
    }
    body.theme-light .modal input,
    body.theme-light .modal select,
    body.theme-light .modal textarea{
      background:#f3f4f6;
      color:#020617;
      border-color:rgba(148,163,184,.6);
    }
    .modal textarea{min-height:82px;resize:vertical}
    .modal .actions{
      display:flex;gap:8px;justify-content:flex-end;
      margin-top:10px;
    }
    #asMsg{font:700 12px;color:#7cffb0}
    #asMsg.error{color:#ff9f9f}
    @media(max-width:520px){ .modal .row{flex-direction:column} }

    /* ===== TABBAR (comme feed) ===== */
    .tabbar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      z-index:30;
      border-top:1px solid var(--border);
      background:rgba(2,6,23,.97);
      backdrop-filter:blur(18px);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:6px 8px 10px;
    }
    body.theme-light .tabbar{
      background:rgba(244,244,245,.97);
    }

    .tab{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      text-decoration:none;
      color:var(--text-dim);
      font-size:9px;
      letter-spacing:.04em;
      text-transform:uppercase;
      padding:4px 0;
    }
    .tab .ic{
      font-size:20px;
      line-height:1;
    }
    .tab.active{
      color:var(--accent);
    }

    @media(min-width:700px){
      nav.nav .row{
        padding-inline:20px;
      }
      .main{
        padding-inline:14px;
      }
      .tabbar{
        border-radius:22px 22px 0 0;
      }
    }
  </style>
</head>
<body class="theme-dark">

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<div class="page-wrap">

  <!-- NAV TOP (style feed + PWA) -->
  <nav class="nav">
    <div class="row">
      <div class="nav-left">
        <a class="brand" href="ou_rider.html">
          <img src="image/1logo_ridly.png" alt="RIDLY"/>
          <span>RIDLY</span>
        </a>
        <button type="button" class="add-btn" onclick="window.location.href='ajouter.html'" title="Nouveau post">
          <span>+</span>
        </button>
      </div>
      <div class="nav-tools">
        <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">
          üåô
        </button>
        <button type="button" class="icon-btn" id="btnPwa" title="Installer l'app RIDLY">
          üì≤ <span class="label">App</span>
        </button>
        <a href="chat.html" class="icon-btn" id="btnChat" title="Chat riders">
          <span class="chat-dot" id="chatDot"></span>
          üí¨
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENU PRINCIPAL -->
  <main class="main">
    <div class="mini-title">O√π rider ?</div>
    <div class="hero">
      Carte des <b>skateparks</b>, <b>street spots</b>, <b>shops partenaires</b> et <b>lieux de cours RSL</b>.<br>
      Partage ta position, ou ajoute ton propre spot.
    </div>

    <section class="map-card">
      <div class="map-wrap">

        <!-- bouton filtres -->
        <div class="filters-fab">
          <button id="btnToggleFilters" class="btn">Filtres</button>
        </div>

        <!-- panneau filtres -->
        <div class="filters-wrap" id="filtersWrap">
          <div class="filters-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <b style="font:800 13px Outfit">Filtres</b>
              <button id="btnCloseFilters" class="btn" style="padding:4px 10px">‚úï</button>
            </div>

            <div class="filters-grid" style="margin-top:8px">
              <label class="chip"><input type="checkbox" id="f-park" checked/> Parks</label>
              <label class="chip"><input type="checkbox" id="f-street" checked/> Street</label>
              <label class="chip"><input type="checkbox" id="f-shop" checked/> Shops</label>
              <label class="chip"><input type="checkbox" id="f-cours" checked/> Cours</label>

              <select id="f-country" class="select">
                <option value="">Pays (tous)</option>
                <option value="CH">Suisse</option>
                <option value="FR">France</option>
                <option value="DE">Allemagne</option>
                <option value="EU">Autres Europe</option>
                <option value="WORLD">Monde</option>
              </select>

              <select id="f-canton" class="select"><option value="">Canton (CH)</option></select>

              <input id="f-type" class="input" placeholder="Type/texte (bowl, pumptrack, rail‚Ä¶)" />
            </div>

            <div class="filters-foot">
              <button id="btnReset" class="btn">R√©initialiser</button>
              <button id="btnLocate" class="btn green">üìç Ma position</button>
              <button id="btnShare" class="btn green" title="Partage ta position avec les riders">Partage riders</button>
              <span id="shareState"></span>
              <button id="btnAddSpot" class="btn green" style="margin-left:auto">‚ûï Ajouter un spot</button>
            </div>
          </div>
        </div>

        <div id="map"></div>
      </div>
    </section>
  </main>
</div>

<!-- Modale Ajouter un spot -->
<div class="modal" id="addSpotModal">
  <div class="modal-bg"></div>
  <div class="modal-card">
    <h3>Proposer un nouveau spot</h3>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Type</label>
        <select id="asType">
          <option value="park">Skatepark / Pumptrack</option>
          <option value="street">Street spot</option>
        </select>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Pays</label>
        <select id="asCountry">
          <option value="CH">Suisse</option>
          <option value="FR">France</option>
          <option value="DE">Allemagne</option>
          <option value="EU">Autres Europe</option>
          <option value="WORLD">Monde</option>
        </select>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Canton (CH)</label>
        <select id="asCanton">
          <option value="">‚Äî</option>
          <option>AG</option><option>AI</option><option>AR</option><option>BE</option><option>BL</option>
          <option>BS</option><option>FR</option><option>GE</option><option>GL</option><option>GR</option>
          <option>JU</option><option>LU</option><option>NE</option><option>NW</option><option>OW</option>
          <option>SG</option><option>SH</option><option>SO</option><option>SZ</option><option>TG</option>
          <option>TI</option><option>UR</option><option>VD</option><option>VS</option><option>ZG</option>
          <option>ZH</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Ville</label>
        <input id="asVille" placeholder="Ville"/>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Nom du spot</label>
        <input id="asNom" placeholder="Nom du spot"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Description</label>
        <textarea id="asDesc" placeholder="Courte description (type, modules, niveau...)"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Latitude</label>
        <input id="asLat" placeholder="Clique la carte ou le bouton"/>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Longitude</label>
        <input id="asLng" placeholder="Clique la carte ou le bouton"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <button type="button" class="btn" id="btnPickLatLng" style="width:100%">üìç Choisir sur une petite carte</button>
        <div style="font-size:12px;color:#22c55e;margin-top:4px">
          Tu peux aussi cliquer directement sur la grande carte pour remplir lat / lng.
        </div>
      </div>
    </div>

    <div class="actions">
      <span id="asMsg"></span>
      <button type="button" class="btn" id="asCancel">Annuler</button>
      <button type="button" class="btn green" id="asSave">Envoyer</button>
    </div>
  </div>
</div>

<!-- Modale petite carte pour choisir lat/lng -->
<div class="modal" id="pickMapModal">
  <div class="modal-bg"></div>
  <div class="modal-card" style="max-width:min(92vw,500px);">
    <h3>Choisir l‚Äôemplacement</h3>
    <p style="font-size:13px;margin-top:0;margin-bottom:8px">
      Clique sur la carte pour placer le spot. Les champs latitude / longitude se remplissent automatiquement.
    </p>

    <div class="row">
      <div class="col">
        <input id="pickSearch" placeholder="Recherche ville / spot (ex: Bulle)">
      </div>
      <button type="button" class="btn" id="pickSearchBtn" style="white-space:nowrap">Rechercher</button>
    </div>

    <div id="pickMap" style="height:320px;border-radius:12px;overflow:hidden;border:1px solid rgba(148,163,184,.6);"></div>
    <div class="actions" style="margin-top:10px">
      <button type="button" class="btn" id="pickMapCancel">Annuler</button>
      <button type="button" class="btn green" id="pickMapOk">OK</button>
    </div>
  </div>
</div>

<!-- TABBAR -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab active" href="ou_rider.html" title="Spots">
    <div class="ic">üìç</div><span>Spots</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Search</span>
  </a>
  <a class="tab" href="games.html" title="Games">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Rank</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<script>
/* ===== Th√®me clair/sombre (m√™me logique que feed) ===== */
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => {
    const isLight = document.body.classList.contains('theme-light');
    btnTheme.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  };
  updateIcon();

  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<script>
/* ===== Supabase init + auth ===== */
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let currentUser = null;

(async function(){
  try{
    const { data:{ user } } = await supa.auth.getUser();
    if(!user){
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    const dot = document.getElementById('chatDot');
    if(dot) dot.style.opacity = 1;
  }catch(e){
    console.error(e);
    window.location.href = 'index.html';
  }
})();
</script>

<script>
/* ===== BG vid√©o ===== */
(function(){
  const v = document.getElementById('rslBg');
  if(!v) return;
  const s = document.createElement('source');
  s.src = SUPABASE_URL + "/storage/v1/object/public/ridly/ridly.mp4";
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{
    try{
      v.playbackRate = 0.6;
      const p = v.play();
      if(p && p.catch) p.catch(()=>{});
    }catch(e){}
  };
  play();
  document.addEventListener('visibilitychange',()=>{
    document.hidden ? v.pause() : play();
  });
})();
</script>

<script>
/* ===== PWA : bouton qui lance directement le prompt d'install quand dispo ===== */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredInstallPrompt = e;
});

const btnPwa = document.getElementById('btnPwa');
if(btnPwa){
  btnPwa.addEventListener('click', async ()=>{
    // Si le navigateur permet l'installation, on d√©clenche DIRECT le prompt
    if(deferredInstallPrompt){
      deferredInstallPrompt.prompt();
      try{
        await deferredInstallPrompt.userChoice;
      }catch(e){}
      deferredInstallPrompt = null;
    }else{
      // Fallback : message pour iOS / cas o√π le prompt n'est pas dispo
      alert("Pour installer RIDLY, utilise ¬´ Ajouter √† l'√©cran d'accueil ¬ª dans ton navigateur.");
    }
  });
}
</script>

<script>
/* ===== Carte / filtres / donn√©es / partage riders / ajout spot ===== */

let map = L.map('map').setView([46.8, 8.2], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'¬© OpenStreetMap'
}).addTo(map);

const mk = (bg, emoji='üõπ') => L.divIcon({
  className:'rsl-marker',
  html:`<div style="width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${bg};border:2px solid #fff;color:#fff;font-size:18px">${emoji}</div>`,
  iconSize:[34,34], iconAnchor:[17,17]
});
const icons = {
  park:  mk('#7c3aed','üõπ'),
  street:mk('#f97316','üß±'),
  shop:  mk('#ef4444','üè™'),
  int:   mk('#16a34a','üè´'),
  ext:   mk('#0ea5e9','üõº'),
  rider: mk('#06b6d4','üë§')
};

const layers = {
  park:L.layerGroup().addTo(map),
  street:L.layerGroup().addTo(map),
  shop:L.layerGroup().addTo(map),
  int:L.layerGroup().addTo(map),
  ext:L.layerGroup().addTo(map),
  riders:L.layerGroup().addTo(map)
};

const ALL_MARKERS = []; // {marker, group, canton, country, text}

/* Filtres UI */
const bodyEl = document.body;
document.getElementById('btnToggleFilters').onclick = ()=> bodyEl.classList.toggle('show-filters');
document.getElementById('btnCloseFilters').onclick  = ()=> bodyEl.classList.remove('show-filters');
document.addEventListener('keydown',e=>{ if(e.key==='Escape') bodyEl.classList.remove('show-filters'); });

const F = {
  park:   document.getElementById('f-park'),
  street: document.getElementById('f-street'),
  shop:   document.getElementById('f-shop'),
  cours:  document.getElementById('f-cours'),
  country:document.getElementById('f-country'),
  canton: document.getElementById('f-canton'),
  type:   document.getElementById('f-type'),
  reset:  document.getElementById('btnReset'),
  locate: document.getElementById('btnLocate')
};

function applyFilters(){
  const show = {
    park:F.park.checked,
    street:F.street.checked,
    shop:F.shop.checked,
    int:F.cours.checked,
    ext:F.cours.checked
  };
  const cantonSel  = (F.canton.value||'').trim();
  const countrySel = (F.country.value||'').trim();
  const txt        = (F.type.value||'').trim().toLowerCase();

  ALL_MARKERS.forEach(o=>{
    let vis = !!show[o.group] || o.group==='riders';
    if(vis && countrySel && o.group!=='riders') vis = (o.country||'')===countrySel;
    if(vis && cantonSel && o.group!=='riders') vis = (o.canton||'')===cantonSel;
    if(vis && txt && o.group!=='riders') vis = (o.text||'').includes(txt);

    if(vis){
      if(!map.hasLayer(o.marker)) o.marker.addTo(layers[o.group]);
    }else{
      if(map.hasLayer(o.marker)) layers[o.group].removeLayer(o.marker);
    }
  });
}

['change','input'].forEach(ev=>{
  [F.park,F.street,F.shop,F.cours,F.country,F.canton,F.type].forEach(el=>{
    el.addEventListener(ev,applyFilters);
  });
});

F.reset.onclick = ()=>{
  F.park.checked = F.street.checked = F.shop.checked = F.cours.checked = true;
  F.country.value = '';
  F.canton.value  = '';
  F.type.value    = '';
  applyFilters();
};

F.locate.onclick = ()=>{
  if(!navigator.geolocation){ alert('G√©olocalisation indisponible.'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    L.circleMarker([latitude,longitude],{
      radius:6,color:'#38bdf8',fillColor:'#38bdf8',fillOpacity:.9,weight:2
    }).addTo(map);
    map.setView([latitude,longitude],14);
  },()=>alert("Impossible d'obtenir ta position."));
};

/* Donn√©es Supabase (shops / parks / street / cours) */
(async function loadData(){
  // shops
  let { data: shops } = await supa.from('shops').select('*');
  (shops||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Shop'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description||''}</div>
        ${s.site?`<a class="rsl-pop-btn" href="${s.site}" target="_blank" rel="noopener">Site du shop ‚Üí</a>`:''}
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.shop})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:'shop',
      canton:s.canton||'',
      country:s.country||'CH',
      text:`${s.nom||''} ${s.ville||''} ${s.description||''}`.toLowerCase()
    });
    m.addTo(layers.shop);
  });

  // parks
  let { data: parks } = await supa.from('spots').select('*');
  (parks||[]).forEach(p=>{
    if(!p.lat||!p.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${p.nom||'Spot'}</div>
        <div class="rsl-pop-loc">${p.ville||''} (${p.canton||''})</div>
        <div class="rsl-pop-desc">${p.description ? p.description : (p.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${p.id}" onclick="window.location.href='spot.html?id=${p.id}';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([p.lat,p.lng],{icon:icons.park})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${p.nom||''} ${p.ville||''} ${p.canton||''} ${p.type||''} ${p.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'park',
      canton:p.canton||'',
      country:p.country||'CH',
      text
    });
    m.addTo(layers.park);
  });

  // street
  let { data: streets } = await supa.from('bunny').select('*');
  (streets||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Street spot'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description ? s.description : (s.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${s.id}&street=1" onclick="window.location.href='spot.html?id=${s.id}&street=1';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.street})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${s.nom||''} ${s.ville||''} ${s.canton||''} ${s.type||''} ${s.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'street',
      canton:s.canton||'',
      country:s.country||'CH',
      text
    });
    m.addTo(layers.street);
  });

  // lieux de cours
  [
    {group:'int',  n:'Cours RSL ‚Äî Montreux (indoor)', lat:46.433, lng:6.910, desc:'Session encadr√©e en int√©rieur'},
    {group:'int',  n:'Cours RSL ‚Äî Lausanne (La Fi√®vre)', lat:46.536, lng:6.626, desc:'Cours en salle / rampes / park'},
    {group:'ext',  n:'Cours RSL ‚Äî Vidy', lat:46.523, lng:6.610, desc:'En ext√©rieur, bord du lac'},
  ].forEach(c=>{
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${c.n}</div>
        <div class="rsl-pop-desc">${c.desc||''}</div>
        <a class="rsl-pop-btn" href="cours.html">Infos cours ‚Üí</a>
      </div>`;
    const m = L.marker([c.lat,c.lng],{icon:icons[c.group]})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:c.group,
      canton:'',
      country:'CH',
      text:(c.n+' '+(c.desc||'')).toLowerCase()
    });
    m.addTo(layers[c.group]);
  });

  // cantons
  const cantons = new Set();
  ALL_MARKERS.forEach(o=>{ if(o.country==='CH' && o.canton) cantons.add(o.canton); });
  document.getElementById('f-canton').innerHTML =
    '<option value="">Canton (CH)</option>' +
    Array.from(cantons).sort().map(c=>`<option value="${c}">${c}</option>`).join('');

  applyFilters();
})();

/* Partage position riders */
let watchId = null;
const shareBtn   = document.getElementById('btnShare');
const shareState = document.getElementById('shareState');

function updateShareUi(active, hint){
  if(active){
    shareBtn.classList.remove('green');
    shareBtn.textContent = 'Stop partage';
  }else{
    shareBtn.classList.add('green');
    shareBtn.textContent = 'Partage riders';
  }
  if(hint!==undefined) shareState.textContent = hint || "";
}

async function upsertMyLocation(lat,lng){
  if(!currentUser) return;
  await supa.from('rider_locations').upsert({
    user_id: currentUser.id,
    lat, lng,
    updated_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 60*60*1000).toISOString()
  }, { onConflict:'user_id' });
}

async function removeMyLocation(){
  if(!currentUser) return;
  await supa.from('rider_locations').delete().eq('user_id', currentUser.id);
}

async function loadRiders(){
  const { data: rows } = await supa
    .from('rider_locations_view')
    .select('*')
    .gt('expires_at', new Date().toISOString());

  layers.riders.clearLayers();

  (rows||[]).forEach(r=>{
    if(currentUser && r.user_id===currentUser.id) return;
    if(!r.lat||!r.lng) return;
    const name = r.full_name || r.username || r.email || 'Rider';
    const popup = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${name}</div>
        <div class="rsl-pop-desc">Actif r√©cemment</div>
      </div>`;
    const m = L.marker([r.lat,r.lng],{icon:icons.rider})
      .bindPopup(popup,{closeButton:true});
    m.addTo(layers.riders);
  });
}

shareBtn.addEventListener('click', async ()=>{
  if(!currentUser){
    alert("Connecte-toi pour partager ta position.");
    return;
  }
  if(watchId!==null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    updateShareUi(false,"Partage coup√©");
    await removeMyLocation();
    return;
  }
  if(!navigator.geolocation){
    alert("G√©olocalisation indisponible.");
    return;
  }
  updateShareUi(true,"Partage actif‚Ä¶");
  watchId = navigator.geolocation.watchPosition(async pos=>{
    await upsertMyLocation(pos.coords.latitude, pos.coords.longitude);
  }, err=>{
    console.warn(err);
    updateShareUi(false,"Autorise la g√©oloc");
    watchId = null;
  }, { enableHighAccuracy:true, maximumAge:8000, timeout:15000 });
});

setInterval(loadRiders, 20000);
loadRiders();

window.addEventListener('beforeunload', async ()=>{
  if(watchId!==null){
    try{ navigator.geolocation.clearWatch(watchId); }catch(_){}
    await removeMyLocation();
  }
});

/* Modale Ajouter un spot */
const addModal  = document.getElementById('addSpotModal');
const asType    = document.getElementById('asType');
const asCountry = document.getElementById('asCountry');
const asCanton  = document.getElementById('asCanton');
const asVille   = document.getElementById('asVille');
const asNom     = document.getElementById('asNom');
const asDesc    = document.getElementById('asDesc');
const asLat     = document.getElementById('asLat');
const asLng     = document.getElementById('asLng');
const asMsg     = document.getElementById('asMsg');
const asSaveBtn = document.getElementById('asSave');

document.getElementById('btnAddSpot').onclick = ()=> openAddModal();

function openAddModal(){
  addModal.classList.add('show');
  asMsg.classList.remove('error');
  asMsg.textContent='üìç Utilise la petite carte ou clique la grande carte.';
  updateCantonVisibility();
  updateAsSaveState();
}

document.querySelector('#addSpotModal .modal-bg')
  .addEventListener('click',()=>addModal.classList.remove('show'));
document.getElementById('asCancel').onclick = ()=>addModal.classList.remove('show');

function updateCantonVisibility(){
  const isCH = (asCountry.value === 'CH');
  asCanton.parentElement.style.display = isCH ? '' : 'none';
  if(!isCH) asCanton.value = '';
}
asCountry.addEventListener('change', updateCantonVisibility);

function updateAsSaveState(){
  const ok = (asNom.value.trim().length>1 &&
              !!parseFloat(asLat.value) &&
              !!parseFloat(asLng.value));
  asSaveBtn.disabled = !ok;
  asSaveBtn.style.opacity = ok ? '1' : '.6';
}
['input','change'].forEach(ev=>{
  [asNom,asLat,asLng,asCountry,asCanton,asType,asVille,asDesc].forEach(el=>{
    el.addEventListener(ev,updateAsSaveState);
  });
});

/* Clic sur la grande carte pour lat/lng */
map.on('click',e=>{
  if(!addModal.classList.contains('show')) return;
  asLat.value = e.latlng.lat.toFixed(6);
  asLng.value = e.latlng.lng.toFixed(6);
  updateAsSaveState();
});

/* Petite carte pour choisir lat/lng + recherche */
const pickModal      = document.getElementById('pickMapModal');
const btnPickLatLng  = document.getElementById('btnPickLatLng');
let pickMap = null;
let pickMarker = null;
const pickSearch    = document.getElementById('pickSearch');
const pickSearchBtn = document.getElementById('pickSearchBtn');

btnPickLatLng.addEventListener('click', ()=>{
  pickModal.classList.add('show');
  setTimeout(()=>{
    if(!pickMap){
      pickMap = L.map('pickMap').setView(map.getCenter(), map.getZoom());
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,
        attribution:'¬© OpenStreetMap'
      }).addTo(pickMap);
      pickMap.on('click', e=>{
        const {lat,lng} = e.latlng;
        if(!pickMarker){
          pickMarker = L.marker([lat,lng],{icon:icons.park}).addTo(pickMap);
        }else{
          pickMarker.setLatLng(e.latlng);
        }
        asLat.value = lat.toFixed(6);
        asLng.value = lng.toFixed(6);
        updateAsSaveState();
      });
    }else{
      pickMap.invalidateSize();
      pickMap.setView(map.getCenter(), map.getZoom());
    }
  },50);
});

async function doPickSearch(){
  const q = (pickSearch.value||'').trim();
  if(!q) return;
  if(!pickMap){
    alert("La carte charge, r√©essaie dans une seconde.");
    return;
  }
  pickSearchBtn.disabled = true;
  const oldTxt = pickSearchBtn.textContent;
  pickSearchBtn.textContent = "‚Ä¶";
  try{
    const resp = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q));
    const data = await resp.json();
    if(!data || !data.length){
      alert("Lieu introuvable.");
      return;
    }
    const {lat, lon} = data[0];
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lon);
    pickMap.setView([latNum,lngNum], 15);
    if(!pickMarker){
      pickMarker = L.marker([latNum,lngNum],{icon:icons.park}).addTo(pickMap);
    }else{
      pickMarker.setLatLng([latNum,lngNum]);
    }
    asLat.value = latNum.toFixed(6);
    asLng.value = lngNum.toFixed(6);
    updateAsSaveState();
  }catch(e){
    console.error(e);
    alert("Recherche impossible pour l'instant.");
  }finally{
    pickSearchBtn.disabled = false;
    pickSearchBtn.textContent = oldTxt;
  }
}

pickSearchBtn.addEventListener('click', doPickSearch);
pickSearch.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    doPickSearch();
  }
});

document.getElementById('pickMapCancel').onclick = ()=> pickModal.classList.remove('show');
document.getElementById('pickMapOk').onclick     = ()=> pickModal.classList.remove('show');
document.querySelector('#pickMapModal .modal-bg')
  .addEventListener('click',()=> pickModal.classList.remove('show'));

/* Envoi du spot */
document.getElementById('asSave').onclick = async ()=>{
  asMsg.classList.remove('error');
  asMsg.textContent = "Envoi‚Ä¶";

  const row = {
    nom:(asNom.value||'').trim(),
    ville:(asVille.value||'').trim(),
    canton:(asCanton.value||'').trim(),
    country:(asCountry.value||'').trim() || (asCanton.value ? 'CH' : 'WORLD'),
    description:(asDesc.value||'').trim(),
    lat: parseFloat(asLat.value),
    lng: parseFloat(asLng.value)
  };

  if(!row.nom || !row.lat || !row.lng){
    asMsg.classList.add('error');
    asMsg.textContent = "Nom + position obligatoires.";
    return;
  }

  try{
    const target = (asType.value==='street') ? 'bunny' : 'spots';
    const { error } = await supa.from(target).insert([row]);
    if(error) throw error;

    const icon = (asType.value==='street') ? icons.street : icons.park;
    const text = `${row.nom} ${row.ville} ${row.canton} ${row.description}`.toLowerCase();
    const popup = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${row.nom}</div>
        <div class="rsl-pop-loc">${row.ville||''} (${row.canton||''})</div>
        <div class="rsl-pop-desc">${row.description||''}</div>
      </div>`;
    const m = L.marker([row.lat,row.lng],{icon})
      .bindPopup(popup,{closeButton:true});
    const g = (asType.value==='street') ? 'street' : 'park';

    ALL_MARKERS.push({
      marker:m,
      group:g,
      canton:row.canton||'',
      country:row.country||'WORLD',
      text
    });
    m.addTo(layers[g]);
    applyFilters();

    asMsg.textContent = "Spot propos√© ‚úÖ";
    setTimeout(()=>addModal.classList.remove('show'),600);
  }catch(ex){
    console.warn(ex);
    asMsg.classList.add('error');
    asMsg.textContent = "Erreur: "+(ex.message||'envoi impossible');
  }
};
</script>

<script>
  // Service worker (PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }
</script>

</body>
</html>
