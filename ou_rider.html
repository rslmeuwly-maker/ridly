<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>O√π rider ? ‚Äî RIDLY</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">

  <!-- Ic√¥nes PWA / mobile -->
  <link rel="icon" type="image/png" sizes="192x192" href="image/1logo_ridly.png">
  <link rel="apple-touch-icon" href="image/1logo_ridly.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#030712;
      --card:#020617;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.08);
      --accent-strong:rgba(34,197,94,.25);
      --text:#f9fafb;
      --text-dim:#9ca3af;
      --border:rgba(148,163,184,.35);
      --radius-xl:18px;
    }
    body.theme-dark{
      --bg:#020617;--bg-soft:#030712;--card:#020617;
      --text:#f9fafb;--text-dim:#9ca3af;--border:rgba(148,163,184,.35);
    }
    body.theme-light{
      --bg:#f4f4f5;--bg-soft:#e5e7eb;--card:#ffffff;
      --text:#020617;--text-dim:#6b7280;--border:rgba(148,163,184,.25);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:"Outfit",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#000;
      color:var(--text);
      display:flex;
      flex-direction:column;
    }

    /* BG vid√©o */
    .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
    .rsl-bg-video{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;
      filter:brightness(.55) saturate(1.05);
    }
    .rsl-bg-dim{
      position:absolute;inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.7));
    }
    body.theme-light .rsl-bg-dim{
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
    }

    .page-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:900px;
      margin:0 auto;
      width:100%;
      position:relative;
      z-index:1;
    }

    /* NAV */
    nav.nav{
      position:sticky;top:0;z-index:20;
      background:rgba(2,6,23,.9);
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
    }
    body.theme-light nav.nav{background:rgba(244,244,245,.95)}
    nav.nav .row{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 14px;
    }
    .nav-left{display:flex;align-items:center;gap:8px}
    .brand{
      display:flex;align-items:center;gap:8px;
      text-decoration:none;color:var(--text);
    }
    .brand img{
      width:32px;height:32px;border-radius:12px;
      background:#000;padding:3px;
      box-shadow:0 0 12px rgba(34,197,94,.7);
    }
    .brand span{font-weight:700;letter-spacing:-0.03em;font-size:20px}
    .add-btn{
      border:none;outline:none;
      width:30px;height:30px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-size:20px;font-weight:700;
      cursor:pointer;
      background:radial-gradient(circle at 30% 20%,#4ade80 0,#22c55e 35%,#16a34a 100%);
      color:#022c16;
      box-shadow:0 10px 22px rgba(34,197,94,.7);
    }
    .add-btn span{transform:translateY(-1px)}
    .nav-tools{display:flex;align-items:center;gap:8px;margin-left:auto}
    .icon-btn{
      border:1px solid rgba(15,23,42,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      height:32px;min-width:32px;
      padding:0 10px;
      display:flex;align-items:center;justify-content:center;
      font-size:15px;text-decoration:none;
      position:relative;cursor:pointer;gap:6px;
    }
    .icon-btn .label{font-size:11px;font-weight:700}
    @media(max-width:640px){
      .icon-btn .label{display:none}
      .icon-btn{padding:0;min-width:32px}
    }
    body.theme-light .icon-btn{background:#e5e7eb;border-color:rgba(148,163,184,.6)}
    .icon-btn:hover{border-color:var(--accent);color:var(--accent)}
    .badge{
      position:absolute;top:-3px;right:-3px;
      min-width:18px;height:18px;border-radius:999px;
      background:#ef4444;color:#f9fafb;font-size:10px;font-weight:800;
      display:none;align-items:center;justify-content:center;
      padding:0 4px;box-shadow:0 0 8px rgba(0,0,0,.6);
    }

    .toast{
      position:fixed;left:50%;top:60px;transform:translateX(-50%);
      background:rgba(15,23,42,.97);color:#f9fafb;
      padding:8px 14px;border-radius:999px;
      font-size:12px;font-weight:700;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      opacity:0;pointer-events:none;
      transition:opacity .2s, transform .2s;
      z-index:60;max-width:90%;text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(4px)}

    .main{flex:1;padding:4px 10px 80px}
    .mini-title{padding:8px 4px 4px;font-size:13px;font-weight:600;color:var(--text-dim)}
    .hero{padding:4px 4px 8px;font-size:13px;color:var(--text-dim);line-height:1.4}
    .hero b{color:var(--text)}

    .map-card{
      background:var(--card);
      border-radius:var(--radius-xl);
      border:1px solid rgba(15,23,42,.9);
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      padding:10px 10px 12px;
      margin-top:4px;
    }
    body.theme-light .map-card{
      border-color:rgba(209,213,219,.9);
      box-shadow:0 14px 30px rgba(15,23,42,.15);
    }
    .map-wrap{position:relative}
    #map{
      width:100%;
      height:70vh;
      min-height:420px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.9);
      background:var(--bg-soft);
      overflow:hidden;
    }
    body.theme-light #map{border-color:rgba(17,24,39,.12)}
    .leaflet-pane,.leaflet-top,.leaflet-bottom{z-index:2}

    /* bouton filtres mobile (cach√© partout, juste pour le JS) */
    .filters-fab{
      position:absolute;
      left:10px;top:10px;
      z-index:3100;
      display:none;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      padding:8px 14px;
      font:800 12px Outfit;
      cursor:pointer;white-space:nowrap;
    }
    .btn.green{
      background:linear-gradient(180deg,var(--accent),#16a34a);
      color:#022c16;border:0;
      box-shadow:0 10px 22px rgba(0,0,0,.6);
    }
    body.theme-light .btn{
      background:#e5e7eb;border-color:rgba(148,163,184,.6);color:#111827;
    }

    .filters-wrap{
      position:absolute;
      top:10px;left:10px;right:10px;
      z-index:3000;
      width:auto;
      display:none;
    }
    body.show-filters .filters-wrap{display:block}
    .filters-card{
      background:rgba(0,0,0,.88);
      border:1px solid rgba(148,163,184,.6);
      border-radius:16px;padding:10px;
      box-shadow:0 20px 60px rgba(0,0,0,.8);
      backdrop-filter:blur(8px);
      max-height:70vh;overflow:auto;
      color:#f9fafb;
    }
    body.theme-light .filters-card{
      background:#fff;color:#020617;
      border-color:rgba(148,163,184,.6);
      box-shadow:0 16px 38px rgba(15,23,42,.18);
    }

    .filters-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;margin-top:8px;
    }
    .chip{
      display:flex;align-items:center;gap:8px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      padding:8px 10px;border-radius:10px;
      font:700 12px Outfit;
    }
    body.theme-light .chip{
      background:#e5e7eb;border-color:rgba(148,163,184,.9);
    }
    .chip input{width:16px;height:16px}

    .input,.select{
      width:100%;
      background:#020617;
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text);
      padding:8px 10px;
      font:600 13px Outfit;
    }
    body.theme-light .input,
    body.theme-light .select{
      background:#f3f4f6;color:#111827;
      border:1px solid rgba(148,163,184,.6);
    }

    .filters-foot{
      display:flex;flex-wrap:wrap;
      gap:8px;margin-top:10px;align-items:center;
    }
    #shareState{font:600 11px Outfit;color:var(--text-dim)}

    .leaflet-popup-content-wrapper{
      background:rgba(0,0,0,.9);
      border:1px solid rgba(34,197,94,.5);
      border-radius:14px;
      box-shadow:0 30px 60px rgba(0,0,0,.8);
      color:#fff;
    }
    .leaflet-popup-tip{
      background:rgba(0,0,0,.9);
      border:1px solid rgba(34,197,94,.5);
    }
    .leaflet-popup-content{margin:10px;min-width:200px;max-width:240px}
    .rsl-pop-title{font:700 14px/1.25 Outfit}
    .rsl-pop-loc{color:#9aa5b1;font:600 12px/1.3 Outfit;margin:2px 0 6px}
    .rsl-pop-desc{color:#cdd6ff;font:500 12px/1.4 Outfit;margin-bottom:8px}
    .rsl-pop-btn{
      display:inline-block;
      font:800 12px/1.2 Outfit;
      padding:7px 10px;border-radius:8px;
      background:linear-gradient(180deg,#22c55e,#16a34a);
      color:#062312;text-decoration:none;
    }

    .chips-row{
      position:absolute;
      left:50%;
      top:16px;
      transform:translateX(-50%);
      display:flex;
      gap:8px;
      z-index:3100;
      pointer-events:none;
      padding:0 8px;
      max-width:100%;
      overflow-x:auto;
      scrollbar-width:none;
    }
    .chips-row::-webkit-scrollbar{display:none}
    .chip-float{
      pointer-events:auto;
      border-radius:14px;
      padding:8px 14px;
      font:800 14px Outfit;
      border:1px solid rgba(0,0,0,.18);
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      flex:0 0 auto;
      white-space:nowrap;
    }
    .chip-blue{background:#e5f0ff;color:#0f3b82}
    .chip-green{background:#e9fde9;color:#0d5b1f}
    .chip-red{background:#ffe9e9;color:#7c1010}
    .chip-orange{background:#fff2e6;color:#7a2e00;border:1px solid rgba(0,0,0,.08);box-shadow:0 6px 16px rgba(0,0,0,.25)}

    @media (max-width:600px){
      .chips-row{
        left:0;
        right:0;
        transform:none;
        top:10px;
        justify-content:flex-start;
      }
      .chip-float{
        padding:6px 10px;
        font-size:12px;
      }
    }

    /* Bouton style de carte + tip */
    .fab-style{
      position:absolute;
      left:10px;
      bottom:20px;
      z-index:3200;
      width:46px;
      height:46px;
      border-radius:999px;
      cursor:pointer;
      border:1px solid rgba(0,0,0,.18);
      background:#ffffff;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 26px rgba(0,0,0,.22);
    }
    body.theme-dark .fab-style{
      background:#0b1220;
      color:#fff;
      border-color:rgba(148,163,184,.35);
    }

    .mapstyle-tip{
      position:absolute;
      left:70px;
      bottom:28px;
      z-index:3200;
      background:#fff;
      color:#0f172a;
      border-radius:999px;
      padding:8px 12px;
      font:800 12px Outfit;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      display:none;
    }
    body.theme-dark .mapstyle-tip{
      background:rgba(2,6,23,.98);
      color:#fff;
      border-color:rgba(148,163,184,.35);
    }

    /* Raccourcis verticaux fa√ßon ‚Äúic√¥nes app‚Äù */
    .side-actions{
      position:absolute;
      right:10px;
      top:130px;
      z-index:3300;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .side-btn{
      position:relative;
      width:44px;height:44px;
      border-radius:16px;
      border:none;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.45);
      color:#02130a;
      font-size:22px;
      transition:transform .15s ease, box-shadow .15s ease;
    }

    .side-btn span{
      display:inline-block;
      transform:translateY(-1px);
      animation:spinIcon 20s infinite ease-in-out;
    }
    @keyframes spinIcon{
      0%,5%{
        transform:translateY(-1px) rotate(0deg);
      }
      10%{
        transform:translateY(-1px) rotate(360deg);
      }
      100%{
        transform:translateY(-1px) rotate(360deg);
      }
    }

    .side-btn:active{
      transform:scale(.94);
      box-shadow:0 4px 14px rgba(0,0,0,.4);
    }
    .side-btn::after{
      content:attr(data-label);
      position:absolute;
      right:110%;
      top:50%;
      transform:translateY(-50%) translateX(4px);
      background:rgba(15,23,42,.96);
      color:#f9fafb;
      padding:4px 8px;
      border-radius:999px;
      font:700 11px Outfit;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:opacity .16s ease, transform .16s ease;
    }
    .side-btn:hover::after{
      opacity:1;
      transform:translateY(-50%) translateX(0);
    }
    .btn-friends{background:linear-gradient(145deg,#fdba74,#f97316);}
    .btn-share{background:linear-gradient(145deg,#22c55e,#0d9488);}
    .btn-spotsearch{background:linear-gradient(145deg,#a855f7,#6366f1);}
    .btn-personal{background:linear-gradient(145deg,#facc15,#f97316);}
    .btn-nearby{background:linear-gradient(145deg,#4ade80,#22c55e);}
    .btn-add{background:linear-gradient(145deg,#facc15,#eab308);}

    @media(max-width:899px){
      .side-actions{
        right:6px;
        top:120px;
        transform:scale(.9);
        transform-origin:top right;
      }
      .leaflet-control-zoom{display:none !important;}
    }
    @media(min-width:900px){
      .side-actions{
        right:10px;
        top:130px;
        transform:none;
      }
    }

    /* PIED DE PAGE */
    .site-footer{
      max-width:900px;
      margin:16px auto 84px;
      padding:12px 14px;
      border-top:1px solid var(--border);
      color:var(--text-dim);
      font-size:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      background:rgba(2,6,23,.6);
      backdrop-filter:blur(8px);
      border-radius:14px;
    }
    body.theme-light .site-footer{background:rgba(255,255,255,.8);}
    .site-footer a{
      color:var(--text-dim);text-decoration:none;font-weight:700;
    }
    .site-footer a:hover{color:var(--accent);}

    /* MODALES */
    .modal{position:fixed;inset:0;z-index:40;display:none}
    .modal.show{display:block}
    .modal-bg{
      position:absolute;inset:0;
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(4px);
    }
    .modal-card{
      position:relative;
      margin:6vh auto 0;
      max-width:min(92vw,720px);
      background:rgba(8,12,24,.96);
      border:1px solid rgba(148,163,184,.7);
      border-radius:16px;
      padding:14px;
      color:#fff;
    }
    body.theme-light .modal-card{
      background:#fff;color:#020617;border-color:rgba(148,163,184,.7);
    }
    .modal-card h3{margin:2px 0 10px;font-size:18px;font-weight:800}
    .modal .row{display:flex;gap:10px;margin-bottom:8px}
    .modal .row .col{flex:1}
    .modal input,.modal select,.modal textarea{
      width:100%;padding:9px 11px;
      border-radius:10px;
      background:#020617;border:1px solid(var(--border));
      color:#fff;font:600 14px Outfit;
    }
    body.theme-light .modal input,
    body.theme-light .modal select,
    body.theme-light .modal textarea{
      background:#f3f4f6;color:#020617;
      border-color:rgba(148,163,184,.6);
    }
    .modal textarea{min-height:82px;resize:vertical}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    #asMsg{font:700 12px;color:#7cffb0}
    #asMsg.error{color:#ff9f9f}

    /* TABBAR */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      border-top:1px solid var(--border);
      background:rgba(2,6,23,.97);
      backdrop-filter:blur(18px);
      display:flex;justify-content:space-around;align-items:center;
      padding:6px 8px 10px;
    }
    body.theme-light .tabbar{background:rgba(244,244,245,.97)}
    .tab{
      flex:1;display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:2px;text-decoration:none;
      color:var(--text-dim);
      font-size:9px;letter-spacing:.04em;
      text-transform:uppercase;padding:4px 0;
    }
    .tab .ic{font-size:20px;line-height:1}
    .tab.active{color:var(--accent)}
    @media(min-width:700px){
      nav.nav .row{padding-inline:20px}
      .main{padding-inline:14px}
      .tabbar{border-radius:22px 22px 0 0}
    }

    /* Marqueurs swirl */
    .rsl-marker.swirl div{animation:swirl-in .7s cubic-bezier(.2,.8,.2,1) both;}
    .rsl-marker div{position:relative;}
    .rsl-marker div::after{
      content:"";position:absolute;inset:-6px;
      border-radius:999px;border:2px solid rgba(34,197,94,.0);
      transform:scale(.8);
      animation:marker-ring 2.4s ease-out infinite;
    }
    @keyframes swirl-in{
      0%{transform:scale(.2) rotate(0deg);filter:blur(6px);opacity:0}
      60%{transform:scale(1.06) rotate(540deg);filter:blur(1px);opacity:1}
      100%{transform:scale(1) rotate(720deg);filter:blur(0);opacity:1}
    }
    @keyframes marker-ring{
      0%{opacity:.5;transform:scale(.8)}
      100%{opacity:0;transform:scale(1.3)}
    }
  </style>
</head>
<body class="theme-dark">

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<div class="page-wrap">

  <!-- NAV TOP -->
  <nav class="nav">
    <div class="row">
      <div class="nav-left">
        <a class="brand" href="ou_rider.html">
          <img src="image/1logo_ridly.png" alt="RIDLY"/>
          <span>RIDLY</span>
        </a>
        <button type="button" class="add-btn" onclick="window.location.href='ajouter.html'" title="Nouveau post"><span>+</span></button>
      </div>
      <div class="nav-tools">
        <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">üåô</button>
        <button type="button" class="icon-btn" id="btnPwa" title="Installer l'app RIDLY">üì≤ <span class="label">App</span></button>
        <a href="chat1v1.html" class="icon-btn" id="btn1v1" title="Messages priv√©s">üíå<span class="badge" id="badge1v1"></span></a>
        <a href="chat.html" class="icon-btn" id="btnChat" title="Chat riders">üí¨</a>
      </div>
    </div>
  </nav>

  <!-- CONTENU PRINCIPAL -->
  <main class="main">
    <div class="hero">
      Carte des <b>skateparks</b>, <b>street spots</b>, <b>shops partenaires</b> et <b>lieux de cours RSL</b>.<br>
      Partage ta position, ou ajoute ton propre spot.
    </div>

    <section class="map-card">
      <div class="map-wrap">

        <!-- Filtres (bouton cach√©, gard√© pour le JS) -->
        <div class="filters-fab">
          <button id="btnToggleFilters" class="btn">Filtres</button>
        </div>

        <!-- Panneau filtres -->
        <div class="filters-wrap" id="filtersWrap">
          <div class="filters-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <b style="font:800 13px Outfit">Filtres</b>
              <button id="btnCloseFilters" class="btn" style="padding:4px 10px">‚úï</button>
            </div>

            <div class="filters-grid" style="margin-top:8px">
              <label class="chip"><input type="checkbox" id="f-park" checked/> Parks</label>
              <label class="chip"><input type="checkbox" id="f-street" checked/> Street</label>
              <label class="chip"><input type="checkbox" id="f-shop" checked/> Shops</label>
              <label class="chip"><input type="checkbox" id="f-cours" checked/> Cours</label>

              <input id="f-country-search" class="input" placeholder="Recherche pays (Suisse, France‚Ä¶)" />
              <select id="f-country" class="select">
                <option value="">Pays (tous)</option>
                <option value="CH">Suisse</option><option value="FR">France</option><option value="DE">Allemagne</option>
                <option value="IT">Italie</option><option value="ES">Espagne</option><option value="PT">Portugal</option>
                <option value="BE">Belgique</option><option value="NL">Pays-Bas</option><option value="LU">Luxembourg</option>
                <option value="UK">Royaume-Uni</option><option value="IE">Irlande</option><option value="AT">Autriche</option>
                <option value="DK">Danemark</option><option value="SE">Su√®de</option><option value="NO">Norv√®ge</option>
                <option value="FI">Finlande</option><option value="IS">Islande</option><option value="PL">Pologne</option>
                <option value="CZ">Tch√©quie</option><option value="SK">Slovaquie</option><option value="SI">Slov√©nie</option>
                <option value="HR">Croatie</option><option value="HU">Hongrie</option><option value="RO">Roumanie</option>
                <option value="BG">Bulgarie</option><option value="GR">Gr√®ce</option><option value="TR">Turquie</option>
                <option value="US">√âtats-Unis</option><option value="CA">Canada</option><option value="BR">Br√©sil</option>
                <option value="AR">Argentine</option><option value="MX">Mexique</option><option value="AU">Australie</option>
                <option value="NZ">Nouvelle-Z√©lande</option><option value="JP">Japon</option><option value="CN">Chine</option>
                <option value="KR">Cor√©e du Sud</option><option value="IL">Isra√´l</option><option value="MA">Maroc</option>
                <option value="TN">Tunisie</option><option value="DZ">Alg√©rie</option><option value="EU">Autres Europe</option>
                <option value="WORLD">Monde</option>
              </select>

              <input id="f-type" class="input" placeholder="Type/texte (bowl, pumptrack, rail‚Ä¶)" />
            </div>

            <div class="filters-foot">
              <button id="btnReset" class="btn">R√©initialiser</button>
              <button id="btnLocate" class="btn green">üìç Ma position</button>
              <button id="btnShare" class="btn green" title="Partage ta position avec les riders">Partage riders</button>
              <span id="shareState"></span>
              <button id="btnAddSpot" class="btn green" style="margin-left:auto">‚ûï Ajouter un spot</button>
            </div>
          </div>
        </div>

        <!-- Chips + bouton style -->
        <div class="chips-row">
          <button class="chip-float chip-blue"  id="chipSkate">Skateparks</button>
          <button class="chip-float chip-green" id="chipPump">Pumptracks</button>
          <button class="chip-float chip-red"   id="chipIndoor">Indoors</button>
          <button class="chip-float chip-orange" id="chipStreet">Street</button>
        </div>
        <button class="fab-style" id="fabStyle" title="Changer le style">üåê</button>
        <div id="mapStyleTip" class="mapstyle-tip"></div>

        <!-- Raccourcis verticaux inspir√©s de tes ic√¥nes -->
        <div class="side-actions">
          <button class="side-btn btn-friends"  id="btnSideFriends"  data-label="Riders proches"><span>üë•</span></button>
          <button class="side-btn btn-share"    id="btnSideShare"    data-label="Partager ma position"><span>‚á™</span></button>
          <button class="side-btn btn-spotsearch" id="btnSideSearch" data-label="Rechercher spots"><span>üîé</span></button>
          <button class="side-btn btn-personal" id="btnSidePersonal" data-label="Ma position"><span>‚óé</span></button>
          <button class="side-btn btn-nearby"   id="btnSideNearby"   data-label="Spots proches"><span>üó∫Ô∏è</span></button>
          <button class="side-btn btn-add"      id="btnSideAdd"      data-label="Ajouter spot"><span>Ôºã</span></button>
        </div>

        <div id="map"></div>
      </div>
    </section>
  </main>


<!-- Modale Ajouter un spot -->
<div class="modal" id="addSpotModal">
  <div class="modal-bg"></div>
  <div class="modal-card">
    <h3>Proposer un nouveau spot</h3>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Type</label>
        <select id="asType">
          <option value="park">Skatepark / Pumptrack</option>
          <option value="street">Street spot</option>
        </select>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Pays</label>
        <select id="asCountry">
          <option value="">Choisir un pays</option>
          <option value="CH">Suisse</option><option value="FR">France</option><option value="DE">Allemagne</option>
          <option value="IT">Italie</option><option value="ES">Espagne</option><option value="PT">Portugal</option>
          <option value="BE">Belgique</option><option value="NL">Pays-Bas</option><option value="LU">Luxembourg</option>
          <option value="UK">Royaume-Uni</option><option value="IE">Irlande</option><option value="AT">Autriche</option>
          <option value="DK">Danemark</option><option value="SE">Su√®de</option><option value="NO">Norv√®ge</option>
          <option value="FI">Finlande</option><option value="IS">Islande</option><option value="PL">Pologne</option>
          <option value="CZ">Tch√©quie</option><option value="SK">Slovaquie</option><option value="SI">Slov√©nie</option>
          <option value="HR">Croatie</option><option value="HU">Hongrie</option><option value="RO">Roumanie</option>
          <option value="BG">Bulgarie</option><option value="GR">Gr√®ce</option><option value="TR">Turquie</option>
          <option value="US">√âtats-Unis</option><option value="CA">Canada</option><option value="BR">Br√©sil</option>
          <option value="AR">Argentine</option><option value="MX">Mexique</option><option value="AU">Australie</option>
          <option value="NZ">Nouvelle-Z√©lande</option><option value="JP">Japon</option><option value="CN">Chine</option>
          <option value="KR">Cor√©e du Sud</option><option value="IL">Isra√´l</option><option value="MA">Maroc</option>
          <option value="TN">Tunisie</option><option value="DZ">Alg√©rie</option><option value="EU">Autres Europe</option>
          <option value="WORLD">Monde</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Ville</label>
        <input id="asVille" placeholder="Ville"/>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Nom du spot</label>
        <input id="asNom" placeholder="Nom du spot"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Description</label>
        <textarea id="asDesc" placeholder="Courte description (type, modules, niveau...)"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Latitude</label>
        <input id="asLat" placeholder="Clique la carte ou le bouton"/>
      </div>
      <div class="col">
        <label style="font-size:12px;font-weight:700;">Longitude</label>
        <input id="asLng" placeholder="Clique la carte ou le bouton"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <button type="button" class="btn" id="btnPickLatLng" style="width:100%">üìç Choisir sur une petite carte</button>
        <div style="font-size:12px;color:#22c55e;margin-top:4px">
          Tu peux aussi cliquer directement sur la grande carte pour remplir lat / lng.
        </div>
      </div>
    </div>

    <div class="actions">
      <span id="asMsg"></span>
      <button type="button" class="btn" id="asCancel">Annuler</button>
      <button type="button" class="btn green" id="asSave">Envoyer</button>
    </div>
  </div>
</div>

<!-- Modale petite carte pour choisir lat/lng -->
<div class="modal" id="pickMapModal">
  <div class="modal-bg"></div>
  <div class="modal-card" style="max-width:min(92vw,500px);">
    <h3>Choisir l‚Äôemplacement</h3>
    <p style="font-size:13px;margin-top:0;margin-bottom:8px">
      Clique sur la carte pour placer le spot. Les champs latitude / longitude se remplissent automatiquement.
    </p>

    <div class="row">
      <div class="col"><input id="pickSearch" placeholder="Recherche ville / spot (ex: Bulle)"></div>
      <button type="button" class="btn" id="pickSearchBtn" style="white-space:nowrap">Rechercher</button>
    </div>

    <div id="pickMap" style="height:320px;border-radius:12px;overflow:hidden;border:1px solid rgba(148,163,184,.6);"></div>
    <div class="actions" style="margin-top:10px">
      <button type="button" class="btn" id="pickMapCancel">Annuler</button>
      <button type="button" class="btn green" id="pickMapOk">OK</button>
    </div>
  </div>
</div>

<!-- TABBAR -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab active" href="ou_rider.html" title="Spots"><div class="ic">üìç</div><span>Spots</span></a>
  <a class="tab" href="feed.html" title="Feed"><div class="ic">üé¨</div><span>Feed</span></a>
  <a class="tab" href="recherche.html" title="Recherche"><div class="ic">üîé</div><span>Search</span></a>
  <a class="tab" href="games.html" title="Games"><div class="ic">üéÆ</div><span>Game</span></a>
  <a class="tab" href="classement.html" title="Classement"><div class="ic">üèÜ</div><span>Rank</span></a>
  <a class="tab" href="profil_ou_rider.html" title="Profil"><div class="ic">üë§</div><span>Profil</span></a>
</nav>

<!-- Toast global -->
<div id="toast" class="toast"></div>

<script>
/* Th√®me */
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => { btnTheme.textContent = document.body.classList.contains('theme-light') ? '‚òÄÔ∏è' : 'üåô'; };
  updateIcon();
  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<script>
/* Supabase init */
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "YOUR_ANON_KEY_IF_NOT_IN_env_js";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
let currentUser = null;
</script>

<script>
/* Toast + notifs 1v1 (simplifi√©) */
const toastDiv=document.getElementById('toast');
const badge1v1=document.getElementById('badge1v1');
let unreadToastShown=false;
function showToast(msg){
  if(!toastDiv) return;
  toastDiv.textContent=msg;
  toastDiv.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t=setTimeout(()=>toastDiv.classList.remove('show'),4000);
}
function update1v1Badge(count){
  if(!badge1v1) return;
  if(count>0){
    badge1v1.style.display='flex';
    badge1v1.textContent=count>9?'9+':String(count);
  }else{
    badge1v1.style.display='none';
  }
}
async function checkPrivateUnread(me){
  if(!me) return;
  try{
    const {data,error}=await supa
      .from('ridly_private_unread_counts')
      .select('unread_count')
      .eq('user_id',me.id);
    if(error) return;
    const total=(data||[]).reduce((s,r)=>s+(r.unread_count||0),0);
    update1v1Badge(total);
    if(total>0 && !unreadToastShown){
      unreadToastShown=true;
      showToast(`Tu as ${total} message${total>1?'s':''} priv√©${total>1?'s':''} non lu${total>1?'s':''}.`);
    }
  }catch(e){}
}
function subscribePrivateAlerts(me){
  if(!me) return;
  supa.channel('ridly_private_alert_'+me.id)
    .on('postgres_changes',{
      event:'INSERT',schema:'public',table:'ridly_private_messages'
    }, async payload=>{
      const m=payload.new;
      if(m.to_id!==me.id) return;
      update1v1Badge(1);
      showToast('Nouveau message priv√©');
    })
    .subscribe();
}
</script>

<script>
/* Auth minimal */
(async function(){
  if (location.search.includes('code=') || location.hash.includes('access_token=')) {
    try{ await supa.auth.exchangeCodeForSession(); }catch(e){}
    history.replaceState({}, document.title, location.pathname);
  }
  const { data:{ user } } = await supa.auth.getUser();
  if(!user){
    window.location.href='connexion.html';
    return;
  }
  currentUser=user;
  checkPrivateUnread(user);
  subscribePrivateAlerts(user);
})();
</script>

<script>
/* BG vid√©o */
(function(){
  const v=document.getElementById('rslBg');
  if(!v) return;
  const s=document.createElement('source');
  s.src=SUPABASE_URL+"/storage/v1/object/public/ridly/ridly.mp4";
  s.type="video/mp4";
  v.appendChild(s);
  const play=()=>{
    try{
      v.playbackRate=0.6;
      const p=v.play();
      if(p && p.catch) p.catch(()=>{});
    }catch(e){}
  };
  play();
  document.addEventListener('visibilitychange',()=>{document.hidden?v.pause():play();});
})();
</script>

<script>
/* PWA */
let deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault();
  deferredInstallPrompt=e;
});
document.getElementById('btnPwa').addEventListener('click',async()=>{
  if(deferredInstallPrompt){
    deferredInstallPrompt.prompt();
    try{await deferredInstallPrompt.userChoice;}catch(e){}
    deferredInstallPrompt=null;
  }else{
    alert("Pour installer RIDLY, utilise ¬´ Ajouter √† l'√©cran d'accueil ¬ª dans ton navigateur.");
  }
});
</script>

<script>
/* ===== CARTE + STYLES ===== */
const MAPTILER_KEY = window.env?.MAPTILER_KEY || "";
let map = L.map('map').setView([46.8, 8.2], 8);

const baseDefs = [
  { id:'positron',  label:'Clair',     url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',  attr:'¬© OpenStreetMap ¬© CARTO' },
  { id:'dark',      label:'Noir',      url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',   attr:'¬© OpenStreetMap ¬© CARTO' },
  { id:'toon',      label:'Cartoon',   url:'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', attr:'¬© OpenStreetMap ¬© CARTO' },
  { id:'watercolor',label:'Watercolor',url:'https://stamen-tiles.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg', attr:'Map tiles by Stamen' },
  { id:'sat',       label:'Satellite', url: MAPTILER_KEY ? `https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}` : null, attr:'¬© MapTiler' }
].filter(d=>!!d.url);

const baseLayers={};
baseDefs.forEach(d=>{
  baseLayers[d.id]=L.tileLayer(d.url,{maxZoom:20,attribution:d.attr});
});
baseLayers['positron'].addTo(map);

let baseOrder=baseDefs.map(d=>d.id), baseIndex=0;
const styleTip=document.getElementById('mapStyleTip');
document.getElementById('fabStyle').addEventListener('click', ()=>{
  baseIndex=(baseIndex+1)%baseOrder.length;
  const id=baseOrder[baseIndex];
  Object.values(baseLayers).forEach(l=>{ if(map.hasLayer(l)) map.removeLayer(l); });
  baseLayers[id].addTo(map);
  const def=baseDefs.find(x=>x.id===id);
  if(def){
    styleTip.textContent=def.label;
    styleTip.style.display='block';
    clearTimeout(document.getElementById('fabStyle')._t);
    document.getElementById('fabStyle')._t=setTimeout(()=>styleTip.style.display='none',1500);
  }
});

/* Ic√¥nes & calques ‚Äî swirl + d√©lai */
const mk=(bg,emoji='üõπ')=>{
  const delay = (Math.random()*0.6+0.2).toFixed(2)+'s';
  return L.divIcon({
    className:'rsl-marker swirl',
    html:`<div style="width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${bg};border:2px solid #fff;color:#fff;font-size:18px;animation-delay:${delay}">${emoji}</div>`,
    iconSize:[34,34],
    iconAnchor:[17,17]
  });
};
const icons={
  park:mk('#7c3aed','üõπ'),
  street:mk('#f97316','üß±'),
  shop:mk('#ef4444','üè™'),
  int:mk('#16a34a','üè´'),
  ext:mk('#0ea5e9','üõº'),
  rider:mk('#06b6d4','üë§')
};
const layers={
  park:L.layerGroup().addTo(map),
  street:L.layerGroup().addTo(map),
  shop:L.layerGroup().addTo(map),
  int:L.layerGroup().addTo(map),
  ext:L.layerGroup().addTo(map),
  riders:L.layerGroup().addTo(map)
};
const ALL_MARKERS=[];
function addWithDelay(marker, group){
  const t = 200 + Math.random()*700;
  setTimeout(()=> marker.addTo(layers[group]), t);
}
</script>

<script>
/* Filtres UI */
const bodyEl=document.body;
document.getElementById('btnToggleFilters').onclick=()=> bodyEl.classList.toggle('show-filters');
document.getElementById('btnCloseFilters').onclick =()=> bodyEl.classList.remove('show-filters');
document.addEventListener('keydown',e=>{ if(e.key==='Escape') bodyEl.classList.remove('show-filters'); });

const F={
  park:document.getElementById('f-park'),
  street:document.getElementById('f-street'),
  shop:document.getElementById('f-shop'),
  cours:document.getElementById('f-cours'),
  country:document.getElementById('f-country'),
  countrySearch:document.getElementById('f-country-search'),
  type:document.getElementById('f-type'),
  reset:document.getElementById('btnReset'),
  locate:document.getElementById('btnLocate')
};
function applyFilters(){
  const show={park:F.park.checked,street:F.street.checked,shop:F.shop.checked,int:F.cours.checked,ext:F.cours.checked};
  const countrySel=(F.country.value||'').trim();
  const txt=(F.type.value||'').trim().toLowerCase();
  ALL_MARKERS.forEach(o=>{
    let vis=!!show[o.group] || o.group==='riders';
    if(vis && countrySel && o.group!=='riders') vis=(o.country||'')===countrySel;
    if(vis && txt && o.group!=='riders') vis=(o.text||'').includes(txt);
    if(vis){
      if(!map.hasLayer(o.marker)) o.marker.addTo(layers[o.group]);
    }else{
      if(map.hasLayer(o.marker)) layers[o.group].removeLayer(o.marker);
    }
  });
}
/* Recherche pays */
if(F.countrySearch){
  F.countrySearch.addEventListener('input', ()=>{
    const q=(F.countrySearch.value||'').trim().toLowerCase();
    const sel=F.country;
    Array.from(sel.options).forEach(opt=>{
      if(!opt.value){ opt.style.display=''; return; }
      const label=(opt.textContent||'').toLowerCase();
      opt.style.display = label.includes(q) ? '' : 'none';
    });
  });
}
['change','input'].forEach(ev=>{
  [F.park,F.street,F.shop,F.cours,F.country,F.type].forEach(el=> el.addEventListener(ev,applyFilters));
});
F.reset.onclick=()=>{
  F.park.checked=F.street.checked=F.shop.checked=F.cours.checked=true;
  F.country.value='';
  F.type.value='';
  applyFilters();
};

let lastUserPos=null;
F.locate.onclick=()=>{
  if(!navigator.geolocation){alert('G√©olocalisation indisponible.');return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    lastUserPos=[latitude,longitude];
    L.circleMarker([latitude,longitude],{
      radius:6,color:'#38bdf8',fillColor:'#38bdf8',fillOpacity:.9,weight:2
    }).addTo(map);
    map.setView([latitude,longitude],14);
  },()=>alert("Impossible d'obtenir ta position."));
};

/* Chips -> filtres rapides */
(function(){
  const chipSkate=document.getElementById('chipSkate');
  const chipPump=document.getElementById('chipPump');
  const chipIndoor=document.getElementById('chipIndoor');
  const chipStreet=document.getElementById('chipStreet');
  let exclusive=null;
  function resetAll(){
    F.park.checked=F.street.checked=F.shop.checked=F.cours.checked=true;
    F.country.value='';F.type.value='';
    [chipSkate,chipPump,chipIndoor,chipStreet].forEach(el=>el.style.opacity='1');
    exclusive=null;applyFilters();
  }
  function setOpacity(el){
    [chipSkate,chipPump,chipIndoor,chipStreet].forEach(x=>x.style.opacity=(x===el?'0.6':'1'));
  }
  chipSkate.addEventListener('click',()=>{
    if(exclusive==='skate'){resetAll();return;}
    F.park.checked=true;F.street.checked=F.shop.checked=F.cours.checked=false;
    F.type.value='';setOpacity(chipSkate);exclusive='skate';applyFilters();
  });
  chipPump.addEventListener('click',()=>{
    if(exclusive==='pump'){resetAll();return;}
    F.park.checked=true;F.street.checked=F.shop.checked=F.cours.checked=false;
    F.type.value='pump';setOpacity(chipPump);exclusive='pump';applyFilters();
  });
  chipIndoor.addEventListener('click',()=>{
    if(exclusive==='indoor'){resetAll();return;}
    F.cours.checked=true;F.park.checked=F.street.checked=F.shop.checked=false;
    F.type.value='';setOpacity(chipIndoor);exclusive='indoor';applyFilters();
  });
  chipStreet.addEventListener('click',()=>{
    if(exclusive==='street'){resetAll();return;}
    F.street.checked=true;F.park.checked=F.shop.checked=F.cours.checked=false;
    F.type.value='';setOpacity(chipStreet);exclusive='street';applyFilters();
  });
})();
</script>

<script>
/* Donn√©es Supabase */
(async function loadData(){
  // shops
  let { data: shops } = await supa.from('shops').select('*');
  (shops||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html =
      `<div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Shop'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description||''}</div>
        ${s.site?`<a class="rsl-pop-btn" href="${s.site}" target="_blank" rel="noopener">Site du shop ‚Üí</a>`:''}
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.shop}).bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:'shop',
      canton:s.canton||'',
      country:s.country||'CH',
      text:`${s.nom||''} ${s.ville||''} ${s.description||''}`.toLowerCase()
    });
    addWithDelay(m,'shop');
  });

  // parks
  let { data: parks } = await supa.from('spots').select('*');
  (parks||[]).forEach(p=>{
    if(!p.lat||!p.lng) return;
    const name = p.nom || 'Spot';
    const html =
      `<div class="rsl-pop">
        <div class="rsl-pop-title">${name}</div>
        <div class="rsl-pop-loc">${p.ville||''} (${p.canton||''})</div>
        <div class="rsl-pop-desc">${p.description ? p.description : (p.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${p.id}" onclick="window.location.href='spot.html?id=${p.id}';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([p.lat,p.lng],{icon:icons.park}).bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${name} ${p.ville||''} ${p.canton||''} ${p.type||''} ${p.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'park',
      spotId:p.id,
      name:name,
      lat:p.lat,
      lng:p.lng,
      canton:p.canton||'',
      country:p.country||'CH',
      text
    });
    addWithDelay(m,'park');
  });

  // street
  let { data: streets } = await supa.from('bunny').select('*');
  (streets||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html =
      `<div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Street spot'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description ? s.description : (s.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${s.id}&street=1" onclick="window.location.href='spot.html?id=${s.id}&street=1';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.street}).bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${s.nom||''} ${s.ville||''} ${s.canton||''} ${s.type||''} ${s.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'street',
      canton:s.canton||'',
      country:s.country||'CH',
      text
    });
    addWithDelay(m,'street');
  });

  // lieux de cours (exemples)
  [
    {group:'int', n:'Cours RSL ‚Äî Montreux (indoor)', lat:46.433, lng:6.910, desc:'Session encadr√©e en int√©rieur'},
    {group:'int', n:'Cours RSL ‚Äî Lausanne (La Fi√®vre)', lat:46.536, lng:6.626, desc:'Cours en salle / rampes / park'},
    {group:'ext', n:'Cours RSL ‚Äî Vidy', lat:46.523, lng:6.610, desc:'En ext√©rieur, bord du lac'},
  ].forEach(c=>{
    const html =
      `<div class="rsl-pop">
        <div class="rsl-pop-title">${c.n}</div>
        <div class="rsl-pop-desc">${c.desc||''}</div>
        <a class="rsl-pop-btn" href="cours.html">Infos cours ‚Üí</a>
      </div>`;
    const m = L.marker([c.lat,c.lng],{icon:icons[c.group]}).bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:c.group,
      canton:'',
      country:'CH',
      text:(c.n+' '+(c.desc||'')).toLowerCase()
    });
    addWithDelay(m,c.group);
  });

  applyFilters();
})();
</script>

<script>
/* Partage position riders + comptage des heures par skatepark */
let watchId=null;
const shareBtn=document.getElementById('btnShare');
const shareState=document.getElementById('shareState');

/* Vars pour comptage du temps dans un park */
let lastPresenceSpotId = null;
let lastPresenceTsMs   = null;

/* Calcul distance entre 2 points (en m√®tres) */
function distanceMeters(lat1,lng1,lat2,lng2){
  const R  = 6371000;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

/* Trouve le skatepark le plus proche du rider (dans un rayon de ~150m) */
function findNearestSpot(lat,lng){
  let best=null, bestDist=Infinity;
  ALL_MARKERS.forEach(o=>{
    if(o.group!=='park') return;
    if(typeof o.lat!=='number' || typeof o.lng!=='number') return;
    const d = distanceMeters(lat,lng,o.lat,o.lng);
    if(d < bestDist){
      bestDist = d;
      best = o;
    }
  });
  if(best && bestDist <= 150){
    return {
      id:   best.spotId,
      name: best.name || 'Spot',
      dist: bestDist
    };
  }
  return null;
}

/* Enregistre un ‚Äúchunk‚Äù de temps dans la table rider_spot_sessions */
async function logPresence(spotId, seconds){
  if(!currentUser || !spotId || !seconds) return;
  try{
    await supa.from('rider_spot_sessions').insert([{
      user_id:       currentUser.id,
      spot_id:       spotId,
      seconds_spent: seconds,
      day:           new Date().toISOString().slice(0,10)
    }]);
  }catch(e){
    console.warn('logPresence error', e);
  }
}

/* Flush de fin de session */
async function finalizePresenceSession(){
  if(lastPresenceSpotId && lastPresenceTsMs){
    const nowMs = Date.now();
    const delta = Math.floor((nowMs - lastPresenceTsMs)/1000);
    if(delta >= 60){
      await logPresence(lastPresenceSpotId, delta);
    }
  }
  lastPresenceSpotId = null;
  lastPresenceTsMs   = null;
}

/* Tick de pr√©sence */
function handlePresenceTick(lat,lng, nowMs){
  const spot = findNearestSpot(lat,lng);

  if(spot){
    if(lastPresenceSpotId === spot.id){
      if(lastPresenceTsMs){
        const delta = Math.floor((nowMs - lastPresenceTsMs)/1000);
        if(delta >= 60){
          logPresence(spot.id, delta);
          lastPresenceTsMs = nowMs;
        }
      }else{
        lastPresenceTsMs = nowMs;
      }
    }else{
      lastPresenceSpotId = spot.id;
      lastPresenceTsMs   = nowMs;
      showToast(`Tu es au skatepark ${spot.name} ‚Äî chaque heure ici = 1 point local üõπ`);
    }
  }else{
    if(lastPresenceSpotId && lastPresenceTsMs){
      const delta = Math.floor((nowMs - lastPresenceTsMs)/1000);
      if(delta >= 60){
        logPresence(lastPresenceSpotId, delta);
      }
    }
    lastPresenceSpotId = null;
    lastPresenceTsMs   = null;
  }
}

function updateShareUi(active,hint){
  if(!shareBtn) return;
  if(active){
    shareBtn.classList.remove('green');
    shareBtn.textContent='Stop partage';
  }else{
    shareBtn.classList.add('green');
    shareBtn.textContent='Partage riders';
  }
  if(hint!==undefined && shareState) shareState.textContent=hint||"";
}

async function upsertMyLocation(lat,lng){
  if(!currentUser) return;
  await supa.from('rider_locations').upsert({
    user_id: currentUser.id,
    lat, lng,
    updated_at: new Date().toISOString(),
    expires_at: new Date(Date.now()+60*60*1000).toISOString()
  }, { onConflict:'user_id' });
}

async function removeMyLocation(){
  if(currentUser) await supa.from('rider_locations').delete().eq('user_id', currentUser.id);
}

async function loadRiders(){
  const { data: rows } = await supa
    .from('rider_locations_view')
    .select('*')
    .gt('expires_at', new Date().toISOString());
  layers.riders.clearLayers();
  (rows||[]).forEach(r=>{
    if(currentUser && r.user_id===currentUser.id) return;
    if(!r.lat||!r.lng) return;
    const name = r.full_name || r.username || r.email || 'Rider';
    const profilUrl = `profil_ou_rider.html?id=${encodeURIComponent(r.user_id)}`;
    const popup =
      `<div class="rsl-pop">
        <div class="rsl-pop-title">${name}</div>
        <div class="rsl-pop-desc">Actif r√©cemment</div>
        <a class="rsl-pop-btn" href="${profilUrl}">Voir le profil ‚Üí</a>
      </div>`;
    L.marker([r.lat,r.lng],{icon:icons.rider}).bindPopup(popup,{closeButton:true}).addTo(layers.riders);
  });
}

if(shareBtn){
  shareBtn.addEventListener('click', async ()=>{
    if(!currentUser){
      alert("Connecte-toi pour partager ta position.");
      return;
    }
    if(watchId!==null){
      navigator.geolocation.clearWatch(watchId);
      watchId=null;
      await finalizePresenceSession();
      updateShareUi(false,"Partage coup√©");
      await removeMyLocation();
      return;
    }
    if(!navigator.geolocation){
      alert("G√©olocalisation indisponible.");
      return;
    }
    updateShareUi(true,"Partage actif‚Ä¶");
    watchId = navigator.geolocation.watchPosition(async pos=>{
      const { latitude, longitude } = pos.coords;
      const nowMs = Date.now();
      lastUserPos=[latitude,longitude];

      handlePresenceTick(latitude, longitude, nowMs);
      await upsertMyLocation(latitude, longitude);
    }, err=>{
      console.warn(err);
      updateShareUi(false,"Autorise la g√©oloc");
      watchId=null;
    }, { enableHighAccuracy:true, maximumAge:8000, timeout:15000 });
  });
}

setInterval(loadRiders, 20000);
loadRiders();
window.addEventListener('beforeunload', async ()=>{
  if(watchId!==null){
    try{ navigator.geolocation.clearWatch(watchId);}catch(_){}
  }
  await finalizePresenceSession();
  await removeMyLocation();
});
</script>

<script>
/* Petite carte + recherche + ajout spot */
const addModal  = document.getElementById('addSpotModal');
const asType    = document.getElementById('asType');
const asCountry = document.getElementById('asCountry');
const asVille   = document.getElementById('asVille');
const asNom     = document.getElementById('asNom');
const asDesc    = document.getElementById('asDesc');
const asLat     = document.getElementById('asLat');
const asLng     = document.getElementById('asLng');
const asMsg     = document.getElementById('asMsg');
const asSaveBtn = document.getElementById('asSave');

document.getElementById('btnAddSpot').onclick = ()=> openAddModal();
document.getElementById('asCancel').onclick   = ()=>addModal.classList.remove('show');
document.querySelector('#addSpotModal .modal-bg').addEventListener('click',()=>addModal.classList.remove('show'));

function openAddModal(){
  addModal.classList.add('show');
  asMsg.classList.remove('error');
  asMsg.textContent='üìç Utilise la petite carte ou clique la grande carte.';
  updateAsSaveState();
}
function updateAsSaveState(){
  const ok = (asNom.value.trim().length>1 && !!parseFloat(asLat.value) && !!parseFloat(asLng.value));
  asSaveBtn.disabled = !ok;
  asSaveBtn.style.opacity = ok ? '1' : '.6';
}
['input','change'].forEach(ev=>{
  [asNom,asLat,asLng,asCountry,asType,asVille,asDesc].forEach(el=> el.addEventListener(ev,updateAsSaveState));
});

let pickMap = null, pickMarker = null;
const pickModal      = document.getElementById('pickMapModal');
const btnPickLatLng  = document.getElementById('btnPickLatLng');
const pickSearch     = document.getElementById('pickSearch');
const pickSearchBtn  = document.getElementById('pickSearchBtn');

btnPickLatLng.addEventListener('click', ()=>{
  pickModal.classList.add('show');
  setTimeout(()=>{
    if(!pickMap){
      pickMap = L.map('pickMap').setView(map.getCenter(), map.getZoom());
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,attribution:'¬© OpenStreetMap'
      }).addTo(pickMap);
      pickMap.on('click', e=>{
        const lat = e.latlng.lat, lng = e.latlng.lng;
        if(!pickMarker){ pickMarker = L.marker([lat,lng],{icon:icons.park}).addTo(pickMap); }
        else{ pickMarker.setLatLng(e.latlng); }
        asLat.value = lat.toFixed(6); asLng.value = lng.toFixed(6);
        updateAsSaveState();
      });
    }else{
      pickMap.invalidateSize();
      pickMap.setView(map.getCenter(), map.getZoom());
    }
  },50);
});

async function doPickSearch(){
  const q = (pickSearch.value||'').trim();
  if(!q) return;
  if(!pickMap){
    alert("La carte charge, r√©essaie dans une seconde.");
    return;
  }
  pickSearchBtn.disabled = true;
  const oldTxt = pickSearchBtn.textContent;
  pickSearchBtn.textContent = "‚Ä¶";
  try{
    const resp = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q));
    const data = await resp.json();
    if(!data || !data.length){
      alert("Lieu introuvable.");
      return;
    }
    const latNum = parseFloat(data[0].lat), lngNum = parseFloat(data[0].lon);
    pickMap.setView([latNum,lngNum], 15);
    if(!pickMarker){ pickMarker = L.marker([latNum,lngNum],{icon:icons.park}).addTo(pickMap); }
    else{ pickMarker.setLatLng([latNum,lngNum]); }
    asLat.value = latNum.toFixed(6); asLng.value = lngNum.toFixed(6);
    updateAsSaveState();
  }catch(e){
    alert("Recherche impossible pour l'instant.");
  }finally{
    pickSearchBtn.disabled = false;
    pickSearchBtn.textContent = oldTxt;
  }
}
pickSearchBtn.addEventListener('click', doPickSearch);
pickSearch.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    doPickSearch();
  }
});
document.getElementById('pickMapCancel').onclick = ()=> pickModal.classList.remove('show');
document.getElementById('pickMapOk').onclick     = ()=> pickModal.classList.remove('show');

/* Clic sur grande carte -> lat/lng quand modale ouverte */
map.on('click',e=>{
  if(!addModal.classList.contains('show')) return;
  const lat = e.latlng.lat, lng = e.latlng.lng;
  asLat.value = lat.toFixed(6); asLng.value = lng.toFixed(6);
  updateAsSaveState();
});

/* Envoi du spot */
document.getElementById('asSave').onclick = async ()=>{
  asMsg.classList.remove('error');
  asMsg.textContent = "Envoi‚Ä¶";
  const row = {
    nom:(asNom.value||'').trim(),
    ville:(asVille.value||'').trim(),
    canton:'',
    country:(asCountry.value||'').trim() || 'WORLD',
    description:(asDesc.value||'').trim(),
    lat: parseFloat(asLat.value),
    lng: parseFloat(asLng.value)
  };
  if(!row.nom || !row.lat || !row.lng){
    asMsg.classList.add('error');
    asMsg.textContent = "Nom + position obligatoires.";
    return;
  }
  try{
    const target = (asType.value==='street') ? 'bunny' : 'spots';
    const { error } = await supa.from(target).insert([row]);
    if(error) throw error;

    const icon = (asType.value==='street') ? icons.street : icons.park;
    const text = `${row.nom} ${row.ville} ${row.canton} ${row.description}`.toLowerCase();
    const popup =
      `<div class="rsl-pop">
        <div class="rsl-pop-title">${row.nom}</div>
        <div class="rsl-pop-loc">${row.ville||''} (${row.canton||''})</div>
        <div class="rsl-pop-desc">${row.description||''}</div>
      </div>`;
    const g = (asType.value==='street') ? 'street' : 'park';
    const m = L.marker([row.lat,row.lng],{icon}).bindPopup(popup,{closeButton:true});
    ALL_MARKERS.push({
      marker:m,
      group:g,
      canton:row.canton||'',
      country:row.country||'WORLD',
      text
    });
    m.addTo(layers[g]);
    applyFilters();
    asMsg.textContent = "Spot propos√© ‚úÖ";
    setTimeout(()=>addModal.classList.remove('show'),600);
  }catch(ex){
    asMsg.classList.add('error');
    asMsg.textContent = "Erreur: "+(ex.message||'envoi impossible');
  }
};
</script>

<script>
/* Side buttons actions (ic√¥nes √† droite) */
const btnSideFriends  = document.getElementById('btnSideFriends');
const btnSideShare    = document.getElementById('btnSideShare');
const btnSideSearch   = document.getElementById('btnSideSearch');
const btnSidePersonal = document.getElementById('btnSidePersonal');
const btnSideNearby   = document.getElementById('btnSideNearby');
const btnSideAdd      = document.getElementById('btnSideAdd');

if(btnSideFriends){
  btnSideFriends.addEventListener('click', ()=>{
    applyFilters();
    loadRiders();
    showToast("Les riders connect√©s apparaissent en bleu clair sur la carte.");
  });
}
if(btnSideShare){
  btnSideShare.addEventListener('click', ()=>{
    document.getElementById('btnShare').click();
  });
}
if(btnSideSearch){
  btnSideSearch.addEventListener('click', ()=>{
    bodyEl.classList.add('show-filters');
    document.getElementById('f-type').focus();
  });
}
if(btnSidePersonal){
  btnSidePersonal.addEventListener('click', ()=>{
    document.getElementById('btnLocate').click();
  });
}
if(btnSideNearby){
  btnSideNearby.addEventListener('click', ()=>{
    if(lastUserPos){
      map.setView(lastUserPos, 14);
      showToast("Zoom sur ta zone pour voir les spots proches.");
    }else{
      document.getElementById('btnLocate').click();
    }
  });
}
if(btnSideAdd){
  btnSideAdd.addEventListener('click', ()=>{
    openAddModal();
  });
}
</script>

<!-- ================================================================= -->
<!-- =======================  FIREBASE COMPAT  ======================== -->
<!-- ================================================================= -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAWFExlphYD1jDQpgOJpbYURO5n_hcBuLs",
  authDomain: "ridly-app.firebaseapp.com",
  projectId: "ridly-app",
  storageBucket: "ridly-app.appspot.com",
  messagingSenderId: "402614688384",
  appId: "1:402614688384:web:a79d007ffeffa94afd92465",
  measurementId: "G-K4S628L7TK"
};

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();

async function initFCM() {
  try {
    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      console.log("‚ùå Notifications refus√©es");
      return;
    }

    console.log("‚úî Notifications autoris√©es !");

    const token = await messaging.getToken({
      vapidKey: "BBocWMR1111ZxsgkuDQw_JzkIkTwxa5VATFjt6V2P5GJzsjh16wxuJEuwifZgzIfhS‚Ä¶" 
    });

    console.log("üî• Token FCM :", token);

  } catch (err) {
    console.error("‚ùå Erreur FCM :", err);
  }
}

initFCM();
</script>

<!-- ================================================================= -->
<!-- =======================  SERVICE WORKER  ========================= -->
<!-- ================================================================= -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(() => console.log("‚úî SW FCM OK"))
    .catch(err => console.error("‚ùå SW FCM ERROR :", err));
}
</script>

</body>
</html>
