<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <title>Profil ‚Äî RIDLY</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#22c55e;
      --green-dark:#16a34a;

      --bg:#020617;
      --bg-soft:#030712;
      --panel:#020617;
      --panel-soft:#020617;
      --text:#f9fafb;
      --dim:#9ca3af;
      --border:rgba(148,163,184,.4);
      --radius-xl:18px;
    }

    body.theme-dark{
      --bg:#020617;
      --bg-soft:#030712;
      --panel:#020617;
      --panel-soft:#020617;
      --text:#f9fafb;
      --dim:#9ca3af;
      --border:rgba(148,163,184,.4);
    }
    body.theme-light{
      --bg:#f3f4f6;
      --bg-soft:#e5e7eb;
      --panel:#ffffff;
      --panel-soft:#e5e7eb;
      --text:#020617;
      --dim:#4b5563;
      --border:rgba(148,163,184,.25);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;padding:0}
    body{
      background:#000;
      color:var(--text);
      font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      flex-direction:column;
    }

    /* BG vid√©o */
    .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
    .rsl-bg-video{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;
      filter:brightness(.48) saturate(1.05);
    }
    .rsl-bg-dim{
      position:absolute;inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.7));
    }
    body.theme-light .rsl-bg-dim{
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
    }

    .page-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:800px;
      margin:0 auto;
      width:100%;
      position:relative;
      z-index:1;
    }

    /* NAV top */
    nav.nav{
      position:sticky;
      top:0;
      z-index:20;
      background:rgba(2,6,23,.9);
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
    }
    body.theme-light nav.nav{
      background:rgba(244,244,245,.95);
    }
    nav.nav .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 14px;
    }
    .nav-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      color:var(--text);
    }
    .brand img{
      width:32px;
      height:32px;
      border-radius:12px;
      background:#000;
      padding:3px;
      box-shadow:0 0 12px rgba(34,197,94,.7);
    }
    .brand span{
      font-weight:700;
      letter-spacing:-0.03em;
      font-size:20px;
    }
    .add-btn{
      border:none;
      outline:none;
      width:30px;
      height:30px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
      background:radial-gradient(circle at 30% 20%,#4ade80 0,#22c55e 35%,#16a34a 100%);
      color:#022c16;
      box-shadow:0 10px 22px rgba(34,197,94,.7);
    }
    .add-btn span{transform:translateY(-1px);}

    .nav-tools{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }
    .icon-btn{
      border:1px solid rgba(15,23,42,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      text-decoration:none;
      position:relative;
      cursor:pointer;
      gap:6px;
    }
    body.theme-light .icon-btn{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.6);
    }
    .icon-btn:hover{
      border-color:var(--green);
      color:var(--green);
    }

    .nav-badge{
      position:absolute;
      top:-3px;
      right:-3px;
      min-width:18px;
      height:18px;
      border-radius:999px;
      background:#ef4444;
      color:#f9fafb;
      font-size:10px;
      font-weight:800;
      display:none;
      align-items:center;
      justify-content:center;
      padding:0 4px;
      box-shadow:0 0 8px rgba(0,0,0,.6);
    }

    /* Toast notifs */
    .toast{
      position:fixed;
      left:50%;
      top:60px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.97);
      color:#f9fafb;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s, transform .2s;
      z-index:60;
      max-width:90%;
      text-align:center;
      white-space:normal;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(4px);
    }

    .mini-title{
      padding:10px 10px 0;
      font-size:13px;
      font-weight:600;
      color:var(--dim);
    }
    .page-intro{
      font-size:13px;
      color:var(--dim);
      padding:2px 10px 8px;
      line-height:1.4;
    }

    main.main{
      flex:1;
      padding:0 10px 90px;
    }

    /* Card profil */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      box-shadow:0 22px 60px rgba(0,0,0,.85);
      padding:14px;
      margin-top:4px;
    }
    body.theme-light .card{
      box-shadow:0 18px 45px rgba(15,23,42,.15);
    }

    .p-head{
      display:grid;
      grid-template-columns:84px 1fr auto;
      gap:16px;
      align-items:flex-start;
    }
    .p-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding-top:2px;
    }
    @media(max-width:720px){
      .p-head{
        grid-template-columns:72px 1fr;
        grid-template-rows:auto auto;
      }
      .p-actions{
        grid-column:1/-1;
        margin-top:10px;
      }
    }
    .avatar{
      width:84px;
      height:84px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    body.theme-light .avatar{
      background:#e5e7eb;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .name{
      font-size:21px;
      font-weight:800;
      margin:0;
      color:var(--text);
    }
    .meta-line{
      font-size:12px;
      color:var(--dim);
      font-weight:600;
    }
    .loc-line{
      font-size:12px;
      color:var(--dim);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--text);
      font-weight:700;
      font-size:13px;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
    }
    body.theme-light .btn{
      background:#e5e7eb;
    }
    .btn.green{
      background:linear-gradient(180deg,var(--green),var(--green-dark));
      color:#062312;
      border:none;
      box-shadow:0 10px 24px rgba(0,0,0,.5);
    }
    .p-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    /* Flashes (stories) */
    .flash-strip{
      margin-top:12px;
      display:flex;
      gap:12px;
      overflow:auto;
      padding-bottom:4px;
    }
    .flash{
      flex:0 0 auto;
      width:70px;
      position:relative;
      cursor:pointer;
    }
    .flash .ring{
      width:70px;
      height:70px;
      border-radius:50%;
      padding:3px;
      background:conic-gradient(#ffd54a,#ff7b54,#ff5478,#8b5cf6,#ffd54a);
    }
    .flash .inner{
      width:100%;
      height:100%;
      border-radius:50%;
      overflow:hidden;
      background:#000;
      border:2px solid #000;
    }
    .flash img,.flash video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:brightness(.95);
    }
    .flash .cap{
      font-size:10px;
      text-align:center;
      margin-top:4px;
      color:#cdd6ff;
    }
    .flash-actions{
      position:absolute;
      right:4px;
      bottom:2px;
      display:flex;
      gap:4px;
    }
    .flash-actions button{
      border:0;
      background:rgba(0,0,0,.75);
      color:#f9fafb;
      border-radius:999px;
      width:18px;
      height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      cursor:pointer;
    }

    /* Form edit */
    .edit{
      margin-top:14px;
      display:none;
    }
    .row-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    .row-grid .full{grid-column:1/-1}
    label{
      display:block;
      font-size:11px;
      font-weight:700;
      color:#e2e8f0;
      margin:4px 0 4px;
    }
    .input,textarea.input,select.input{
      width:100%;
      background:#020617;
      border:1px solid var(--border);
      border-radius:10px;
      color:#fff;
      padding:8px 10px;
      font-size:13px;
    }
    body.theme-light .input,
    body.theme-light textarea.input,
    body.theme-light select.input{
      background:#f9fafb;
      color:#020617;
      border-color:rgba(15,23,42,.15);
    }

    /* Posts grid */
    .posts-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .posts-header h2{
      margin:0;
      font-size:15px;
      font-weight:800;
    }
    .post-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }
    @media (max-width:720px){
      .post-grid{grid-template-columns:repeat(2,1fr);}
    }
    .thumb{
      position:relative;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#000;
      display:block;
    }
    .thumb img,.thumb video{
      display:block;
      width:100%;
      height:100%;
      object-fit:cover;
      aspect-ratio:1/1;
    }
    .thumb .tag{
      position:absolute;
      left:6px;
      top:6px;
      font-size:10px;
      font-weight:800;
      background:rgba(0,0,0,.6);
      border:1px solid var(--border);
      padding:3px 6px;
      border-radius:999px;
    }
    .thumb-del{
      position:absolute;
      right:4px;
      top:4px;
      width:20px;
      height:20px;
      border-radius:999px;
      border:0;
      background:rgba(0,0,0,.78);
      color:#f9fafb;
      font-size:12px;
      cursor:pointer;
    }
    .empty{
      color:var(--dim);
      text-align:center;
      margin:14px 0 4px;
      font-size:13px;
    }

    /* Stats spots RIDLY */
    .spotstats-body{
      margin-top:4px;
    }
    .spotstats-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
      font-size:13px;
    }
    .spotstats-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 10px;
      border-radius:10px;
      background:var(--panel-soft);
      border:1px solid rgba(148,163,184,.25);
    }
    body.theme-light .spotstats-row{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.4);
    }
    .spotstats-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .spotstats-title{
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spotstats-sub{
      font-size:11px;
      color:var(--dim);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spotstats-points{
      font-size:13px;
      font-weight:700;
      margin-left:10px;
      white-space:nowrap;
    }

    /* Tabbar */
    .tabbar{
      position:fixed;
      left:0;right:0;bottom:0;
      z-index:30;
      display:flex;
      align-items:center;
      justify-content:space-around;
      padding:6px 8px 10px;
      border-top:1px solid var(--border);
      background:rgba(2,6,23,.97);
      backdrop-filter:blur(18px);
    }
    body.theme-light .tabbar{
      background:rgba(244,244,245,.97);
    }
    .tab{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      text-decoration:none;
      color:var(--dim);
      font-size:9px;
      letter-spacing:.04em;
      text-transform:uppercase;
      padding:4px 0;
    }
    .tab .ic{font-size:20px;line-height:1;}
    .tab.active{color:var(--green);}
    @media(min-width:900px){
      nav.nav .row{padding-inline:20px;}
      main.main{padding-inline:14px;}
      .tabbar{border-radius:22px 22px 0 0;}
    }

    .chip-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:0;
      padding:2px 10px;
      margin:0 3px;
      background:rgba(15,23,42,.8);
      color:var(--text);
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    body.theme-light .chip-link{
      background:rgba(148,163,184,.25);
    }
    .chip-link:hover{
      filter:brightness(1.1);
    }

    .cgu-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .cgu-row .cgu-btn{
      font-size:10px;
      opacity:.85;
    }

    /* Modal abonn√©s / abonnements */
    .modal-backdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(15,23,42,.82);
      z-index:40;
    }
    .modal{
      background:var(--panel);
      border-radius:18px;
      border:1px solid var(--border);
      max-width:420px;
      width:100%;
      max-height:80vh;
      display:flex;
      flex-direction:column;
      box-shadow:0 22px 60px rgba(0,0,0,.9);
    }
    .modal-header{
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:14px;
      font-weight:700;
    }
    .modal-close{
      border:0;
      background:transparent;
      color:#e5e7eb;
      font-size:18px;
      cursor:pointer;
      padding:0 2px;
    }
    .modal-body{
      padding:8px 14px 12px;
      overflow:auto;
    }
    .follow-list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .follow-item{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:var(--text);
      padding:6px 8px;
      border-radius:12px;
      background:var(--panel-soft);
      border:1px solid rgba(148,163,184,.35);
    }
    .follow-item:hover{
      border-color:var(--green);
    }
    .follow-avatar{
      width:36px;
      height:36px;
      border-radius:999px;
      overflow:hidden;
      background:#020617;
      flex-shrink:0;
    }
    body.theme-light .follow-avatar{
      background:#e5e7eb;
    }
    .follow-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .follow-names{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .follow-main{
      font-size:13px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .follow-sub{
      font-size:11px;
      color:var(--dim);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>
<body class="theme-dark">

<!-- BG vid√©o RIDLY -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<div class="page-wrap">

  <!-- Nav top -->
  <nav class="nav">
    <div class="row">
      <div class="nav-left">
        <a class="brand" href="ou_rider.html">
          <img src="image/1logo_ridly.png" alt="RIDLY"/>
          <span>RIDLY</span>
        </a>
        <button type="button" class="add-btn" onclick="window.location.href='ajouter.html'" title="Nouvelle publication">
          <span>+</span>
        </button>
      </div>
      <div class="nav-tools">
        <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">üåô</button>

        <a href="chat1v1.html" class="icon-btn" id="btn1v1" title="Messages priv√©s">
          üíå
          <span class="nav-badge" id="badge1v1"></span>
        </a>

        <a href="chat.html" class="icon-btn" id="btnChat" title="Chat riders">üí¨</a>

        <!-- D√©connexion en haut -->
        <button type="button" class="icon-btn" id="btnLogout" title="D√©connexion" style="display:none">‚èª</button>
      </div>
    </div>
  </nav>

  <p class="page-intro">
    G√®re ton profil RIDLY, tes stories (flashs), tes posts dans le feed et tes stats de spots.
  </p>

  <main class="main">
    <section class="card">
      <div class="p-head">
        <div class="avatar">
          <img id="avatarImg" alt="avatar" src="image/logo_pn360.png"/>
        </div>
        <div class="p-main">
          <h1 class="name" id="pName">‚Äî</h1>
          <div class="loc-line" id="pSub">‚Äî</div>
          <div class="meta-line" id="pStats">0 posts ‚Ä¢ 0 flashs ‚Ä¢ 0 abonn√©s ‚Ä¢ Moyenne compte : ‚Äî</div>
          <div class="meta-line" id="pLocalPark">Skatepark local : ‚Äî</div>
          <div class="cgu-row">
            <button type="button" class="chip-link cgu-btn" id="btnCgu">
              Conditions RIDLY
            </button>
          </div>
        </div>
        <div class="p-actions" id="actionsBox"></div>
      </div>

      <div id="flashStrip" class="flash-strip"></div>

      <form id="editForm" class="edit">
        <div class="row-grid">
          <div>
            <label for="fPseudo">Pseudo</label>
            <input id="fPseudo" class="input" type="text" placeholder="rider_name"/>
          </div>
          <div>
            <label for="fFullname">Nom complet</label>
            <input id="fFullname" class="input" type="text" placeholder="Pr√©nom Nom"/>
          </div>
          <div>
            <label for="fCity">Ville</label>
            <input id="fCity" class="input" type="text" placeholder="Montreux"/>
          </div>
          <div>
            <label for="fCanton">Canton</label>
            <input id="fCanton" class="input" type="text" placeholder="VD"/>
          </div>
          <div>
            <label for="fCountry">Pays</label>
            <select id="fCountry" class="input">
              <option value="">‚Äî</option>
              <option value="Suisse">Suisse</option>
              <option value="France">France</option>
              <option value="Allemagne">Allemagne</option>
              <option value="Autre Europe">Autre Europe</option>
              <option value="Monde">Monde</option>
            </select>
          </div>
          <div>
            <label for="fGender">Genre</label>
            <select id="fGender" class="input">
              <option value="">Non sp√©cifi√©</option>
              <option value="Homme">Homme</option>
              <option value="Femme">Femme</option>
            </select>
          </div>
          <div class="full">
            <label for="fInsta">Instagram (URL)</label>
            <input id="fInsta" class="input" type="url" placeholder="https://instagram.com/moncompte"/>
          </div>
          <div class="full">
            <label for="fBio">Bio</label>
            <textarea id="fBio" class="input" rows="3" placeholder="Quelques lignes sur toi‚Ä¶"></textarea>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap">
          <label class="btn" for="fAvatar">Changer l‚Äôavatar</label>
          <input id="fAvatar" type="file" accept="image/*" style="display:none"/>
          <button class="btn green" id="btnSave" type="submit">Enregistrer</button>
          <span id="saveMsg" style="color:#9aa5b1;font-size:12px"></span>
        </div>
      </form>
    </section>

    <!-- Posts -->
    <section class="card" style="margin-top:14px">
      <div class="posts-header">
        <h2>Posts</h2>
        <button class="btn" id="btnNewPost" style="display:none">+ Nouveau post</button>
      </div>
      <div id="postGrid" class="post-grid"></div>
      <p id="postsEmpty" class="empty" style="display:none">Aucun post pour l‚Äôinstant.</p>
    </section>

    <!-- Stats spots -->
    <section class="card" style="margin-top:14px" id="spotStatsCard">
      <div class="posts-header">
        <h2>Statistiques RIDLY ‚Äî Spots</h2>
      </div>
      <div class="spotstats-body">
        <p class="empty" id="spotStatsEmpty">Pas encore de sessions enregistr√©es.</p>
        <div id="spotStatsList" class="spotstats-list"></div>
      </div>
    </section>
  </main>
</div>

<!-- Modal abonn√©s / abonnements -->
<div class="modal-backdrop" id="followModal">
  <div class="modal">
    <div class="modal-header">
      <span id="followModalTitle">Abonn√©s</span>
      <button type="button" class="modal-close" id="followModalClose">‚úï</button>
    </div>
    <div class="modal-body">
      <ul class="follow-list" id="followModalList"></ul>
      <p class="empty" id="followModalEmpty" style="display:none;margin-top:8px;">Aucun r√©sultat pour l‚Äôinstant.</p>
    </div>
  </div>
</div>

<!-- Tabbar -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab" href="ou_rider.html" title="Spots">
    <div class="ic">üìç</div><span>Spots</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Search</span>
  </a>
  <a class="tab" href="games.html" title="Games">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Rank</span>
  </a>
  <a class="tab active" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Th√®me -->
<script>
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => {
    const isLight = document.body.classList.contains('theme-light');
    btnTheme.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  };
  updateIcon();

  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<!-- Supabase + profil -->
<script>
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* BG vid√©o */
(function(){
  const v = document.getElementById('rslBg');
  if(!v) return;
  const s = document.createElement('source');
  s.src = SUPABASE_URL + "/storage/v1/object/public/ridly/ridly.mp4";
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{ try{ v.playbackRate = 0.6; const p=v.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} };
  play();
  document.addEventListener('visibilitychange',()=>{ document.hidden ? v.pause() : play(); });
})();

/* Toast + notifs 1v1 */
const toastDiv   = document.getElementById('toast');
const badge1v1   = document.getElementById('badge1v1');
const notifAudio = new Audio('https://ridly.ch/sons/sonsnotif.mp3');
let unreadToastShown = false;

function showToast(msg){
  if(!toastDiv) return;
  toastDiv.textContent = msg;
  toastDiv.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastDiv.classList.remove('show'),4000);
}
function playNotifSound(){
  try{
    notifAudio.currentTime = 0;
    notifAudio.play().catch(()=>{});
  }catch(e){}
}
function update1v1Badge(count){
  if(!badge1v1) return;
  if(count>0){
    badge1v1.style.display = 'flex';
    badge1v1.textContent = count>9 ? '9+' : String(count);
  }else{
    badge1v1.style.display = 'none';
  }
}
async function checkPrivateUnread(user){
  if(!user) return;
  try{
    const { data, error } = await supa
      .from('ridly_private_unread_counts')
      .select('unread_count')
      .eq('user_id', user.id);

    if(error){
      console.error('unread error', error);
      return;
    }
    const total = (data||[]).reduce((sum,r)=>sum + (r.unread_count||0),0);
    update1v1Badge(total);
    if(total>0 && !unreadToastShown){
      unreadToastShown = true;
      const s = total>1 ? 's' : '';
      showToast(`Tu as ${total} message${s} priv√©${s} non lu${s}.`);
      playNotifSound();
    }
  }catch(e){
    console.error(e);
  }
}
function subscribePrivateAlerts(user){
  if(!user) return;
  supa.channel('ridly_private_alert_'+user.id)
    .on('postgres_changes',{
      event:'INSERT',
      schema:'public',
      table:'ridly_private_messages'
    }, async payload => {
      const m = payload.new;
      if(m.to_id !== user.id) return;

      let senderName = 'Rider';
      try{
        const { data:p } = await supa
          .from('profiles')
          .select('pseudo,full_name')
          .eq('id', m.from_id)
          .maybeSingle();
        if(p) senderName = p.pseudo || p.full_name || 'Rider';
      }catch(e){}

      playNotifSound();
      showToast('Nouveau message priv√© de ' + senderName);
      checkPrivateUnread(user);
    })
    .subscribe();
}

/* Param√®tres & DOM */
const params = new URLSearchParams(location.search);
const qId    = params.get('id');
const qUser  = params.get('u');

const avatarImg   = document.getElementById('avatarImg');
const pName       = document.getElementById('pName');
const pSub        = document.getElementById('pSub');
const pStats      = document.getElementById('pStats');
const pLocalPark  = document.getElementById('pLocalPark');
const actionsBox  = document.getElementById('actionsBox');
const editForm    = document.getElementById('editForm');
const saveMsg     = document.getElementById('saveMsg');
const flashStrip  = document.getElementById('flashStrip');
const postGrid    = document.getElementById('postGrid');
const postsEmpty  = document.getElementById('postsEmpty');
const btnNewPost  = document.getElementById('btnNewPost');
const btnLogout   = document.getElementById('btnLogout');
const btnCgu      = document.getElementById('btnCgu');

/* Stats spots DOM */
const spotStatsCard  = document.getElementById('spotStatsCard');
const spotStatsEmpty = document.getElementById('spotStatsEmpty');
const spotStatsList  = document.getElementById('spotStatsList');

const avatarInput = document.getElementById('fAvatar');
const fPseudo     = document.getElementById('fPseudo');
const fFullname   = document.getElementById('fFullname');
const fCity       = document.getElementById('fCity');
const fCanton     = document.getElementById('fCanton');
const fCountry    = document.getElementById('fCountry');
const fInsta      = document.getElementById('fInsta');
const fBio        = document.getElementById('fBio');
const fGender     = document.getElementById('fGender');

/* Modal elements */
const followModal      = document.getElementById('followModal');
const followModalTitle = document.getElementById('followModalTitle');
const followModalList  = document.getElementById('followModalList');
const followModalEmpty = document.getElementById('followModalEmpty');
const followModalClose = document.getElementById('followModalClose');

let sessionUser   = null;
let profileUserId = null;

/* Bouton Conditions RIDLY */
btnCgu?.addEventListener('click', ()=>{
  window.location.href = 'conditions_ridly.html';
});

/* Ouvre le modal avec la liste */
async function openFollowModal(mode){
  if(!window._ridlyProfile?.profileUserId) return;
  const profileUserId = window._ridlyProfile.profileUserId;

  followModalTitle.textContent = (mode === 'followers') ? 'Abonn√©s' : 'Abonnements';
  followModalList.innerHTML = '';
  followModalEmpty.style.display = 'none';
  followModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  try{
    let ids = [];
    if(mode === 'followers'){
      const { data:rows, error } = await supa
        .from('rider_follows')
        .select('follower_id')
        .eq('followed_id', profileUserId)
        .limit(200);
      if(error) throw error;
      ids = (rows || []).map(r=>r.follower_id);
    }else{
      const { data:rows, error } = await supa
        .from('rider_follows')
        .select('followed_id')
        .eq('follower_id', profileUserId)
        .limit(200);
      if(error) throw error;
      ids = (rows || []).map(r=>r.followed_id);
    }

    if(!ids.length){
      followModalEmpty.textContent = "Aucun r√©sultat pour l‚Äôinstant.";
      followModalEmpty.style.display = 'block';
      return;
    }

    const { data:profiles, error:pErr } = await supa
      .from('profiles')
      .select('id,pseudo,username,full_name,city,canton,country,avatar_url')
      .in('id', ids);

    if(pErr) throw pErr;

    (profiles || []).forEach(p=>{
      const displayName = p.pseudo || p.username || p.full_name || 'Rider';
      const locParts = [];
      if(p.city) locParts.push(p.city);
      if(p.canton) locParts.push(p.canton);
      if(p.country) locParts.push(p.country);
      const loc = locParts.join(' ‚Ä¢ ');

      const li = document.createElement('li');
      const a  = document.createElement('a');
      a.className = 'follow-item';
      a.href = 'profil_ou_rider.html?id=' + encodeURIComponent(p.id);

      const avatarWrap = document.createElement('div');
      avatarWrap.className = 'follow-avatar';
      const img = document.createElement('img');
      img.src = p.avatar_url || 'image/logo_pn360.png';
      img.alt = displayName;
      avatarWrap.appendChild(img);

      const namesWrap = document.createElement('div');
      namesWrap.className = 'follow-names';
      const main = document.createElement('div');
      main.className = 'follow-main';
      main.textContent = displayName;
      const sub = document.createElement('div');
      sub.className = 'follow-sub';
      sub.textContent = loc || '‚Äî';
      namesWrap.appendChild(main);
      namesWrap.appendChild(sub);

      a.appendChild(avatarWrap);
      a.appendChild(namesWrap);

      li.appendChild(a);
      followModalList.appendChild(li);
    });

  }catch(e){
    console.error(e);
    followModalEmpty.textContent = "Erreur de chargement.";
    followModalEmpty.style.display = 'block';
  }
}

function closeFollowModal(){
  followModal.style.display = 'none';
  document.body.style.overflow = '';
}

followModalClose?.addEventListener('click', closeFollowModal);
followModal?.addEventListener('click', (e)=>{
  if(e.target === followModal){
    closeFollowModal();
  }
});

/* Profil + stats counters */
function updateStatsLine(){
  const avgTxt = (window._ridlyProfile?.accountAvg != null)
    ? `Moyenne compte : ${window._ridlyProfile.accountAvg.toFixed(1)} / 5`
    : `Moyenne compte : ‚Äî`;

  const html = `
    ${window._ridlyProfile?.countPosts || 0} posts ‚Ä¢
    ${window._ridlyProfile?.countFlashes || 0} flashs ‚Ä¢
    <button type="button" class="chip-link" id="followersBtn">${window._ridlyProfile?.followersCount || 0} abonn√©s</button> ‚Ä¢
    <button type="button" class="chip-link" id="followingBtn">${window._ridlyProfile?.followingCount || 0} abonnements</button> ‚Ä¢
    ${avgTxt}
  `;
  pStats.innerHTML = html;

  const followersBtn = document.getElementById('followersBtn');
  const followingBtn = document.getElementById('followingBtn');
  if(followersBtn){
    followersBtn.addEventListener('click', ()=>openFollowModal('followers'));
  }
  if(followingBtn){
    followingBtn.addEventListener('click', ()=>openFollowModal('following'));
  }
}

(async function init(){
  const { data:{ user } } = await supa.auth.getUser();
  sessionUser = user || null;

  if(sessionUser){
    if(btnLogout){
      btnLogout.style.display = 'flex';
      btnLogout.onclick = async ()=>{
        await supa.auth.signOut();
        location.href = "index.html";
      };
    }

    checkPrivateUnread(sessionUser);
    subscribePrivateAlerts(sessionUser);
  }

  if(qId){
    profileUserId = qId;
  }else if(qUser){
    const { data } = await supa
      .from('profiles')
      .select('id')
      .or(`pseudo.eq.${qUser},username.eq.${qUser}`)
      .maybeSingle();
    profileUserId = data?.id || null;
  }else{
    profileUserId = sessionUser?.id || null;
  }

  if(!profileUserId){
    pName.textContent = "Profil introuvable";
    return;
  }

  window._ridlyProfile = {
    sessionUser,
    profileUserId,
    isOwn: !!(sessionUser && sessionUser.id === profileUserId),
    isAdmin:false,
    countPosts:0,
    countFlashes:0,
    followersCount:0,
    followingCount:0,
    isFollowing:false,
    accountAvg:null,
    spotStats:[],
    localSpot:null,
    totalSecondsAll:0
  };

  await loadProfile();
  await loadFlashes();
  await loadPosts();
  await loadFollowState();
  await loadSpotStats();
  buildActions();
})();

async function loadProfile(){
  const { sessionUser, profileUserId } = window._ridlyProfile;
  const { data:prof } = await supa
    .from('profiles')
    .select('*')
    .eq('id', profileUserId)
    .maybeSingle();

  if(!prof){
    pName.textContent = "Profil introuvable";
    return;
  }

  window._ridlyProfile.isAdmin = !!prof.is_admin;

  const displayName =
    prof.pseudo ||
    prof.username ||
    prof.full_name ||
    (sessionUser?.email || 'Rider');

  pName.textContent = displayName;

  const locParts = [];
  if(prof.city)    locParts.push(prof.city);
  if(prof.canton)  locParts.push(prof.canton);
  if(prof.country) locParts.push(prof.country);
  const loc = locParts.join(' ‚Ä¢ ');
  const genderTxt = prof.gender || '';
  pSub.textContent = [loc || '‚Äî', genderTxt].filter(Boolean).join(' ‚Ä¢ ');

  avatarImg.src = prof.avatar_url || "image/logo_pn360.png";

  if(window._ridlyProfile.isOwn){
    fPseudo.value   = prof.pseudo || prof.username || "";
    fFullname.value = prof.full_name || "";
    fCity.value     = prof.city || "";
    fCanton.value   = prof.canton || "";
    fCountry.value  = prof.country || "";
    fInsta.value    = prof.insta_url || "";
    fBio.value      = prof.bio || "";
    fGender.value   = prof.gender || "";
  }
}

/* Follow state */
async function loadFollowState(){
  const { profileUserId, sessionUser } = window._ridlyProfile;
  window._ridlyProfile.followersCount = 0;
  window._ridlyProfile.followingCount = 0;
  window._ridlyProfile.isFollowing    = false;

  if(!profileUserId){ updateStatsLine(); return; }
  try{
    const { count:followers } = await supa
      .from('rider_follows')
      .select('*', { count:'exact', head:true })
      .eq('followed_id', profileUserId);
    window._ridlyProfile.followersCount = followers || 0;

    const { count:following } = await supa
      .from('rider_follows')
      .select('*', { count:'exact', head:true })
      .eq('follower_id', profileUserId);
    window._ridlyProfile.followingCount = following || 0;

    if(sessionUser){
      const { data:rows } = await supa
        .from('rider_follows')
        .select('id')
        .eq('follower_id', sessionUser.id)
        .eq('followed_id', profileUserId)
        .limit(1);
      window._ridlyProfile.isFollowing = !!(rows && rows.length);
    }else{
      window._ridlyProfile.isFollowing = false;
    }
    updateStatsLine();
  }catch(e){
    console.error(e);
    updateStatsLine();
  }
}

function buildActions(){
  const { isOwn, isAdmin, profileUserId, sessionUser, isFollowing } = window._ridlyProfile;
  actionsBox.innerHTML = "";
  if(isOwn){
    if(isAdmin){
      actionsBox.append(
        makeBtn("‚öôÔ∏è Admin spots", () => {
          window.location.href = "admin_spots.html";
        })
      );
    }

    actionsBox.append(
      makeBtn("‚úèÔ∏è √âditer", toggleEdit)
    );
    btnNewPost.style.display = "inline-block";
    btnNewPost.onclick = ()=>location.href="ajouter.html";
  }else{
    if(sessionUser){
      const chatBtn = makeBtn("üí¨ Chat priv√©", () => {
        window.location.href = 'chat1v1.html?to=' + encodeURIComponent(profileUserId);
      });
      const followBtn = makeBtn(isFollowing ? "Se d√©sabonner" : "S‚Äôabonner", toggleFollow);
      followBtn.id = "followBtn";
      if(isFollowing) followBtn.classList.add('green');
      actionsBox.append(chatBtn, followBtn);
    }else{
      actionsBox.append(
        makeBtn("Se connecter pour suivre", ()=>{ window.location.href = "compte.html"; })
      );
    }
  }
}

function makeBtn(txt, fn){
  const b = document.createElement('button');
  b.type = "button";
  b.className = "btn";
  b.textContent = txt;
  b.onclick = fn;
  return b;
}

/* Suivre / se d√©sabonner */
async function toggleFollow(){
  const { sessionUser, profileUserId } = window._ridlyProfile;
  if(!sessionUser){
    window.location.href = "compte.html";
    return;
  }
  const btn = document.getElementById('followBtn');
  if(!btn) return;
  btn.disabled = true;

  try{
    if(window._ridlyProfile.isFollowing){
      const { error } = await supa
        .from('rider_follows')
        .delete()
        .eq('follower_id', sessionUser.id)
        .eq('followed_id', profileUserId);
      if(!error){
        window._ridlyProfile.isFollowing = false;
        window._ridlyProfile.followersCount = Math.max(0, window._ridlyProfile.followersCount - 1);
      }
    }else{
      const { error } = await supa
        .from('rider_follows')
        .insert([{ follower_id: sessionUser.id, followed_id: profileUserId }]);
      if(!error){
        window._ridlyProfile.isFollowing = true;
        window._ridlyProfile.followersCount = window._ridlyProfile.followersCount + 1;
      }
    }
  }catch(e){
    console.error(e);
  }finally{
    btn.disabled = false;
    updateStatsLine();
    if(window._ridlyProfile.isFollowing){
      btn.textContent = "Se d√©sabonner";
      btn.classList.add('green');
    }else{
      btn.textContent = "S‚Äôabonner";
      btn.classList.remove('green');
    }
  }
}

function toggleEdit(){
  editForm.style.display = (editForm.style.display === "block") ? "none" : "block";
}

editForm?.addEventListener('submit', async e=>{
  e.preventDefault();
  const { profileUserId } = window._ridlyProfile;
  saveMsg.textContent = "Enregistrement‚Ä¶";

  const up = {
    pseudo:(fPseudo.value||"").trim() || null,
    username:(fPseudo.value||"").trim() || null,
    full_name:(fFullname.value||"").trim() || null,
    city:(fCity.value||"").trim() || null,
    canton:(fCanton.value||"").trim() || null,
    country:(fCountry.value||"").trim() || null,
    insta_url:(fInsta.value||"").trim() || null,
    bio:(fBio.value||"").trim() || null,
    gender:(fGender.value||"").trim() || null
  };

  const { error } = await supa.from('profiles').update(up).eq('id', profileUserId);
  if(error){
    saveMsg.textContent = "Erreur : " + error.message;
    return;
  }
  saveMsg.textContent = "OK ‚úì";
  await loadProfile();
});

avatarInput?.addEventListener('change', async ()=>{
  const { profileUserId } = window._ridlyProfile;
  if(!avatarInput.files?.length) return;
  const f = avatarInput.files[0];
  const safeName = f.name.replace(/[^\w.\-]+/g,'_');
  const path = `${profileUserId}/${Date.now()}-${safeName}`;

  const { error:upErr } = await supa.storage.from('avatars').upload(path, f, { upsert:false });
  if(upErr){
    saveMsg.textContent = "Upload √©chou√©.";
    return;
  }
  const { data:pub } = supa.storage.from('avatars').getPublicUrl(path);
  const url = pub?.publicUrl;
  if(url){
    await supa.from('profiles').update({ avatar_url:url }).eq('id', profileUserId);
    avatarImg.src = url;
    saveMsg.textContent = "Avatar mis √† jour ‚úì";
  }
});

/* Flashes */
async function loadFlashes(){
  const { profileUserId } = window._ridlyProfile;
  const { data:fl } = await supa
    .from('flashes')
    .select('id,media_url,caption,created_at,expires_at')
    .eq('user_id', profileUserId)
    .gt('expires_at', new Date().toISOString())
    .order('created_at',{ascending:false})
    .limit(20);

  const list = fl || [];
  flashStrip.innerHTML = "";
  window._ridlyProfile.countFlashes = list.length;
  updateStatsLine();

  list.forEach(f=>{
    const d = document.createElement('div');
    d.className = "flash";
    const isVideo = /\.(mp4|webm|mov)$/i.test(f.media_url||"");
    d.innerHTML = `
      <div class="ring">
        <div class="inner">
          ${isVideo
            ? `<video src="${f.media_url}" muted playsinline></video>`
            : `<img src="${f.media_url}" alt="">`}
        </div>
      </div>
      <div class="cap">${(f.caption||"").slice(0,18)}</div>
      ${window._ridlyProfile.isOwn ? `
        <div class="flash-actions">
          <button type="button" data-id="${f.id}" data-act="repost" title="Repartager">‚Ü∫</button>
          <button type="button" data-id="${f.id}" data-act="delete" title="Supprimer">‚úï</button>
        </div>` : ``}
    `;
    d.addEventListener('click',()=>window.open(f.media_url,'_blank'));
    flashStrip.appendChild(d);
  });

  if(window._ridlyProfile.isOwn){
    flashStrip.querySelectorAll('.flash-actions button').forEach(btn=>{
      btn.addEventListener('click', async ev=>{
        ev.stopPropagation();
        const id  = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        if(act === 'delete'){
          if(!confirm('Supprimer ce flash ?')) return;
          await supa.from('flashes').delete().eq('id', id);
          loadFlashes();
        }else if(act === 'repost'){
          await supa.from('flashes').update({
            created_at:new Date().toISOString()
          }).eq('id', id);
          loadFlashes();
        }
      });
    });
  }
}

/* Posts */
async function loadPosts(){
  const { profileUserId } = window._ridlyProfile;
  const { data:posts } = await supa
    .from('spot_posts')
    .select('id,media_url,caption,spot_type,created_at')
    .eq('user_id', profileUserId)
    .order('created_at',{ascending:false})
    .limit(60);

  const list = posts || [];
  postGrid.innerHTML = "";
  window._ridlyProfile.countPosts = list.length;
  updateStatsLine();

  if(!list.length){
    postsEmpty.style.display = "block";
    return;
  }
  postsEmpty.style.display = "none";

  list.forEach(p=>{
    const isVideo = /\.(mp4|webm|mov)$/i.test(p.media_url||"");
    const a = document.createElement('a');
    a.className = "thumb";
    a.href = p.media_url;
    a.target = "_blank";
    a.innerHTML = `
      ${isVideo
        ? `<video src="${p.media_url}" muted playsinline></video>`
        : `<img src="${p.media_url}" alt="">`}
      <span class="tag">${p.spot_type==='street'?'Street':'Park'}</span>
      ${window._ridlyProfile.isOwn ? `<button type="button" class="thumb-del" data-id="${p.id}" title="Supprimer">‚úï</button>` : ``}
    `;
    postGrid.appendChild(a);
  });

  if(window._ridlyProfile.isOwn){
    postGrid.querySelectorAll('.thumb-del').forEach(btn=>{
      btn.addEventListener('click', async ev=>{
        ev.preventDefault();
        ev.stopPropagation();
        if(!confirm('Supprimer ce post ?')) return;
        await supa.from('spot_posts').delete().eq('id', btn.getAttribute('data-id'));
        loadPosts();
      });
    });
  }

  try{
    const ids = list.map(p=>p.id);
    if(!ids.length){ window._ridlyProfile.accountAvg = null; updateStatsLine(); return; }
    const { data:likes } = await supa
      .from('post_likes')
      .select('post_id,rating')
      .in('post_id', ids);
    if(likes && likes.length){
      const sum = likes.reduce((a,b)=> a + (b.rating || 0), 0);
      window._ridlyProfile.accountAvg = sum / likes.length;
    }else{
      window._ridlyProfile.accountAvg = null;
    }
    updateStatsLine();
  }catch(e){
    console.error(e);
  }
}

/* Stats spots RIDLY (sessions) */
async function loadSpotStats(){
  const { profileUserId } = window._ridlyProfile;
  if(!profileUserId) return;

  try{
    const { data:rows, error } = await supa
      .from('rider_spot_stats')
      .select('spot_id,total_seconds,points')
      .eq('user_id', profileUserId)
      .order('total_seconds',{ascending:false});

    if(error){
      console.error(error);
      return;
    }

    const stats = rows || [];
    window._ridlyProfile.spotStats = stats;

    if(!stats.length){
      if(spotStatsEmpty) spotStatsEmpty.style.display = 'block';
      if(spotStatsList)  spotStatsList.innerHTML = '';
      if(pLocalPark)     pLocalPark.textContent = "Skatepark local : ‚Äî";
      return;
    }

    const spotIds = stats.map(r=>r.spot_id);
    const { data:spots, error:err2 } = await supa
      .from('spots')
      .select('id,nom,ville,canton,country')
      .in('id', spotIds);

    if(err2){
      console.error(err2);
    }

    const spotMap = {};
    (spots || []).forEach(s=>{ spotMap[s.id] = s; });

    const totalSecondsAll = stats.reduce((s,r)=>s + (r.total_seconds || 0), 0);
    window._ridlyProfile.totalSecondsAll = totalSecondsAll;

    const top = stats[0];
    const topSpot = spotMap[top.spot_id];
    window._ridlyProfile.localSpot = { stat:top, spot:topSpot };

    if(pLocalPark){
      const hoursTop  = Math.round((top.total_seconds || 0) / 3600);
      const hoursAll  = Math.round(totalSecondsAll / 3600);
      const pts       = (top.points != null) ? top.points : Math.floor((top.total_seconds || 0) / 3600);
      const txtPark   = topSpot ? (topSpot.nom || "Skatepark") : "Skatepark";
      const locParts  = [];
      if(topSpot?.ville)   locParts.push(topSpot.ville);
      if(topSpot?.canton)  locParts.push(topSpot.canton);
      const loc = locParts.join(' ‚Ä¢ ');
      pLocalPark.textContent =
        `Skatepark local : ${txtPark}${loc ? ' ‚Ä¢ '+loc : ''} ‚Ä¢ ${hoursTop}h ici ‚Ä¢ ${pts} pts`;
    }

    if(spotStatsEmpty) spotStatsEmpty.style.display = 'none';
    if(spotStatsList){
      spotStatsList.innerHTML = '';

      if(totalSecondsAll && totalSecondsAll > 0){
        const totalHours = (totalSecondsAll/3600).toFixed(1).replace('.0','');
        const totalDiv = document.createElement('div');
        totalDiv.className = 'spotstats-row';
        totalDiv.innerHTML = `
          <div class="spotstats-main">
            <div class="spotstats-title">Total RIDLY</div>
            <div class="spotstats-sub">${totalHours} h sur les spots</div>
          </div>
          <div class="spotstats-points">${Math.floor(totalSecondsAll/3600)} pts</div>
        `;
        spotStatsList.appendChild(totalDiv);
      }

      stats.forEach(row=>{
        const s = spotMap[row.spot_id];
        const title = s?.nom || "Skatepark";
        const locParts = [];
        if(s?.ville)  locParts.push(s.ville);
        if(s?.canton) locParts.push(s.canton);
        const loc = locParts.join(' ‚Ä¢ ');
        const hours = (row.total_seconds || 0) / 3600;
        const hoursStr = hours.toFixed(1).replace('.0','');
        const pts = (row.points != null) ? row.points : Math.floor((row.total_seconds || 0)/3600);

        const div = document.createElement('div');
        div.className = 'spotstats-row';
        div.innerHTML = `
          <div class="spotstats-main">
            <div class="spotstats-title">${title}</div>
            <div class="spotstats-sub">${loc || '‚Äî'} ‚Ä¢ ${hoursStr} h</div>
          </div>
          <div class="spotstats-points">${pts} pts</div>
        `;
        spotStatsList.appendChild(div);
      });
    }

  }catch(e){
    console.error(e);
  }
}
</script>

<!-- Firebase Notifications -->
<script src="js/firebase.js" type="module"></script>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/firebase-messaging-sw.js")
      .then(reg => console.log("SW FCM OK"))
      .catch(err => console.error("SW FCM ERROR", err));
  }
</script>

</body>
</html>