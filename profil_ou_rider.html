<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <title>Profil ‚Äî RIDLY</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/env.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#22c55e;
      --green-dark:#16a34a;

      --bg:#020617;
      --bg-soft:#030712;
      --panel:#020617;
      --panel-soft:#020617;
      --text:#f9fafb;
      --dim:#9ca3af;
      --border:rgba(148,163,184,.4);
      --radius-xl:18px;
    }

    body.theme-dark{
      --bg:#020617;
      --bg-soft:#030712;
      --panel:#020617;
      --panel-soft:#020617;
      --text:#f9fafb;
      --dim:#9ca3af;
      --border:rgba(148,163,184,.4);
    }
    body.theme-light{
      --bg:#f3f4f6;
      --bg-soft:#e5e7eb;
      --panel:#ffffff;
      --panel-soft:#e5e7eb;
      --text:#020617;
      --dim:#4b5563;
      --border:rgba(148,163,184,.25);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;padding:0}
    body{
      background:#000;
      color:var(--text);
      font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      flex-direction:column;
    }

    /* BG vid√©o */
    .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
    .rsl-bg-video{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;
      filter:brightness(.48) saturate(1.05);
    }
    .rsl-bg-dim{
      position:absolute;inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.7));
    }
    body.theme-light .rsl-bg-dim{
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.96));
    }

    .page-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:800px;
      margin:0 auto;
      width:100%;
      position:relative;
      z-index:1;
    }

    /* NAV top (style feed/games/classement) */
    nav.nav{
      position:sticky;
      top:0;
      z-index:20;
      background:rgba(2,6,23,.9);
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
    }
    body.theme-light nav.nav{
      background:rgba(244,244,245,.95);
    }
    nav.nav .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 14px;
    }
    .nav-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      color:var(--text);
    }
    .brand img{
      width:32px;
      height:32px;
      border-radius:12px;
      background:#000;
      padding:3px;
      box-shadow:0 0 12px rgba(34,197,94,.7);
    }
    .brand span{
      font-weight:700;
      letter-spacing:-0.03em;
      font-size:20px;
    }
    .add-btn{
      border:none;
      outline:none;
      width:30px;
      height:30px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
      background:radial-gradient(circle at 30% 20%,#4ade80 0,#22c55e 35%,#16a34a 100%);
      color:#022c16;
      box-shadow:0 10px 22px rgba(34,197,94,.7);
    }
    .add-btn span{transform:translateY(-1px);}

    .nav-tools{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }
    .icon-btn{
      border:1px solid rgba(15,23,42,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      border-radius:999px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      text-decoration:none;
      position:relative;
      cursor:pointer;
    }
    body.theme-light .icon-btn{
      background:#e5e7eb;
      border-color:rgba(148,163,184,.6);
    }
    .icon-btn:hover{
      border-color:var(--green);
      color:var(--green);
    }
    .chat-dot{
      position:absolute;
      top:5px;
      right:5px;
      width:8px;
      height:8px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.9);
      opacity:0;
    }

    /* Mini titre */
    .mini-title{
      padding:10px 10px 0;
      font-size:13px;
      font-weight:600;
      color:var(--dim);
    }
    .page-intro{
      font-size:13px;
      color:var(--dim);
      padding:2px 10px 8px;
      line-height:1.4;
    }

    main.main{
      flex:1;
      padding:0 10px 90px;
    }

    /* Card profil */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      box-shadow:0 22px 60px rgba(0,0,0,.85);
      padding:14px;
      margin-top:4px;
    }
    body.theme-light .card{
      box-shadow:0 18px 45px rgba(15,23,42,.15);
    }

    .p-head{
      display:grid;
      grid-template-columns:84px 1fr auto;
      gap:12px;
      align-items:flex-start;
    }
    @media(max-width:720px){
      .p-head{
        grid-template-columns:72px 1fr;
        grid-template-rows:auto auto;
      }
      .p-actions{
        grid-column:1/-1;
        margin-top:10px;
      }
    }
    .avatar{
      width:84px;
      height:84px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    body.theme-light .avatar{
      background:#e5e7eb;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .name{
      font-size:21px;
      font-weight:800;
      margin:0;
      color:var(--text);
    }
    .meta-line{
      font-size:12px;
      color:var(--dim);
      margin-top:4px;
      font-weight:600;
    }
    .loc-line{
      font-size:12px;
      color:var(--dim);
      margin-top:2px;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--text);
      font-weight:700;
      font-size:13px;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
    }
    body.theme-light .btn{
      background:#e5e7eb;
    }
    .btn.green{
      background:linear-gradient(180deg,var(--green),var(--green-dark));
      color:#062312;
      border:none;
      box-shadow:0 10px 24px rgba(0,0,0,.5);
    }
    .p-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    /* Flashes (stories) */
    .flash-strip{
      margin-top:12px;
      display:flex;
      gap:12px;
      overflow:auto;
      padding-bottom:4px;
    }
    .flash{
      flex:0 0 auto;
      width:70px;
      position:relative;
      cursor:pointer;
    }
    .flash .ring{
      width:70px;
      height:70px;
      border-radius:50%;
      padding:3px;
      background:conic-gradient(#ffd54a,#ff7b54,#ff5478,#8b5cf6,#ffd54a);
    }
    .flash .inner{
      width:100%;
      height:100%;
      border-radius:50%;
      overflow:hidden;
      background:#000;
      border:2px solid #000;
    }
    .flash img,.flash video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:brightness(.95);
    }
    .flash .cap{
      font-size:10px;
      text-align:center;
      margin-top:4px;
      color:#cdd6ff;
    }
    .flash-actions{
      position:absolute;
      right:4px;
      bottom:2px;
      display:flex;
      gap:4px;
    }
    .flash-actions button{
      border:0;
      background:rgba(0,0,0,.75);
      color:#f9fafb;
      border-radius:999px;
      width:18px;
      height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      cursor:pointer;
    }

    /* Form edit */
    .edit{
      margin-top:14px;
      display:none;
    }
    .row-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    .row-grid .full{grid-column:1/-1}
    label{
      display:block;
      font-size:11px;
      font-weight:700;
      color:#e2e8f0;
      margin:4px 0 4px;
    }
    .input,textarea.input,select.input{
      width:100%;
      background:#020617;
      border:1px solid var(--border);
      border-radius:10px;
      color:#fff;
      padding:8px 10px;
      font-size:13px;
    }
    body.theme-light .input,
    body.theme-light textarea.input,
    body.theme-light select.input{
      background:#f9fafb;
      color:#020617;
      border-color:rgba(15,23,42,.15);
    }

    /* Posts grid */
    .posts-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .posts-header h2{
      margin:0;
      font-size:15px;
      font-weight:800;
    }
    .post-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }
    @media (max-width:720px){
      .post-grid{grid-template-columns:repeat(2,1fr);}
    }
    .thumb{
      position:relative;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#000;
      display:block;
    }
    .thumb img,.thumb video{
      display:block;
      width:100%;
      height:100%;
      object-fit:cover;
      aspect-ratio:1/1;
    }
    .thumb .tag{
      position:absolute;
      left:6px;
      top:6px;
      font-size:10px;
      font-weight:800;
      background:rgba(0,0,0,.6);
      border:1px solid var(--border);
      padding:3px 6px;
      border-radius:999px;
    }
    .thumb-del{
      position:absolute;
      right:4px;
      top:4px;
      width:20px;
      height:20px;
      border-radius:999px;
      border:0;
      background:rgba(0,0,0,.78);
      color:#f9fafb;
      font-size:12px;
      cursor:pointer;
    }
    .empty{
      color:var(--dim);
      text-align:center;
      margin:14px 0 4px;
      font-size:13px;
    }

    /* Tabbar */
    .tabbar{
      position:fixed;
      left:0;right:0;bottom:0;
      z-index:30;
      display:flex;
      align-items:center;
      justify-content:space-around;
      padding:6px 8px 10px;
      border-top:1px solid var(--border);
      background:rgba(2,6,23,.97);
      backdrop-filter:blur(18px);
    }
    body.theme-light .tabbar{
      background:rgba(244,244,245,.97);
    }
    .tab{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      text-decoration:none;
      color:var(--dim);
      font-size:9px;
      letter-spacing:.04em;
      text-transform:uppercase;
      padding:4px 0;
    }
    .tab .ic{font-size:20px;line-height:1;}
    .tab.active{color:var(--green);}
    @media(min-width:900px){
      nav.nav .row{padding-inline:20px;}
      main.main{padding-inline:14px;}
      .tabbar{border-radius:22px 22px 0 0;}
    }
  </style>
</head>
<body class="theme-dark">

<!-- BG vid√©o RIDLY -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<div class="page-wrap">

  <!-- Nav top -->
  <nav class="nav">
    <div class="row">
      <div class="nav-left">
        <a class="brand" href="ou_rider.html">
          <img src="image/1logo_ridly.png" alt="RIDLY"/>
          <span>RIDLY</span>
        </a>
        <button type="button" class="add-btn" onclick="window.location.href='ajouter.html'" title="Nouvelle publication">
          <span>+</span>
        </button>
      </div>
      <div class="nav-tools">
        <button type="button" class="icon-btn" id="btnTheme" title="Mode clair / sombre">üåô</button>
        <a href="chat.html" class="icon-btn" id="btnChat" title="Chat riders">
          <span class="chat-dot" id="chatDot"></span>
          üí¨
        </a>
        <!-- D√©connexion discr√®te en haut -->
        <button type="button" class="icon-btn" id="btnLogout" title="D√©connexion" style="display:none">‚èª</button>
      </div>
    </div>
  </nav>

  <!-- Mini hero style feed -->
  <div class="mini-title">Profil rider</div>
  <p class="page-intro">
    G√®re ton profil RIDLY, tes stories (flashs) et tes posts dans le feed.
  </p>

  <main class="main">
    <section class="card">
      <div class="p-head">
        <div class="avatar">
          <img id="avatarImg" alt="avatar" src="image/logo_pn360.png"/>
        </div>
        <div>
          <h1 class="name" id="pName">‚Äî</h1>
          <div class="meta-line" id="pStats">0 posts ‚Ä¢ 0 flashs ‚Ä¢ 0 abonn√©s ‚Ä¢ Moyenne compte : ‚Äî</div>
          <div class="loc-line" id="pSub">‚Äî</div>
        </div>
        <div class="p-actions" id="actionsBox"></div>
      </div>

      <div id="flashStrip" class="flash-strip"></div>

      <form id="editForm" class="edit">
        <div class="row-grid">
          <div>
            <label for="fPseudo">Pseudo</label>
            <input id="fPseudo" class="input" type="text" placeholder="rider_name"/>
          </div>
          <div>
            <label for="fFullname">Nom complet</label>
            <input id="fFullname" class="input" type="text" placeholder="Pr√©nom Nom"/>
          </div>
          <div>
            <label for="fCity">Ville</label>
            <input id="fCity" class="input" type="text" placeholder="Montreux"/>
          </div>
          <div>
            <label for="fCanton">Canton</label>
            <input id="fCanton" class="input" type="text" placeholder="VD"/>
          </div>
          <div>
            <label for="fCountry">Pays</label>
            <select id="fCountry" class="input">
              <option value="">‚Äî</option>
              <option value="Suisse">Suisse</option>
              <option value="France">France</option>
              <option value="Allemagne">Allemagne</option>
              <option value="Autre Europe">Autre Europe</option>
              <option value="Monde">Monde</option>
            </select>
          </div>
          <div>
            <label for="fGender">Genre</label>
            <select id="fGender" class="input">
              <option value="">Non sp√©cifi√©</option>
              <option value="Homme">Homme</option>
              <option value="Femme">Femme</option>
            </select>
          </div>
          <div class="full">
            <label for="fInsta">Instagram (URL)</label>
            <input id="fInsta" class="input" type="url" placeholder="https://instagram.com/moncompte"/>
          </div>
          <div class="full">
            <label for="fBio">Bio</label>
            <textarea id="fBio" class="input" rows="3" placeholder="Quelques lignes sur toi‚Ä¶"></textarea>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap">
          <label class="btn" for="fAvatar">Changer l‚Äôavatar</label>
          <input id="fAvatar" type="file" accept="image/*" style="display:none"/>
          <button class="btn green" id="btnSave" type="submit">Enregistrer</button>
          <span id="saveMsg" style="color:#9aa5b1;font-size:12px"></span>
        </div>
      </form>
    </section>

    <!-- Posts -->
    <section class="card" style="margin-top:14px">
      <div class="posts-header">
        <h2>Posts</h2>
        <button class="btn" id="btnNewPost" style="display:none">+ Nouveau post</button>
      </div>
      <div id="postGrid" class="post-grid"></div>
      <p id="postsEmpty" class="empty" style="display:none">Aucun post pour l‚Äôinstant.</p>
    </section>
  </main>
</div>

<!-- Tabbar -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab" href="ou_rider.html" title="Spots">
    <div class="ic">üìç</div><span>Spots</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Search</span>
  </a>
  <a class="tab" href="games.html" title="Games">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Rank</span>
  </a>
  <a class="tab active" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<!-- Th√®me (m√™me logique que feed.html) -->
<script>
(function(){
  const saved = localStorage.getItem('ridlyTheme') || 'dark';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
  document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

  const btnTheme = document.getElementById('btnTheme');
  const updateIcon = () => {
    const isLight = document.body.classList.contains('theme-light');
    btnTheme.textContent = isLight ? ‚òÄÔ∏è' : 'üåô';
  };
  updateIcon();

  btnTheme.addEventListener('click', ()=>{
    const isLight = document.body.classList.contains('theme-light');
    document.body.classList.toggle('theme-light', !isLight);
    document.body.classList.toggle('theme-dark',  isLight);
    localStorage.setItem('ridlyTheme', isLight ? 'dark' : 'light');
    updateIcon();
  });
})();
</script>

<!-- Supabase init + BG vid√©o -->
<script>
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

(function(){
  const v = document.getElementById('rslBg');
  if(!v) return;
  const s = document.createElement('source');
  s.src = SUPABASE_URL + "/storage/v1/object/public/ridly/ridly.mp4";
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{ try{ v.playbackRate = 0.6; const p=v.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} };
  play();
  document.addEventListener('visibilitychange',()=>{ document.hidden ? v.pause() : play(); });
})();
</script>

<!-- Profil logic -->
<script>
const params = new URLSearchParams(location.search);
const qId    = params.get('id');
const qUser  = params.get('u');

const avatarImg   = document.getElementById('avatarImg');
const pName       = document.getElementById('pName');
const pSub        = document.getElementById('pSub');
const pStats      = document.getElementById('pStats');
const actionsBox  = document.getElementById('actionsBox');
const editForm    = document.getElementById('editForm');
const saveMsg     = document.getElementById('saveMsg');
const flashStrip  = document.getElementById('flashStrip');
const postGrid    = document.getElementById('postGrid');
const postsEmpty  = document.getElementById('postsEmpty');
const btnNewPost  = document.getElementById('btnNewPost');
const chatDot     = document.getElementById('chatDot');
const btnLogout   = document.getElementById('btnLogout');

const avatarInput = document.getElementById('fAvatar');
const fPseudo     = document.getElementById('fPseudo');
const fFullname   = document.getElementById('fFullname');
const fCity       = document.getElementById('fCity');
const fCanton     = document.getElementById('fCanton');
const fCountry    = document.getElementById('fCountry');
const fInsta      = document.getElementById('fInsta');
const fBio        = document.getElementById('fBio');
const fGender     = document.getElementById('fGender');

let sessionUser   = null;
let profileUserId = null;
let isOwn         = false;

let countPosts = 0;
let countFlashes = 0;
let accountAvg = null;
let followersCount = 0;
let isFollowing    = false;

function updateStatsLine(){
  const avgTxt = (accountAvg != null)
    ? `Moyenne compte : ${accountAvg.toFixed(1)} / 5`
    : `Moyenne compte : ‚Äî`;
  pStats.textContent = `${countPosts} posts ‚Ä¢ ${countFlashes} flashs ‚Ä¢ ${followersCount} abonn√©s ‚Ä¢ ${avgTxt}`;
}

(async function init(){
  const { data:{ user } } = await supa.auth.getUser();
  sessionUser = user || null;
  if(sessionUser && chatDot) chatDot.style.opacity = 1;

  // bouton d√©connexion top bar
  if(sessionUser && btnLogout){
    btnLogout.style.display = 'flex';
    btnLogout.onclick = async ()=>{
      await supa.auth.signOut();
      location.href = "index.html";
    };
  }

  if(qId){
    profileUserId = qId;
  }else if(qUser){
    const { data } = await supa
      .from('profiles')
      .select('id')
      .or(`pseudo.eq.${qUser},username.eq.${qUser}`)
      .maybeSingle();
    profileUserId = data?.id || null;
  }else{
    profileUserId = sessionUser?.id || null;
  }

  if(!profileUserId){
    pName.textContent = "Profil introuvable";
    return;
  }

  isOwn = !!(sessionUser && sessionUser.id === profileUserId);

  await loadProfile();
  await loadFlashes();
  await loadPosts();
  await loadFollowState();
  buildActions();
})();

async function loadProfile(){
  const { data:prof } = await supa
    .from('profiles')
    .select('*')
    .eq('id', profileUserId)
    .maybeSingle();

  if(!prof){
    pName.textContent = "Profil introuvable";
    return;
  }

  const displayName =
    prof.pseudo ||
    prof.username ||
    prof.full_name ||
    (sessionUser?.email || 'Rider');

  pName.textContent = displayName;

  const locParts = [];
  if(prof.city)    locParts.push(prof.city);
  if(prof.canton)  locParts.push(prof.canton);
  if(prof.country) locParts.push(prof.country);
  const loc = locParts.join(' ‚Ä¢ ');
  const genderTxt = prof.gender || '';
  pSub.textContent = [loc || '‚Äî', genderTxt].filter(Boolean).join(' ‚Ä¢ ');

  avatarImg.src = prof.avatar_url || "image/logo_pn360.png";

  if(isOwn){
    fPseudo.value   = prof.pseudo || prof.username || "";
    fFullname.value = prof.full_name || "";
    fCity.value     = prof.city || "";
    fCanton.value   = prof.canton || "";
    fCountry.value  = prof.country || "";
    fInsta.value    = prof.insta_url || "";
    fBio.value      = prof.bio || "";
    fGender.value   = prof.gender || "";
  }
}

/* Charge nb d'abonn√©s + si moi je suis abonn√© */
async function loadFollowState(){
  followersCount = 0;
  isFollowing = false;
  if(!profileUserId){
    updateStatsLine();
    return;
  }
  try{
    const { count } = await supa
      .from('rider_follows')
      .select('*', { count:'exact', head:true })
      .eq('followed_id', profileUserId);
    followersCount = count || 0;

    if(sessionUser){
      const { data:rows } = await supa
        .from('rider_follows')
        .select('id')
        .eq('follower_id', sessionUser.id)
        .eq('followed_id', profileUserId)
        .limit(1);
      isFollowing = !!(rows && rows.length);
    }else{
      isFollowing = false;
    }
    updateStatsLine();
  }catch(e){
    console.error(e);
    updateStatsLine();
  }
}

function buildActions(){
  actionsBox.innerHTML = "";
  if(isOwn){
    // mon profil : juste √âditer (plus de bouton + Flash)
    actionsBox.append(
      makeBtn("‚úèÔ∏è √âditer", toggleEdit)
    );
    btnNewPost.style.display = "inline-block";
    btnNewPost.onclick = ()=>location.href="ajouter.html";
  }else{
    // profil d‚Äôun autre rider
    if(sessionUser){
      const chatBtn = makeBtn("üí¨ Chat priv√©", () => {
        window.location.href = 'chat1v1.html?to=' + encodeURIComponent(profileUserId);
      });
      const followBtn = makeBtn(isFollowing ? "Se d√©sabonner" : "S‚Äôabonner", toggleFollow);
      followBtn.id = "followBtn";
      if(isFollowing) followBtn.classList.add('green');
      actionsBox.append(chatBtn, followBtn);
    }else{
      actionsBox.append(
        makeBtn("Se connecter pour suivre", ()=>{ window.location.href = "compte.html"; })
      );
    }
  }
}

function makeBtn(txt, fn){
  const b = document.createElement('button');
  b.type = "button";
  b.className = "btn";
  b.textContent = txt;
  b.onclick = fn;
  return b;
}

/* Suivre / se d√©sabonner */
async function toggleFollow(){
  if(!sessionUser){
    window.location.href = "compte.html";
    return;
  }
  const btn = document.getElementById('followBtn');
  if(!btn) return;
  btn.disabled = true;

  try{
    if(isFollowing){
      const { error } = await supa
        .from('rider_follows')
        .delete()
        .eq('follower_id', sessionUser.id)
        .eq('followed_id', profileUserId);
      if(!error){
        isFollowing = false;
        followersCount = Math.max(0, followersCount - 1);
      }
    }else{
      const { error } = await supa
        .from('rider_follows')
        .insert([{ follower_id: sessionUser.id, followed_id: profileUserId }]);
      if(!error){
        isFollowing = true;
        followersCount = followersCount + 1;
      }
    }
  }catch(e){
    console.error(e);
  }finally{
    btn.disabled = false;
    updateStatsLine();
    if(isFollowing){
      btn.textContent = "Se d√©sabonner";
      btn.classList.add('green');
    }else{
      btn.textContent = "S‚Äôabonner";
      btn.classList.remove('green');
    }
  }
}

function toggleEdit(){
  editForm.style.display = (editForm.style.display === "block") ? "none" : "block";
}

editForm?.addEventListener('submit', async e=>{
  e.preventDefault();
  saveMsg.textContent = "Enregistrement‚Ä¶";

  const up = {
    pseudo:(fPseudo.value||"").trim() || null,
    username:(fPseudo.value||"").trim() || null,
    full_name:(fFullname.value||"").trim() || null,
    city:(fCity.value||"").trim() || null,
    canton:(fCanton.value||"").trim() || null,
    country:(fCountry.value||"").trim() || null,
    insta_url:(fInsta.value||"").trim() || null,
    bio:(fBio.value||"").trim() || null,
    gender:(fGender.value||"").trim() || null
  };

  const { error } = await supa.from('profiles').update(up).eq('id', profileUserId);
  if(error){
    saveMsg.textContent = "Erreur : " + error.message;
    return;
  }
  saveMsg.textContent = "OK ‚úì";
  await loadProfile();
});

avatarInput?.addEventListener('change', async ()=>{
  if(!avatarInput.files?.length) return;
  const f = avatarInput.files[0];
  const safeName = f.name.replace(/[^\w.\-]+/g,'_');
  const path = `${profileUserId}/${Date.now()}-${safeName}`;

  const { error:upErr } = await supa.storage.from('avatars').upload(path, f, { upsert:false });
  if(upErr){
    saveMsg.textContent = "Upload √©chou√©.";
    return;
  }
  const { data:pub } = supa.storage.from('avatars').getPublicUrl(path);
  const url = pub?.publicUrl;
  if(url){
    await supa.from('profiles').update({ avatar_url:url }).eq('id', profileUserId);
    avatarImg.src = url;
    saveMsg.textContent = "Avatar mis √† jour ‚úì";
  }
});

/* Flashes */
async function loadFlashes(){
  const { data:fl } = await supa
    .from('flashes')
    .select('id,media_url,caption,created_at,expires_at')
    .eq('user_id', profileUserId)
    .gt('expires_at', new Date().toISOString())
    .order('created_at',{ascending:false})
    .limit(20);

  const list = fl || [];
  flashStrip.innerHTML = "";
  countFlashes = list.length;
  updateStatsLine();

  list.forEach(f=>{
    const d = document.createElement('div');
    d.className = "flash";
    const isVideo = /\.(mp4|webm|mov)$/i.test(f.media_url||"");
    d.innerHTML = `
      <div class="ring">
        <div class="inner">
          ${isVideo
            ? `<video src="${f.media_url}" muted playsinline></video>`
            : `<img src="${f.media_url}" alt="">`}
        </div>
      </div>
      <div class="cap">${(f.caption||"").slice(0,18)}</div>
      ${isOwn ? `
        <div class="flash-actions">
          <button type="button" data-id="${f.id}" data-act="repost" title="Repartager">‚Ü∫</button>
          <button type="button" data-id="${f.id}" data-act="delete" title="Supprimer">‚úï</button>
        </div>` : ``}
    `;
    d.addEventListener('click',()=>window.open(f.media_url,'_blank'));
    flashStrip.appendChild(d);
  });

  if(isOwn){
    flashStrip.querySelectorAll('.flash-actions button').forEach(btn=>{
      btn.addEventListener('click', async ev=>{
        ev.stopPropagation();
        const id  = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        if(act === 'delete'){
          if(!confirm('Supprimer ce flash ?')) return;
          await supa.from('flashes').delete().eq('id', id);
          loadFlashes();
        }else if(act === 'repost'){
          await supa.from('flashes').update({
            created_at:new Date().toISOString()
          }).eq('id', id);
          loadFlashes();
        }
      });
    });
  }
}

/* Posts */
async function loadPosts(){
  const { data:posts } = await supa
    .from('spot_posts')
    .select('id,media_url,caption,spot_type,created_at')
    .eq('user_id', profileUserId)
    .order('created_at',{ascending:false})
    .limit(60);

  const list = posts || [];
  postGrid.innerHTML = "";
  countPosts = list.length;
  updateStatsLine();

  if(!list.length){
    postsEmpty.style.display = "block";
    return;
  }
  postsEmpty.style.display = "none";

  list.forEach(p=>{
    const isVideo = /\.(mp4|webm|mov)$/i.test(p.media_url||"");
    const a = document.createElement('a');
    a.className = "thumb";
    a.href = p.media_url;
    a.target = "_blank";
    a.innerHTML = `
      ${isVideo
        ? `<video src="${p.media_url}" muted playsinline></video>`
        : `<img src="${p.media_url}" alt="">`}
      <span class="tag">${p.spot_type==='street'?'Street':'Park'}</span>
      ${isOwn ? `<button type="button" class="thumb-del" data-id="${p.id}" title="Supprimer">‚úï</button>` : ``}
    `;
    postGrid.appendChild(a);
  });

  if(isOwn){
    postGrid.querySelectorAll('.thumb-del').forEach(btn=>{
      btn.addEventListener('click', async ev=>{
        ev.preventDefault();
        ev.stopPropagation();
        if(!confirm('Supprimer ce post ?')) return;
        await supa.from('spot_posts').delete().eq('id', btn.getAttribute('data-id'));
        loadPosts();
      });
    });
  }

  try{
    const ids = list.map(p=>p.id);
    if(!ids.length){ accountAvg = null; updateStatsLine(); return; }
    const { data:likes } = await supa
      .from('post_likes')
      .select('post_id,rating')
      .in('post_id', ids);
    if(likes && likes.length){
      const sum = likes.reduce((a,b)=> a + (b.rating || 0), 0);
      accountAvg = sum / likes.length;
    }else{
      accountAvg = null;
    }
    updateStatsLine();
  }catch(e){
    console.error(e);
  }
}
</script>

<script>
  // Service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }
</script>

</body>
</html>
