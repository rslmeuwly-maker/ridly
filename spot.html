<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spot ‚Äî Romandie Scooter League</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --green:#22c55e;
    --green-dark:#16a34a;
    --panel:#0b1220;
    --border:rgba(255,255,255,.15);
    --dim:#9aa5b1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:flex;
    flex-direction:column;
  }
  main{flex:1}

  /* ===== BG vid√©o ===== */
  .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
  .rsl-bg-video{
    position:absolute;inset:0;width:100%;height:100%;
    object-fit:cover;background:#000;
    filter:brightness(.55) saturate(1.05);
  }
  .rsl-bg-dim{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.55))}

  /* ===== NAV top (m√™me style que O√π rider) ===== */
  nav.nav{
    position:sticky;top:0;z-index:1000;
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(8px);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  nav .row{
    max-width:1200px;margin:0 auto;
    padding:12px 20px;
    display:flex;justify-content:space-between;align-items:center;
  }
  nav .brand{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:800;
  }
  nav .brand img{
    height:34px;
    width:34px;
    border-radius:8px;
    background:#fff;
    padding:4px;
  }
  nav a{color:#eaf5ee;text-decoration:none;font-weight:700}
  nav a:hover{color:#22c55e}

  /* ===== Mini hero ===== */
  .page-mini-hero{position:relative;z-index:10;padding:16px 0 6px}
  .page-mini-hero .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .page-mini-hero h1{margin:0 0 6px;font-size:clamp(26px,4vw,38px);font-weight:800}
  .page-mini-hero .loc{color:var(--dim);font:600 14px Outfit;margin:0 0 4px}

  /* ===== Contenu ===== */
  main .container{
    max-width:1200px;
    margin:0 auto 110px;
    padding:0 20px 40px;
    position:relative;
    z-index:10;
  }

  .flag{
    display:inline-block;
    margin:0 0 10px;
    padding:6px 8px;
    border-radius:8px;
    font:800 12px Outfit;
    box-shadow:0 20px 60px rgba(0,0,0,.8);
  }
  .flag.park{
    background:linear-gradient(180deg,#7c3aed,#4c1d95);
    color:#fff;
    text-shadow:0 0 18px rgba(124,58,237,.5);
  }
  .flag.street{
    background:linear-gradient(180deg,#f97316,#b45309);
    color:#1f1308;
    text-shadow:0 0 18px rgba(251,146,60,.5);
  }

  .desc{
    color:#cdd6ff;
    font:500 15px/1.55 Outfit;
    margin:0 0 18px;
    white-space:pre-line;
  }

  #miniMap{
    width:100%;
    height:300px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background:#0b1220;
    margin:0 0 18px;
    box-shadow:0 30px 80px rgba(0,0,0,.8);
  }

  .soon{
    background:rgba(15,23,42,.8);
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
    font:500 14px Outfit;
    color:#fff;
    box-shadow:0 30px 80px rgba(0,0,0,.8);
  }
  .soon .hint{
    color:var(--dim);
    font-size:12px;
    margin-top:8px;
  }

  /* ===== Tabbar (comme ailleurs) ===== */
  .tabbar{
    position:fixed;
    left:0;right:0;bottom:0;
    z-index:2000;
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:14px 18px;
    border-top:1px solid var(--border);
    background:rgba(0,0,0,.78);
    backdrop-filter:blur(10px);
  }
  .tab{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    text-decoration:none;
  }
  .tab .ic{font-size:24px}
  .tab span{font-size:13px;color:#e5e7eb;font-weight:700}
  .tab.active span{color:#22c55e}
  @media(min-width:900px){ .tab span{font-size:12px} }
</style>
</head>
<body>

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<!-- Nav top -->
<nav class="nav">
  <div class="row">
    <a class="brand" href="ou_rider.html">
      <!-- logo app PN360 -->
      <img src="images/logo_pn360.png" alt="PN360"/>
      <span>RSL ‚Äî Romandie Scooter League</span>
    </a>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-left:auto">
      <a href="feed.html">Feed</a>
      <a href="recherche.html">Recherche</a>
      <a href="membres.html">Devenir membre</a>
      <a href="compte.html">Mon compte</a>
      <a href="https://rsl-swiss.ch" class="back-site" style="font-size:13px;color:#e5e7eb;text-decoration:none;font-weight:700;opacity:.9">Retour site RSL</a>
      <a id="btnInstallOuRider"
         href="#"
         style="background:#22c55e;color:#000;font-weight:800;border-radius:999px;
                padding:6px 12px;text-decoration:none;display:inline-flex;
                align-items:center;gap:6px;box-shadow:0 0 10px rgba(34,197,94,.6);font-size:13px;display:none;">
        üì≤ Installer
      </a>
    </div>
  </div>
</nav>

<!-- Mini hero -->
<section class="page-mini-hero">
  <div class="container">
    <div id="flag" class="flag" style="display:none"></div>
    <h1 id="name">Chargement‚Ä¶</h1>
    <div id="loc" class="loc"></div>
  </div>
</section>

<!-- Contenu -->
<main>
  <div class="container">
    <div id="desc" class="desc"></div>

    <div id="miniMap"></div>

    <section class="soon">
      <b>Feed du spot (bient√¥t)</b><br/>
      ‚Ä¢ Derni√®res photos / vid√©os (20s max)<br/>
      ‚Ä¢ Qui a rid√© ici<br/>
      ‚Ä¢ D√©fis / tricks valid√©s
      <div class="hint">
        Pour poster ici, connecte-toi avec ton compte RSL puis publie via l‚Äôonglet <b>Vid√©os</b>.
      </div>
    </section>
  </div>
</main>

<!-- Bottom nav -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab active" href="ou_rider.html" title="Carte / Spots">
    <div class="ic">üè†</div><span>Spots</span>
  </a>
  <a class="tab" href="ajouter.html" title="Ajouter">
    <div class="ic">‚ûï</div><span>Ajouter</span>
  </a>
  <a class="tab" href="feed.html" title="Feed">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Recherche</span>
  </a>
  <a class="tab" href="game.html" title="Game of Scoot">
    <div class="ic">üéÆ</div><span>Game</span>
  </a>
  <a class="tab" href="classement.html" title="Classement">
    <div class="ic">üèÜ</div><span>Classement</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<!-- env.js pour tes vraies cl√©s -->
<script src="js/env.js"></script>
<script>
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== vid√©o fond (m√™me logique que O√π rider) ===== */
(function(){
  const vids = [
    `${SUPABASE_URL}/storage/v1/object/public/videos_rsl/trottvideo1.mp4`,
    `${SUPABASE_URL}/storage/v1/object/public/videos_rsl/trottvideo2.mp4`
  ];
  const v = document.getElementById('rslBg');
  if(!v) return;
  const s = document.createElement('source');
  s.src = vids[Math.floor(Math.random()*vids.length)];
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{ try{ v.playbackRate=.6; const p=v.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} };
  play();
  document.addEventListener('visibilitychange',()=>{ document.hidden? v.pause(): play(); });
})();

/* ===== Chargement du spot ===== */
const params   = new URLSearchParams(location.search);
const spotId   = params.get("id");
const isStreet = params.get("street") === "1";

const elName = document.getElementById('name');
const elLoc  = document.getElementById('loc');
const elDesc = document.getElementById('desc');
const elFlag = document.getElementById('flag');

async function loadSpot(){
  if(!spotId){
    elName.textContent = "Spot introuvable";
    elLoc.textContent  = "";
    elDesc.textContent = "";
    return;
  }

  let row = null;
  if(isStreet){
    const { data } = await supa.from('bunny').select('*').eq('id', spotId).maybeSingle();
    row = data;
  }else{
    const { data } = await supa.from('spots').select('*').eq('id', spotId).maybeSingle();
    row = data;
  }

  if(!row){
    elName.textContent = "Spot introuvable";
    elLoc.textContent  = "";
    elDesc.textContent = "";
    return;
  }

  elName.textContent = row.nom || "Sans nom";
  elLoc.textContent  = `${row.ville || ''} (${row.canton || ''})`;
  elDesc.textContent = row.description || row.type || '';

  elFlag.textContent = isStreet ? "Street / Rider spot ‚ö†" : "Skatepark / Pumptrack";
  elFlag.className   = "flag " + (isStreet ? "street" : "park");
  elFlag.style.display = "inline-block";

  if(row.lat && row.lng){
    const map = L.map('miniMap',{zoomControl:false}).setView([row.lat,row.lng],15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,
      attribution:'¬© OpenStreetMap'
    }).addTo(map);

    const color = isStreet ? '#f97316' : '#7c3aed';
    const icon = L.divIcon({
      className:'rsl-marker',
      html:`<div style="
        width:40px;height:40px;border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        background:${color};
        border:2px solid #fff;
        color:#fff;
        font-size:18px;
        box-shadow:0 20px 40px rgba(0,0,0,.8);
      ">üõπ</div>`,
      iconSize:[40,40],
      iconAnchor:[20,20]
    });

    L.marker([row.lat,row.lng],{icon}).addTo(map);
  }
}

loadSpot();
</script>

<script>
  // Enregistre le service worker pour l‚Äôapp
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }

  // G√®re le bouton d'installation PWA
  let deferredPrompt = null;
  const btnInstall = document.getElementById('btnInstallOuRider');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (btnInstall) btnInstall.style.display = 'inline-flex';
  });

  if (btnInstall) {
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.style.display = 'none';
    });
  }
</script>

</body>
</html>
